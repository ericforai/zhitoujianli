<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tokenä¼ é€’æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .button { padding: 10px 20px; margin: 5px; background: #007cba; color: white; border: none; border-radius: 3px; cursor: pointer; }
        .button:hover { background: #005a84; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ä¸‰å±‚è®¿é—®æƒé™æ§åˆ¶ç³»ç»Ÿ - Tokenä¼ é€’æµ‹è¯•</h1>
    
    <div class="section">
        <h2>æµ‹è¯•æ­¥éª¤</h2>
        <p>1. é¦–é¡µ (http://localhost:3000/) - å…¬å¼€è®¿é—®</p>
        <p>2. åšå®¢ (http://localhost:4321/blog/) - å…¬å¼€è®¿é—®</p>
        <p>3. åå°ç®¡ç† (http://localhost:8080/) - éœ€è¦ç™»å½•åè®¿é—®</p>
        
        <button class="button" onclick="testHomePage()">æµ‹è¯•é¦–é¡µè®¿é—®</button>
        <button class="button" onclick="testBlogPage()">æµ‹è¯•åšå®¢è®¿é—®</button>
        <button class="button" onclick="testBackendUnauth()">æµ‹è¯•æœªç™»å½•è®¿é—®åå°</button>
        <button class="button" onclick="simulateLogin()">æ¨¡æ‹Ÿç™»å½•å¹¶æµ‹è¯•</button>
    </div>
    
    <div class="section">
        <h2>å½“å‰CookieçŠ¶æ€</h2>
        <button class="button" onclick="checkCookies()">æ£€æŸ¥Cookie</button>
        <button class="button" onclick="clearCookies()">æ¸…é™¤Cookie</button>
        <div id="cookieInfo"></div>
    </div>
    
    <div class="section">
        <h2>æµ‹è¯•ç»“æœ</h2>
        <div id="testResults"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const results = document.getElementById('testResults');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            results.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
        }

        async function testHomePage() {
            clearResults();
            log('ğŸ  æµ‹è¯•é¦–é¡µè®¿é—® (http://localhost:3000/)');
            try {
                const response = await fetch('http://localhost:3000/', {
                    method: 'GET',
                    credentials: 'include'
                });
                if (response.ok) {
                    log('âœ… é¦–é¡µè®¿é—®æˆåŠŸ', 'success');
                } else {
                    log(`âŒ é¦–é¡µè®¿é—®å¤±è´¥: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                log(`âŒ é¦–é¡µè®¿é—®å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        async function testBlogPage() {
            clearResults();
            log('ğŸ“– æµ‹è¯•åšå®¢è®¿é—® (http://localhost:4321/blog/)');
            try {
                const response = await fetch('http://localhost:4321/blog/', {
                    method: 'GET',
                    credentials: 'include'
                });
                if (response.ok) {
                    log('âœ… åšå®¢è®¿é—®æˆåŠŸ', 'success');
                } else {
                    log(`âŒ åšå®¢è®¿é—®å¤±è´¥: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                log(`âŒ åšå®¢è®¿é—®å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        async function testBackendUnauth() {
            clearResults();
            log('ğŸ”’ æµ‹è¯•æœªç™»å½•è®¿é—®åå°ç®¡ç† (http://localhost:8080/)');
            try {
                const response = await fetch('http://localhost:8080/', {
                    method: 'GET',
                    credentials: 'include',
                    redirect: 'manual'
                });
                
                if (response.status === 302 || response.status === 0) {
                    const location = response.headers.get('Location');
                    log(`âœ… æœªç™»å½•è®¿é—®åå°ç®¡ç†è¢«æ­£ç¡®é‡å®šå‘: ${location || 'é‡å®šå‘åˆ°ç™»å½•é¡µé¢'}`, 'success');
                } else if (response.ok) {
                    log('âŒ æœªç™»å½•å´èƒ½è®¿é—®åå°ç®¡ç†ï¼Œæƒé™æ§åˆ¶å¤±æ•ˆ', 'error');
                } else {
                    log(`âš ï¸ æœªç™»å½•è®¿é—®åå°ç®¡ç†è¿”å›çŠ¶æ€: ${response.status}`, 'info');
                }
            } catch (error) {
                log(`âŒ æµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        function simulateLogin() {
            clearResults();
            log('ğŸ” æ¨¡æ‹Ÿç™»å½•æµç¨‹...');
            
            // æ¨¡æ‹ŸToken
            const mockToken = 'mock_jwt_token_' + Date.now();
            
            // è®¾ç½®localStorageï¼ˆæ¨¡æ‹Ÿå‰ç«¯ç™»å½•æˆåŠŸï¼‰
            localStorage.setItem('token', mockToken);
            localStorage.setItem('authToken', mockToken);
            
            // è®¾ç½®Cookieï¼ˆå…³é”®ï¼šè·¨åŸŸTokenä¼ é€’ï¼‰
            document.cookie = `authToken=${mockToken}; path=/; domain=localhost; secure=false; SameSite=Lax`;
            
            log('âœ… æ¨¡æ‹Ÿç™»å½•æˆåŠŸï¼Œå·²è®¾ç½®Tokenåˆ°localStorageå’ŒCookie', 'success');
            log(`ğŸ“ Token: ${mockToken}`, 'info');
            
            // ç­‰å¾…1ç§’åæµ‹è¯•åå°è®¿é—®
            setTimeout(testBackendWithAuth, 1000);
        }

        async function testBackendWithAuth() {
            log('ğŸ” æµ‹è¯•ç™»å½•åè®¿é—®åå°ç®¡ç†...');
            try {
                const response = await fetch('http://localhost:8080/', {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                if (response.ok) {
                    log('âœ… ç™»å½•åæˆåŠŸè®¿é—®åå°ç®¡ç†', 'success');
                    const html = await response.text();
                    if (html.includes('æ™ºæŠ•ç®€å†') || html.includes('åå°ç®¡ç†')) {
                        log('âœ… åå°ç®¡ç†é¡µé¢å†…å®¹æ­£ç¡®', 'success');
                    } else {
                        log('âš ï¸ åå°ç®¡ç†é¡µé¢å†…å®¹å¯èƒ½ä¸æ­£ç¡®', 'info');
                    }
                } else if (response.status === 302) {
                    log('âŒ ç™»å½•åä»è¢«é‡å®šå‘ï¼ŒTokenä¼ é€’å¯èƒ½æœ‰é—®é¢˜', 'error');
                } else {
                    log(`âŒ ç™»å½•åè®¿é—®å¤±è´¥: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                log(`âŒ æµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        function checkCookies() {
            const cookieInfo = document.getElementById('cookieInfo');
            const cookies = document.cookie;
            const authToken = getCookie('authToken');
            
            cookieInfo.innerHTML = `
                <h3>Cookieä¿¡æ¯:</h3>
                <pre>æ‰€æœ‰Cookie: ${cookies || 'æ— Cookie'}</pre>
                <pre>authToken: ${authToken || 'æœªè®¾ç½®'}</pre>
                <pre>localStorage token: ${localStorage.getItem('token') || 'æœªè®¾ç½®'}</pre>
                <pre>localStorage authToken: ${localStorage.getItem('authToken') || 'æœªè®¾ç½®'}</pre>
            `;
        }

        function clearCookies() {
            // æ¸…é™¤Cookie
            document.cookie = 'authToken=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=localhost;';
            
            // æ¸…é™¤localStorage
            localStorage.removeItem('token');
            localStorage.removeItem('authToken');
            localStorage.removeItem('user');
            
            log('ğŸ§¹ å·²æ¸…é™¤æ‰€æœ‰è®¤è¯ä¿¡æ¯', 'info');
            checkCookies();
        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥CookieçŠ¶æ€
        window.onload = function() {
            checkCookies();
        };
    </script>
</body>
</html>