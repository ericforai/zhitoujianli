<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex" />
    <title>智投简历博客 - 内容管理（需要管理员权限）</title>
    <!-- Authing 认证 SDK -->
    <script src="https://cdn.authing.co/packages/authing-js-sdk/5.1.1/index.global.js"></script>
    <!-- 用户认证样式 -->
    <style>
      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        background: #f5f5f5;
      }
      .auth-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      .auth-card {
        background: white;
        padding: 40px;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        text-align: center;
        max-width: 400px;
        width: 90%;
      }
      .auth-title {
        font-size: 24px;
        font-weight: 600;
        color: #333;
        margin-bottom: 10px;
      }
      .auth-subtitle {
        color: #666;
        margin-bottom: 30px;
        font-size: 14px;
      }
      .login-btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
        transition: background 0.3s;
        width: 100%;
      }
      .login-btn:hover {
        background: #5a67d8;
      }
      .loading {
        color: #666;
        font-size: 14px;
        margin-top: 20px;
      }
      .error {
        color: #e53e3e;
        font-size: 14px;
        margin-top: 10px;
        padding: 10px;
        background: #fed7d7;
        border-radius: 6px;
      }
      .success {
        color: #38a169;
        font-size: 14px;
        margin-top: 10px;
      }
      #cms-container {
        display: none;
      }
    </style>
  </head>
  <body>
    <!-- 认证界面 -->
    <div id="auth-container" class="auth-container">
      <div class="auth-card">
        <div class="auth-title">📝 智投简历博客</div>
        <div class="auth-subtitle">内容管理系统 - 仅限管理员访问</div>
        <button id="loginBtn" class="login-btn">登录认证</button>
        <div id="loading" class="loading" style="display: none;">正在验证身份...</div>
        <div id="error" class="error" style="display: none;"></div>
        <div id="success" class="success" style="display: none;"></div>
      </div>
    </div>
    
    <!-- CMS 主体内容 -->
    <div id="cms-container">
      <!-- Decap CMS 将在这里加载 -->
    </div>

    <!-- GitHub 认证 -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <!-- Decap CMS 核心脚本 -->
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    
    <script>
      // 配置信息
      const AUTH_CONFIG = {
        domain: 'https://zhitoujianli.authing.cn',
        appId: '68db6e4e85de9cb8daf2b3d2',
        redirectUri: window.location.origin + '/blog/admin/',
        // 管理员用户ID列表（实际部署时应该通过API获取）
        adminUsers: ['68dba0e3d9c27ebb0d93aa42'] // 超级管理员ID
      };

      // 初始化Authing
      let authingClient;
      
      async function initAuth() {
        try {
          if (!window.Authing) {
            throw new Error('Authing SDK 加载失败');
          }
          
          authingClient = new window.Authing.AuthenticationClient({
            appId: AUTH_CONFIG.appId,
            appHost: AUTH_CONFIG.domain,
            redirectUri: AUTH_CONFIG.redirectUri,
            scope: 'openid profile email'
          });
          
          // 检查是否已登录
          await checkAuthStatus();
        } catch (error) {
          console.error('初始化认证失败:', error);
          showError('认证系统初始化失败，请刷新页面重试');
        }
      }

      async function checkAuthStatus() {
        try {
          // 检查是否有存储的token
          const token = localStorage.getItem('authing_token');
          if (token) {
            const userInfo = await authingClient.getCurrentUser();
            if (userInfo && userInfo.sub) {
              await validateAdminAccess(userInfo);
              return;
            }
          }
          
          // 检查URL中是否有授权码
          const urlParams = new URLSearchParams(window.location.search);
          const code = urlParams.get('code');
          if (code) {
            await handleAuthCallback(code);
          }
        } catch (error) {
          console.error('检查认证状态失败:', error);
        }
      }

      async function handleAuthCallback(code) {
        try {
          showLoading('正在处理登录...');
          
          const tokenSet = await authingClient.getAccessTokenByCode(code);
          if (tokenSet.access_token) {
            localStorage.setItem('authing_token', tokenSet.access_token);
            
            const userInfo = await authingClient.getCurrentUser(tokenSet.access_token);
            await validateAdminAccess(userInfo);
          }
        } catch (error) {
          console.error('处理登录回调失败:', error);
          showError('登录失败，请重试');
        }
      }

      async function validateAdminAccess(userInfo) {
        try {
          // 首先检查后端管理员权限
          const response = await fetch('http://localhost:8080/api/admin/check-blog-access', {
            method: 'GET',
            credentials: 'include',
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('authing_token')}`,
              'Content-Type': 'application/json'
            }
          });
          
          if (response.ok) {
            const result = await response.json();
            if (result.success && result.hasAccess) {
              showSuccess(`欢迎，${userInfo.name || userInfo.username || '管理员'}！正在加载博客管理系统...`);
              setTimeout(() => {
                initCMS();
              }, 1000);
              return;
            } else {
              showError(result.message || '您没有访问博客管理后台的权限');
              return;
            }
          }
          
          // 如果后端 API 不可用，回退到前端检查
          const isAdmin = AUTH_CONFIG.adminUsers.includes(userInfo.sub);
          
          if (isAdmin) {
            showSuccess(`欢迎，${userInfo.name || userInfo.username || '管理员'}！（前端模式）`);
            setTimeout(() => {
              initCMS();
            }, 1000);
          } else {
            showError('您没有访问博客管理后台的权限');
          }
        } catch (error) {
          console.error('验证管理员权限失败:', error);
          // 网络错误时回退到前端检查
          const isAdmin = AUTH_CONFIG.adminUsers.includes(userInfo.sub);
          if (isAdmin) {
            showSuccess(`欢迎，${userInfo.name || userInfo.username || '管理员'}！（连接后端失败，前端模式）`);
            setTimeout(() => {
              initCMS();
            }, 1000);
          } else {
            showError('权限验证失败，无法访问管理后台');
          }
        }
      }

      function initCMS() {
        // 隐藏认证界面，显示CMS
        document.getElementById('auth-container').style.display = 'none';
        document.getElementById('cms-container').style.display = 'block';
        
        // 初始化Decap CMS
        window.CMS.init();
      }

      // 登录按钮事件
      document.getElementById('loginBtn').addEventListener('click', async () => {
        try {
          showLoading('正在跳转到登录页面...');
          
          const loginUrl = authingClient.buildAuthorizeUrl({
            responseType: 'code',
            scope: 'openid profile email'
          });
          
          window.location.href = loginUrl;
        } catch (error) {
          console.error('登录失败:', error);
          showError('登录跳转失败，请重试');
        }
      });

      // UI 辅助函数
      function showLoading(message = '加载中...') {
        document.getElementById('loading').textContent = message;
        document.getElementById('loading').style.display = 'block';
        document.getElementById('error').style.display = 'none';
        document.getElementById('success').style.display = 'none';
      }

      function showError(message) {
        document.getElementById('error').textContent = message;
        document.getElementById('error').style.display = 'block';
        document.getElementById('loading').style.display = 'none';
        document.getElementById('success').style.display = 'none';
      }

      function showSuccess(message) {
        document.getElementById('success').textContent = message;
        document.getElementById('success').style.display = 'block';
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'none';
      }

      function hideMessages() {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'none';
        document.getElementById('success').style.display = 'none';
      }

      // 初始化
      document.addEventListener('DOMContentLoaded', () => {
        initAuth();
      });
    </script>
  </body>
</html>