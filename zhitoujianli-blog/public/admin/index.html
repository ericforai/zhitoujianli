<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex" />
    <title>æ™ºæŠ•ç®€å†åšå®¢ - å†…å®¹ç®¡ç†ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰</title>
    <!-- Authing è®¤è¯ SDK -->
    <script src="https://cdn.authing.co/packages/authing-js-sdk/5.1.1/index.global.js"></script>
    <!-- ç”¨æˆ·è®¤è¯æ ·å¼ -->
    <style>
      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        background: #f5f5f5;
      }
      .auth-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      .auth-card {
        background: white;
        padding: 40px;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        text-align: center;
        max-width: 400px;
        width: 90%;
      }
      .auth-title {
        font-size: 24px;
        font-weight: 600;
        color: #333;
        margin-bottom: 10px;
      }
      .auth-subtitle {
        color: #666;
        margin-bottom: 30px;
        font-size: 14px;
      }
      .login-btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
        transition: background 0.3s;
        width: 100%;
      }
      .login-btn:hover {
        background: #5a67d8;
      }
      .loading {
        color: #666;
        font-size: 14px;
        margin-top: 20px;
      }
      .error {
        color: #e53e3e;
        font-size: 14px;
        margin-top: 10px;
        padding: 10px;
        background: #fed7d7;
        border-radius: 6px;
      }
      .success {
        color: #38a169;
        font-size: 14px;
        margin-top: 10px;
      }
      #cms-container {
        display: none;
      }
    </style>
  </head>
  <body>
    <!-- è®¤è¯ç•Œé¢ -->
    <div id="auth-container" class="auth-container">
      <div class="auth-card">
        <div class="auth-title">ğŸ“ æ™ºæŠ•ç®€å†åšå®¢</div>
        <div class="auth-subtitle">å†…å®¹ç®¡ç†ç³»ç»Ÿ - ä»…é™ç®¡ç†å‘˜è®¿é—®</div>
        <button id="loginBtn" class="login-btn">ç™»å½•è®¤è¯</button>
        <div id="loading" class="loading" style="display: none;">æ­£åœ¨éªŒè¯èº«ä»½...</div>
        <div id="error" class="error" style="display: none;"></div>
        <div id="success" class="success" style="display: none;"></div>
      </div>
    </div>
    
    <!-- CMS ä¸»ä½“å†…å®¹ -->
    <div id="cms-container">
      <!-- Decap CMS å°†åœ¨è¿™é‡ŒåŠ è½½ -->
    </div>

    <!-- GitHub è®¤è¯ -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <!-- Decap CMS æ ¸å¿ƒè„šæœ¬ -->
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    
    <script>
      // é…ç½®ä¿¡æ¯
      const AUTH_CONFIG = {
        domain: 'https://zhitoujianli.authing.cn',
        appId: '68db6e4e85de9cb8daf2b3d2',
        redirectUri: window.location.origin + '/blog/admin/',
        // ç®¡ç†å‘˜ç”¨æˆ·IDåˆ—è¡¨ï¼ˆå®é™…éƒ¨ç½²æ—¶åº”è¯¥é€šè¿‡APIè·å–ï¼‰
        adminUsers: ['68dba0e3d9c27ebb0d93aa42'] // è¶…çº§ç®¡ç†å‘˜ID
      };

      // åˆå§‹åŒ–Authing
      let authingClient;
      
      async function initAuth() {
        try {
          if (!window.Authing) {
            throw new Error('Authing SDK åŠ è½½å¤±è´¥');
          }
          
          authingClient = new window.Authing.AuthenticationClient({
            appId: AUTH_CONFIG.appId,
            appHost: AUTH_CONFIG.domain,
            redirectUri: AUTH_CONFIG.redirectUri,
            scope: 'openid profile email'
          });
          
          // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
          await checkAuthStatus();
        } catch (error) {
          console.error('åˆå§‹åŒ–è®¤è¯å¤±è´¥:', error);
          showError('è®¤è¯ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        }
      }

      async function checkAuthStatus() {
        try {
          // æ£€æŸ¥æ˜¯å¦æœ‰å­˜å‚¨çš„token
          const token = localStorage.getItem('authing_token');
          if (token) {
            const userInfo = await authingClient.getCurrentUser();
            if (userInfo && userInfo.sub) {
              await validateAdminAccess(userInfo);
              return;
            }
          }
          
          // æ£€æŸ¥URLä¸­æ˜¯å¦æœ‰æˆæƒç 
          const urlParams = new URLSearchParams(window.location.search);
          const code = urlParams.get('code');
          if (code) {
            await handleAuthCallback(code);
          }
        } catch (error) {
          console.error('æ£€æŸ¥è®¤è¯çŠ¶æ€å¤±è´¥:', error);
        }
      }

      async function handleAuthCallback(code) {
        try {
          showLoading('æ­£åœ¨å¤„ç†ç™»å½•...');
          
          const tokenSet = await authingClient.getAccessTokenByCode(code);
          if (tokenSet.access_token) {
            localStorage.setItem('authing_token', tokenSet.access_token);
            
            const userInfo = await authingClient.getCurrentUser(tokenSet.access_token);
            await validateAdminAccess(userInfo);
          }
        } catch (error) {
          console.error('å¤„ç†ç™»å½•å›è°ƒå¤±è´¥:', error);
          showError('ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
      }

      async function validateAdminAccess(userInfo) {
        try {
          // é¦–å…ˆæ£€æŸ¥åç«¯ç®¡ç†å‘˜æƒé™
          const response = await fetch('http://localhost:8080/api/admin/check-blog-access', {
            method: 'GET',
            credentials: 'include',
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('authing_token')}`,
              'Content-Type': 'application/json'
            }
          });
          
          if (response.ok) {
            const result = await response.json();
            if (result.success && result.hasAccess) {
              showSuccess(`æ¬¢è¿ï¼Œ${userInfo.name || userInfo.username || 'ç®¡ç†å‘˜'}ï¼æ­£åœ¨åŠ è½½åšå®¢ç®¡ç†ç³»ç»Ÿ...`);
              setTimeout(() => {
                initCMS();
              }, 1000);
              return;
            } else {
              showError(result.message || 'æ‚¨æ²¡æœ‰è®¿é—®åšå®¢ç®¡ç†åå°çš„æƒé™');
              return;
            }
          }
          
          // å¦‚æœåç«¯ API ä¸å¯ç”¨ï¼Œå›é€€åˆ°å‰ç«¯æ£€æŸ¥
          const isAdmin = AUTH_CONFIG.adminUsers.includes(userInfo.sub);
          
          if (isAdmin) {
            showSuccess(`æ¬¢è¿ï¼Œ${userInfo.name || userInfo.username || 'ç®¡ç†å‘˜'}ï¼ï¼ˆå‰ç«¯æ¨¡å¼ï¼‰`);
            setTimeout(() => {
              initCMS();
            }, 1000);
          } else {
            showError('æ‚¨æ²¡æœ‰è®¿é—®åšå®¢ç®¡ç†åå°çš„æƒé™');
          }
        } catch (error) {
          console.error('éªŒè¯ç®¡ç†å‘˜æƒé™å¤±è´¥:', error);
          // ç½‘ç»œé”™è¯¯æ—¶å›é€€åˆ°å‰ç«¯æ£€æŸ¥
          const isAdmin = AUTH_CONFIG.adminUsers.includes(userInfo.sub);
          if (isAdmin) {
            showSuccess(`æ¬¢è¿ï¼Œ${userInfo.name || userInfo.username || 'ç®¡ç†å‘˜'}ï¼ï¼ˆè¿æ¥åç«¯å¤±è´¥ï¼Œå‰ç«¯æ¨¡å¼ï¼‰`);
            setTimeout(() => {
              initCMS();
            }, 1000);
          } else {
            showError('æƒé™éªŒè¯å¤±è´¥ï¼Œæ— æ³•è®¿é—®ç®¡ç†åå°');
          }
        }
      }

      function initCMS() {
        // éšè—è®¤è¯ç•Œé¢ï¼Œæ˜¾ç¤ºCMS
        document.getElementById('auth-container').style.display = 'none';
        document.getElementById('cms-container').style.display = 'block';
        
        // åˆå§‹åŒ–Decap CMS
        window.CMS.init();
      }

      // ç™»å½•æŒ‰é’®äº‹ä»¶
      document.getElementById('loginBtn').addEventListener('click', async () => {
        try {
          showLoading('æ­£åœ¨è·³è½¬åˆ°ç™»å½•é¡µé¢...');
          
          const loginUrl = authingClient.buildAuthorizeUrl({
            responseType: 'code',
            scope: 'openid profile email'
          });
          
          window.location.href = loginUrl;
        } catch (error) {
          console.error('ç™»å½•å¤±è´¥:', error);
          showError('ç™»å½•è·³è½¬å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
      });

      // UI è¾…åŠ©å‡½æ•°
      function showLoading(message = 'åŠ è½½ä¸­...') {
        document.getElementById('loading').textContent = message;
        document.getElementById('loading').style.display = 'block';
        document.getElementById('error').style.display = 'none';
        document.getElementById('success').style.display = 'none';
      }

      function showError(message) {
        document.getElementById('error').textContent = message;
        document.getElementById('error').style.display = 'block';
        document.getElementById('loading').style.display = 'none';
        document.getElementById('success').style.display = 'none';
      }

      function showSuccess(message) {
        document.getElementById('success').textContent = message;
        document.getElementById('success').style.display = 'block';
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'none';
      }

      function hideMessages() {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'none';
        document.getElementById('success').style.display = 'none';
      }

      // åˆå§‹åŒ–
      document.addEventListener('DOMContentLoaded', () => {
        initAuth();
      });
    </script>
  </body>
</html>