---
export interface Props {
  title: string;
  url: string;
  description?: string;
}

const { title, url, description = '' } = Astro.props;
---

<div class="mx-auto px-6 sm:px-6 max-w-3xl mt-12 mb-8">
  <!-- åˆ†äº«æŒ‰é’®åŒºåŸŸ -->
  <div class="text-center border-t border-gray-200 pt-8">
    <p class="text-gray-600 dark:text-gray-400 mb-4 text-lg font-medium">è§‰å¾—æœ‰ç”¨ï¼Ÿåˆ†äº«ç»™æœ‹å‹å§ï¼</p>
    <div class="share-buttons-container">
      <button
        type="button"
        id="wechat-share-btn"
        class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 cursor-pointer transition transform hover:scale-105 shadow-md"
      >
        <span class="flex items-center space-x-2">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
            <path d="M8.691 2.188C3.891 2.188 0 5.476 0 9.53c0 2.212 1.17 4.203 3.002 5.55a.59.59 0 0 1 .213.665l-.39 1.402c-.019.07-.048.141-.048.213 0 .163.13.295.29.295a.326.326 0 0 0 .167-.054l1.903-1.114a.864.864 0 0 1 .717-.098 10.16 10.16 0 0 0 2.837.403c.276 0 .543-.027.811-.05-.857-2.578.157-5.523 3.317-6.523 1.961-.623 3.976-.314 5.364.737.205-4.272-3.508-7.768-8.492-7.768zm-.357 4.363a.68.68 0 0 1 .679-.678.68.68 0 0 1 .679.678.68.68 0 0 1-.679.679.68.68 0 0 1-.679-.679zm-4.679 0a.68.68 0 0 1 .679-.678.68.68 0 0 1 .679.678.68.68 0 0 1-.679.679.68.68 0 0 1-.679-.679z"/>
            <path d="M16.97 8.53c-3.47 0-6.28 2.38-6.28 5.32 0 2.93 2.81 5.31 6.28 5.31.74 0 1.45-.13 2.11-.35.21-.07.43-.02.6.05l1.43.84c.03.02.07.03.11.03.1 0 .18-.08.18-.18 0-.04-.01-.09-.03-.13l-.29-1.05c-.05-.16.01-.33.13-.42 1.37-1.01 2.25-2.5 2.25-4.1 0-2.94-2.81-5.32-6.29-5.32zm-3.67 3.96a.51.51 0 0 1 .51-.51.51.51 0 0 1 .51.51.51.51 0 0 1-.51.51.51.51 0 0 1-.51-.51zm4.69 0a.51.51 0 0 1 .51-.51.51.51 0 0 1 .51.51.51.51 0 0 1-.51.51.51.51 0 0 1-.51-.51z"/>
          </svg>
          <span>åˆ†äº«åˆ°å¾®ä¿¡</span>
        </span>
      </button>
      <button
        type="button"
        id="weibo-share-btn"
        class="bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 cursor-pointer transition transform hover:scale-105 shadow-md"
      >
        <span class="flex items-center space-x-2">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
            <path d="M9.935 14.633c-1.073 1.51-3.43 2.08-5.246 1.267-1.816-.812-2.138-2.648-1.065-4.157 1.074-1.51 3.431-2.08 5.247-1.268 1.815.813 2.137 2.649 1.064 4.158zm10.827-4.657c-.345-.117-.582-.163-.402-.585.392-.919.432-1.711.006-2.277-.798-.974-2.977-.922-5.478.137 0 0-.785.346-.584-.283.384-1.25.325-2.295-.269-2.901-1.345-1.372-4.925.052-8.002 3.18C3.184 9.848 2 12.068 2 14.001c0 3.677 4.706 5.911 9.31 5.911 6.035 0 10.055-3.505 10.055-6.291 0-1.687-1.421-2.641-2.603-3.045zM9.669 18.517c-3.088.302-5.755-1.094-5.962-3.117-.206-2.024 2.145-3.89 5.233-4.193 3.088-.302 5.756 1.094 5.962 3.118.206 2.023-2.145 3.89-5.233 4.192zm12.237-8.424c-.732-2.286-2.724-3.661-4.828-3.366l-.014.003c-.242.053-.392.291-.334.533.058.242.296.392.538.338 1.718-.24 3.372.882 3.989 2.744.618 1.863-.14 3.875-1.782 4.872-.213.129-.281.407-.151.62.129.213.407.281.62.151 2.013-1.221 2.938-3.662 2.212-5.895zM19.52 7.256c-.384-.11-.791.112-.902.496-.11.384.112.791.496.902.879.252 1.472 1.013 1.402 1.804-.07.79-.743 1.385-1.65 1.437-.384.02-.682.343-.663.725.02.383.343.682.725.663 1.43-.081 2.573-1.054 2.682-2.287.108-1.233-.773-2.42-2.09-2.74z"/>
          </svg>
          <span>åˆ†äº«åˆ°å¾®åš</span>
        </span>
      </button>
      <button
        type="button"
        id="copy-link-btn"
        class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 cursor-pointer transition transform hover:scale-105 shadow-md"
      >
        <span class="flex items-center space-x-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
          </svg>
          <span>å¤åˆ¶é“¾æ¥</span>
        </span>
      </button>
    </div>
    <p id="share-message" class="mt-4 text-sm text-green-600 dark:text-green-400" style="display:none;"></p>
  </div>
</div>

<!-- å¾®ä¿¡åˆ†äº«å¼¹çª— -->
<div id="wechat-modal" class="wechat-modal">
  <div class="wechat-modal-content">
    <button type="button" class="wechat-modal-close" id="close-wechat-modal">Ã—</button>
    <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">å¾®ä¿¡æ‰«ç åˆ†äº«</h2>
    <p class="text-gray-600 dark:text-gray-400 text-sm">ä½¿ç”¨å¾®ä¿¡æ‰«æäºŒç»´ç å³å¯åˆ†äº«</p>

    <div class="wechat-qrcode">
      <img id="wechat-qrcode-img" src="" alt="å¾®ä¿¡åˆ†äº«äºŒç»´ç " />
    </div>

    <div class="wechat-tips">
      <p>ğŸ“± æ‰“å¼€å¾®ä¿¡æ‰«ä¸€æ‰«</p>
      <p>ğŸ”— æˆ–å¤åˆ¶é“¾æ¥åœ¨å¾®ä¿¡ä¸­æ‰“å¼€</p>
    </div>

    <button type="button" class="wechat-copy-btn" id="copy-from-modal">
      ğŸ“‹ å¤åˆ¶é“¾æ¥
    </button>
  </div>
</div>

<style>
  /* åˆ†äº«æŒ‰é’®å®¹å™¨ */
  .share-buttons-container {
    display: flex;
    justify-content: center;
    gap: 1rem;
    flex-wrap: wrap;
  }

  /* å¾®ä¿¡åˆ†äº«å¼¹çª—æ ·å¼ */
  .wechat-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 9999;
    justify-content: center;
    align-items: center;
  }
  .wechat-modal.active {
    display: flex;
  }
  .wechat-modal-content {
    background: white;
    padding: 2rem;
    border-radius: 1rem;
    max-width: 400px;
    width: 90%;
    text-align: center;
    position: relative;
    animation: modalSlideIn 0.3s ease-out;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  }
  :global(.dark) .wechat-modal-content {
    background: #1f2937;
    color: white;
  }
  @keyframes modalSlideIn {
    from {
      opacity: 0;
      transform: translateY(-50px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  .wechat-modal-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    font-size: 1.5rem;
    color: #666;
    cursor: pointer;
    background: none;
    border: none;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s;
  }
  .wechat-modal-close:hover {
    background-color: #f0f0f0;
    color: #333;
  }
  .wechat-qrcode {
    margin: 1.5rem auto;
    padding: 1rem;
    background: white;
    border: 2px solid #e5e5e5;
    border-radius: 0.5rem;
    display: inline-block;
  }
  .wechat-qrcode img {
    display: block;
    width: 220px;
    height: 220px;
  }
  .wechat-tips {
    color: #666;
    font-size: 0.875rem;
    margin-top: 1rem;
    line-height: 1.8;
  }
  :global(.dark) .wechat-tips {
    color: #d1d5db;
  }
  .wechat-tips p {
    margin: 0.5rem 0;
  }
  .wechat-copy-btn {
    margin-top: 1.5rem;
    padding: 0.75rem 2rem;
    background: linear-gradient(135deg, #07c160 0%, #09ad56 100%);
    color: white;
    border: none;
    border-radius: 0.5rem;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 600;
    transition: all 0.2s;
  }
  .wechat-copy-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(7, 193, 96, 0.4);
  }
</style>

<script is:inline define:vars={{ title, url, description }}>
  (function() {
    // å­˜å‚¨äº‹ä»¶å¤„ç†å™¨å¼•ç”¨ï¼Œä»¥ä¾¿åç»­ç§»é™¤
    let eventHandlers = {
      wechatClick: null,
      closeClick: null,
      modalClick: null,
      weiboClick: null,
      copyClick: null,
      copyFromModalClick: null,
      keydown: null
    };

    // ç¡®ä¿DOMå·²åŠ è½½
    function initShareButtons() {
      // å…ˆæ¸…ç†æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      cleanupEventListeners();

      // è·å–æœ€æ–°çš„é¡µé¢ä¿¡æ¯ï¼ˆä¼˜å…ˆä½¿ç”¨ä¼ å…¥çš„propsï¼Œå¦åˆ™ä»DOMè·å–ï¼‰
      const pageTitle = title || document.title;
      const pageUrl = url || window.location.href;
      const pageDesc = description || '';

      // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
      function showMessage(message, duration = 3000) {
        const messageEl = document.getElementById('share-message');
        if (messageEl) {
          messageEl.textContent = message;
          messageEl.style.display = 'block';
          setTimeout(() => {
            messageEl.style.display = 'none';
          }, duration);
        }
      }

      // ç”Ÿæˆå¸¦logoçš„äºŒç»´ç 
      function generateQRCodeWithLogo(url) {
        const qrcodeImg = document.getElementById('wechat-qrcode-img');
        if (!qrcodeImg) return;

        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 220;
        canvas.height = 220;

        // å…ˆåŠ è½½äºŒç»´ç 
        const qrImg = new Image();
        qrImg.crossOrigin = 'anonymous';
        qrImg.onload = function() {
          // ç»˜åˆ¶äºŒç»´ç 
          ctx.drawImage(qrImg, 0, 0, 220, 220);

          // åŠ è½½logo
          const logoImg = new Image();
          logoImg.crossOrigin = 'anonymous';
          logoImg.onload = function() {
            // è®¡ç®—logoä½ç½®ï¼ˆä¸­å¿ƒï¼‰
            const logoSize = 45;
            const x = (220 - logoSize) / 2;
            const y = (220 - logoSize) / 2;

            // ç»˜åˆ¶ç™½è‰²èƒŒæ™¯ï¼ˆè®©logoæ›´æ¸…æ™°ï¼‰
            ctx.fillStyle = 'white';
            ctx.fillRect(x - 3, y - 3, logoSize + 6, logoSize + 6);

            // ç»˜åˆ¶logo
            ctx.drawImage(logoImg, x, y, logoSize, logoSize);

            // å°†canvasè½¬ä¸ºå›¾ç‰‡
            qrcodeImg.src = canvas.toDataURL();
          };
          logoImg.onerror = function() {
            // logoåŠ è½½å¤±è´¥ï¼Œåªæ˜¾ç¤ºäºŒç»´ç 
            qrcodeImg.src = canvas.toDataURL();
          };
          logoImg.src = '/images/logo.png';
        };
        qrImg.onerror = function() {
          // äºŒç»´ç åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
          qrcodeImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=${encodeURIComponent(url)}`;
        };
        qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=${encodeURIComponent(url)}`;
      }

      // å…³é—­å¾®ä¿¡å¼¹çª—
      function closeWechatModal() {
        const modal = document.getElementById('wechat-modal');
        if (modal) {
          modal.classList.remove('active');
          document.body.style.overflow = 'auto';
        }
      }

      // åˆ†äº«åˆ°å¾®ä¿¡
      const wechatBtn = document.getElementById('wechat-share-btn');
      if (wechatBtn) {
        eventHandlers.wechatClick = function(e) {
          e.preventDefault();
          e.stopPropagation();
          // å¦‚æœæ˜¯å¾®ä¿¡æµè§ˆå™¨å†…ï¼Œæç¤ºä½¿ç”¨åŸç”Ÿåˆ†äº«
          if (navigator.userAgent.toLowerCase().indexOf('micromessenger') > -1) {
            showMessage('è¯·ç‚¹å‡»å³ä¸Šè§’"..."æŒ‰é’®åˆ†äº«ç»™æœ‹å‹');
            return;
          }

          const modal = document.getElementById('wechat-modal');
          if (modal) {
            generateQRCodeWithLogo(pageUrl);
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
          }
        };
        wechatBtn.addEventListener('click', eventHandlers.wechatClick);
      }

      const closeBtn = document.getElementById('close-wechat-modal');
      if (closeBtn) {
        eventHandlers.closeClick = closeWechatModal;
        closeBtn.addEventListener('click', eventHandlers.closeClick);
      }

      // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
      const modal = document.getElementById('wechat-modal');
      if (modal) {
        eventHandlers.modalClick = function(e) {
          if (e.target === modal) {
            closeWechatModal();
          }
        };
        modal.addEventListener('click', eventHandlers.modalClick);
      }

      // åˆ†äº«åˆ°å¾®åš
      const weiboBtn = document.getElementById('weibo-share-btn');
      if (weiboBtn) {
        eventHandlers.weiboClick = function(e) {
          e.preventDefault();
          e.stopPropagation();
          const weiboUrl = `https://service.weibo.com/share/share.php?url=${encodeURIComponent(pageUrl)}&title=${encodeURIComponent(pageTitle + (pageDesc ? ' - ' + pageDesc : ''))}`;
          window.open(weiboUrl, '_blank', 'width=600,height=400');
          showMessage('æ­£åœ¨æ‰“å¼€å¾®åšåˆ†äº«...');
        };
        weiboBtn.addEventListener('click', eventHandlers.weiboClick);
      }

      // å¤åˆ¶é“¾æ¥
      function copyLink() {
        if (navigator.clipboard && window.isSecureContext) {
          navigator.clipboard.writeText(pageUrl).then(() => {
            showMessage('âœ“ é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
          }).catch(() => {
            fallbackCopyLink();
          });
        } else {
          fallbackCopyLink();
        }
      }

      function fallbackCopyLink() {
        const input = document.createElement('input');
        input.value = pageUrl;
        input.style.position = 'fixed';
        input.style.opacity = '0';
        input.style.left = '-9999px';
        document.body.appendChild(input);
        input.select();
        input.setSelectionRange(0, 99999);

        try {
          const successful = document.execCommand('copy');
          if (successful) {
            showMessage('âœ“ é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
          } else {
            showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
          }
        } catch (err) {
          showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
        } finally {
          document.body.removeChild(input);
        }
      }

      const copyBtn = document.getElementById('copy-link-btn');
      if (copyBtn) {
        eventHandlers.copyClick = function(e) {
          e.preventDefault();
          e.stopPropagation();
          copyLink();
        };
        copyBtn.addEventListener('click', eventHandlers.copyClick);
      }

      const copyFromModal = document.getElementById('copy-from-modal');
      if (copyFromModal) {
        eventHandlers.copyFromModalClick = function(e) {
          e.preventDefault();
          e.stopPropagation();
          copyLink();
          setTimeout(closeWechatModal, 1500);
        };
        copyFromModal.addEventListener('click', eventHandlers.copyFromModalClick);
      }

      // é”®ç›˜å¿«æ·é”®
      eventHandlers.keydown = function(e) {
        // ESCé”®å…³é—­å¼¹çª—
        if (e.key === 'Escape') {
          const modal = document.getElementById('wechat-modal');
          if (modal && modal.classList.contains('active')) {
            closeWechatModal();
          }
        }
      };
      document.addEventListener('keydown', eventHandlers.keydown);
    }

    // æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
    function cleanupEventListeners() {
      const wechatBtn = document.getElementById('wechat-share-btn');
      const closeBtn = document.getElementById('close-wechat-modal');
      const modal = document.getElementById('wechat-modal');
      const weiboBtn = document.getElementById('weibo-share-btn');
      const copyBtn = document.getElementById('copy-link-btn');
      const copyFromModal = document.getElementById('copy-from-modal');

      if (wechatBtn && eventHandlers.wechatClick) {
        wechatBtn.removeEventListener('click', eventHandlers.wechatClick);
      }
      if (closeBtn && eventHandlers.closeClick) {
        closeBtn.removeEventListener('click', eventHandlers.closeClick);
      }
      if (modal && eventHandlers.modalClick) {
        modal.removeEventListener('click', eventHandlers.modalClick);
      }
      if (weiboBtn && eventHandlers.weiboClick) {
        weiboBtn.removeEventListener('click', eventHandlers.weiboClick);
      }
      if (copyBtn && eventHandlers.copyClick) {
        copyBtn.removeEventListener('click', eventHandlers.copyClick);
      }
      if (copyFromModal && eventHandlers.copyFromModalClick) {
        copyFromModal.removeEventListener('click', eventHandlers.copyFromModalClick);
      }
      if (eventHandlers.keydown) {
        document.removeEventListener('keydown', eventHandlers.keydown);
      }

      // âœ… ä¿®å¤ï¼šç›´æ¥é‡ç½®äº‹ä»¶å¤„ç†å™¨å¯¹è±¡çš„å±æ€§ï¼Œè€Œä¸æ˜¯é‡æ–°èµ‹å€¼æ•´ä¸ªå¯¹è±¡
      // è¿™æ ·å¯ä»¥ç¡®ä¿å¤–éƒ¨é—­åŒ…ä¸­çš„eventHandlerså¯¹è±¡è¢«æ­£ç¡®æ›´æ–°
      eventHandlers.wechatClick = null;
      eventHandlers.closeClick = null;
      eventHandlers.modalClick = null;
      eventHandlers.weiboClick = null;
      eventHandlers.copyClick = null;
      eventHandlers.copyFromModalClick = null;
      eventHandlers.keydown = null;
    }

    // åˆå§‹åŒ–å‡½æ•°
    function setupShareButtons() {
      // å¦‚æœDOMå·²åŠ è½½ï¼Œç«‹å³æ‰§è¡Œï¼›å¦åˆ™ç­‰å¾…DOMContentLoaded
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initShareButtons);
      } else {
        // DOMå·²åŠ è½½ï¼Œç«‹å³æ‰§è¡Œ
        initShareButtons();
      }
    }

    // åˆå§‹è®¾ç½®
    setupShareButtons();

    // ç›‘å¬ Astro View Transitions çš„é¡µé¢åˆ‡æ¢äº‹ä»¶
    document.addEventListener('astro:after-swap', () => {
      // é¡µé¢åˆ‡æ¢åé‡æ–°åˆå§‹åŒ–åˆ†äº«æŒ‰é’®
      initShareButtons();
    });
  })();
</script>

