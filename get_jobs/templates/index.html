<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI找工作助手 - 可视化配置</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .config-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-running {
            background-color: #28a745;
            animation: pulse 2s infinite;
        }
        .status-stopped {
            background-color: #dc3545;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .log-container {
            background: #1e1e1e;
            color: #ffffff;
            border-radius: 8px;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .keyword-tag {
            background: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin: 2px;
            display: inline-block;
        }
        .keyword-input {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 10px;
            min-height: 50px;
        }
        .nav-tabs .nav-link {
            border-radius: 8px 8px 0 0;
        }
        .nav-tabs .nav-link.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- 侧边栏 -->
            <div class="col-md-3 bg-light p-3">
                <h4 class="mb-4">
                    <i class="bi bi-robot"></i> AI找工作助手
                </h4>
                
                <!-- 程序状态 -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">程序状态</h6>
                    </div>
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-2">
                            <span class="status-indicator" id="statusIndicator"></span>
                            <span id="statusText">已停止</span>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">投递统计: </small>
                            <span id="deliveryCount" class="badge bg-primary">0</span>
                        </div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-success btn-sm" id="startBtn" onclick="startProgram()">
                                <i class="bi bi-play-fill"></i> 启动程序
                            </button>
                            <button class="btn btn-danger btn-sm" id="stopBtn" onclick="stopProgram()" disabled>
                                <i class="bi bi-stop-fill"></i> 停止程序
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 平台选择 -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">选择平台</h6>
                    </div>
                    <div class="card-body">
                        <select class="form-select form-select-sm" id="platformSelect">
                            <option value="boss.Boss">Boss直聘</option>
                            <option value="job51.Job51">前程无忧</option>
                            <option value="lagou.Lagou">拉勾网</option>
                            <option value="liepin.Liepin">猎聘网</option>
                            <option value="zhilian.ZhiLian">智联招聘</option>
                        </select>
                    </div>
                </div>

                <!-- 操作按钮 -->
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="saveConfig()">
                        <i class="bi bi-save"></i> 保存配置
                    </button>
                    <button class="btn btn-outline-secondary" onclick="loadConfig()">
                        <i class="bi bi-arrow-clockwise"></i> 重新加载
                    </button>
                </div>
            </div>

            <!-- 主内容区 -->
            <div class="col-md-9 p-3">
                <!-- 配置标签页 -->
                <ul class="nav nav-tabs" id="configTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="boss-tab" data-bs-toggle="tab" data-bs-target="#boss" type="button">
                            <i class="bi bi-briefcase"></i> Boss直聘
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="ai-tab" data-bs-toggle="tab" data-bs-target="#ai" type="button">
                            <i class="bi bi-cpu"></i> AI配置
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button">
                            <i class="bi bi-journal-text"></i> 运行日志
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="configTabContent">
                    <!-- Boss直聘配置 -->
                    <div class="tab-pane fade show active" id="boss" role="tabpanel">
                        <div class="config-section">
                            <h5><i class="bi bi-gear"></i> Boss直聘配置</h5>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">搜索关键词</label>
                                        <div class="keyword-input" id="bossKeywords" contenteditable="true" data-placeholder="输入关键词，用逗号分隔"></div>
                                        <small class="text-muted">例如：市场总监,市场营销,品牌营销</small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">工作城市</label>
                                        <select class="form-select" id="bossCityCode" multiple>
                                            <option value="全国">全国</option>
                                            <option value="北京">北京</option>
                                            <option value="上海" selected>上海</option>
                                            <option value="杭州">杭州</option>
                                            <option value="广州">广州</option>
                                            <option value="深圳">深圳</option>
                                            <option value="成都">成都</option>
                                            <option value="天津">天津</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">工作经验</label>
                                        <select class="form-select" id="bossExperience" multiple>
                                            <option value="应届毕业生">应届毕业生</option>
                                            <option value="1年以下">1年以下</option>
                                            <option value="1-3年">1-3年</option>
                                            <option value="3-5年">3-5年</option>
                                            <option value="5-10年">5-10年</option>
                                            <option value="10年以上" selected>10年以上</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">薪资要求</label>
                                        <select class="form-select" id="bossSalary">
                                            <option value="3K以下">3K以下</option>
                                            <option value="3-5K">3-5K</option>
                                            <option value="5-10K">5-10K</option>
                                            <option value="10-20K">10-20K</option>
                                            <option value="20-50K">20-50K</option>
                                            <option value="30K以上" selected>30K以上</option>
                                            <option value="50K以上">50K以上</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">期望薪资范围 (K)</label>
                                        <div class="row">
                                            <div class="col-6">
                                                <input type="number" class="form-control" id="expectedSalaryMin" placeholder="最低" value="30">
                                            </div>
                                            <div class="col-6">
                                                <input type="number" class="form-control" id="expectedSalaryMax" placeholder="最高" value="50">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">投递间隔 (秒)</label>
                                        <input type="number" class="form-control" id="bossWaitTime" value="10" min="1" max="60">
                                    </div>

                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="filterDeadHR" checked>
                                            <label class="form-check-label" for="filterDeadHR">
                                                过滤不活跃HR
                                            </label>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="enableAI">
                                            <label class="form-check-label" for="enableAI">
                                                启用AI智能打招呼
                                            </label>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="sendImgResume">
                                            <label class="form-check-label" for="sendImgResume">
                                                发送图片简历
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">打招呼语</label>
                                <textarea class="form-control" id="bossSayHi" rows="8" placeholder="输入您的打招呼语...">您好！
我对这个岗位非常感兴趣。我简单介绍一下：过往18年的职业生涯中，我始终专注于B2B领域的市场增长与品牌构建。在泛微网络（股票代码：603039）担任网络营销总监期间，我成功主导构建了一套融合销售与营销的数字化增长体系，助力公司营收在6年内实现了从7亿到近24亿的跨越，其中市场营销部门直接贡献了超过10亿的销售额 。

我深信，我在全链路营销策略、大规模市场活动策划（年度活动报名超6万人次） 以及高效能团队管理方面的深度实践，能够为贵公司在品牌影响力提升、业务增长方面带来切实的价值。

期待有机会能与您进一步交流，探讨我如何为团队贡献力量。</textarea>
                            </div>
                        </div>
                    </div>

                    <!-- AI配置 -->
                    <div class="tab-pane fade" id="ai" role="tabpanel">
                        <div class="config-section">
                            <h5><i class="bi bi-cpu"></i> AI配置</h5>
                            
                            <!-- AI服务配置 -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h6><i class="bi bi-gear"></i> AI服务配置</h6>
                                    <div class="card">
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">AI服务类型</label>
                                                        <select class="form-select" id="aiServiceType" onchange="updateAIServiceConfig()">
                                                            <option value="ollama">Ollama本地API (推荐，免费)</option>
                                                            <option value="deepseek">DeepSeek API (性价比高)</option>
                                                            <option value="openai">OpenAI官方API</option>
                                                            <option value="custom">自定义API</option>
                                                        </select>
                                                    </div>
                                                    
                                                    <div class="mb-3">
                                                        <label class="form-label">API地址</label>
                                                        <input type="text" class="form-control" id="aiBaseUrl" placeholder="http://localhost:11434">
                                                        <small class="text-muted">Ollama: http://localhost:11434 | DeepSeek: https://api.deepseek.com | OpenAI: https://api.openai.com</small>
                                                    </div>
                                                    
                                                    <div class="mb-3">
                                                        <label class="form-label">API密钥</label>
                                                        <input type="password" class="form-control" id="aiApiKey" placeholder="sk-xxx 或 ollama">
                                                        <small class="text-muted">Ollama本地API可填写任意值，如"ollama"</small>
                                                    </div>
                                                </div>
                                                
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">模型名称</label>
                                                        <input type="text" class="form-control" id="aiModel" placeholder="qwen2:7b">
                                                        <small class="text-muted">Ollama: qwen2:7b, llama3.2:3b | DeepSeek: deepseek-chat | OpenAI: gpt-4o-mini</small>
                                                    </div>
                                                    
                                                    <div class="mb-3">
                                                        <label class="form-label">企业微信推送URL</label>
                                                        <input type="text" class="form-control" id="hookUrl" placeholder="https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxx">
                                                    </div>
                                                    
                                                    <div class="mb-3">
                                                        <label class="form-label">Bark推送URL</label>
                                                        <input type="text" class="form-control" id="barkUrl" placeholder="https://api.day.app/xxx">
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="d-flex justify-content-between">
                                                <button class="btn btn-outline-primary" onclick="testAIConnection()">
                                                    <i class="bi bi-wifi"></i> 测试连接
                                                </button>
                                                <button class="btn btn-success" onclick="saveAIConfig()">
                                                    <i class="bi bi-save"></i> 保存AI配置
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- AI内容配置 -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">个人介绍</label>
                                        <textarea class="form-control" id="aiIntroduce" rows="6" placeholder="输入您的个人介绍，用于AI生成打招呼语...">拥有18年经验的复合型增长负责人，精通B2B领域的市场营销与销售管理。核心优势在于构建"销营一体"的数字化增长体系。

具备从0到1搭建营销体系、内容生态（创作10K+文章）及高效能团队的管理经验 。不仅能策划并执行年度超6万人报名的大规模市场活动 ，也熟悉上市公司市值管理与品牌声誉管理 ，并已将AIGC成功应用于品牌推广实践。</textarea>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">AI提示词</label>
                                        <textarea class="form-control" id="aiPrompt" rows="6" placeholder="AI提示词模板...">我目前在找工作,%s,我期望的的岗位方向是【市场营销】,目前我需要投递的岗位名称是【市场总监】,这个岗位的要求是【%s】,如果这个岗位和我的期望与经历基本符合，注意是基本符合，那么请帮我写一个给HR打招呼的文本发给我，如果这个岗位和我的期望经历完全不相干，直接返回false给我，注意只要返回我需要的内容即可，不要有其他的语气助词，重点要突出我和岗位的匹配度以及我的优势，我自己写的招呼语是：【%s】,你可以参照我自己写的根据岗位情况进行适当调整</textarea>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="botIsSend">
                                    <label class="form-check-label" for="botIsSend">
                                        启用企业微信消息推送
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 运行日志 -->
                    <div class="tab-pane fade" id="logs" role="tabpanel">
                        <div class="config-section">
                            <h5><i class="bi bi-journal-text"></i> 运行日志</h5>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <button class="btn btn-outline-primary btn-sm" onclick="refreshLogs()">
                                        <i class="bi bi-arrow-clockwise"></i> 刷新日志
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="clearLogs()">
                                        <i class="bi bi-trash"></i> 清空显示
                                    </button>
                                </div>
                                <div>
                                    <small class="text-muted">自动刷新: </small>
                                    <div class="form-check form-switch d-inline-block">
                                        <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                                    </div>
                                </div>
                            </div>
                            <div class="log-container" id="logContainer">
                                <div class="text-muted">等待程序启动...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 消息提示 -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="messageToast" class="toast" role="alert">
            <div class="toast-header">
                <i class="bi bi-info-circle text-primary me-2"></i>
                <strong class="me-auto">系统消息</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastMessage">
                消息内容
            </div>
        </div>
    </div>

    <script>
        // Token同步脚本 - 将Cookie中的token同步到localStorage
        function syncTokenFromCookie() {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.split('=').map(c => c.trim());
                if (name === 'authToken' && value) {
                    localStorage.setItem('token', value);
                    console.log('✅ Token已从Cookie同步到localStorage');
                    return true;
                }
            }
            return false;
        }
        
        // 页面加载时检查token
        document.addEventListener('DOMContentLoaded', function() {
            const hasToken = syncTokenFromCookie();
            if (!hasToken) {
                // 如果没有token，跳转到首页登录
                console.log('⚠️ 未找到认证token，将跳转到首页登录');
                setTimeout(() => {
                    window.location.href = 'http://localhost:3000/login';
                }, 2000);
                document.body.innerHTML = `
                    <div style="text-align: center; padding: 50px; font-family: Arial, sans-serif;">
                        <h2>需要登录认证</h2>
                        <p>正在跳转到登录页面...</p>
                        <p><a href="http://localhost:3000/login">点击这里立即跳转</a></p>
                    </div>
                `;
            }
        });
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let autoRefreshInterval;
        let isRunning = false;

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            loadAIConfig();
            updateStatus();
            startAutoRefresh();
        });

        // 加载配置
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const result = await response.json();
                
                if (result.success) {
                    const config = result.config;
                    if (config.boss) {
                        // 填充Boss配置
                        document.getElementById('bossKeywords').textContent = config.boss.keywords ? config.boss.keywords.join(', ') : '';
                        document.getElementById('bossSayHi').value = config.boss.sayHi || '';
                        document.getElementById('bossWaitTime').value = config.boss.waitTime || 10;
                        document.getElementById('expectedSalaryMin').value = config.boss.expectedSalary ? config.boss.expectedSalary[0] : 30;
                        document.getElementById('expectedSalaryMax').value = config.boss.expectedSalary ? config.boss.expectedSalary[1] : 50;
                        document.getElementById('filterDeadHR').checked = config.boss.filterDeadHR || false;
                        document.getElementById('enableAI').checked = config.boss.enableAI || false;
                        document.getElementById('sendImgResume').checked = config.boss.sendImgResume || false;
                        
                        // 设置薪资选择
                        if (config.boss.salary) {
                            document.getElementById('bossSalary').value = config.boss.salary;
                        }
                    }
                    
                    if (config.ai) {
                        document.getElementById('aiIntroduce').value = config.ai.introduce || '';
                        document.getElementById('aiPrompt').value = config.ai.prompt || '';
                    }
                    
                    if (config.bot) {
                        document.getElementById('botIsSend').checked = config.bot.is_send || false;
                    }
                }
            } catch (error) {
                showMessage('加载配置失败: ' + error.message, 'error');
            }
        }

        // 保存配置
        async function saveConfig() {
            const config = {
                boss: {
                    debugger: false,
                    sayHi: document.getElementById('bossSayHi').value,
                    keywords: document.getElementById('bossKeywords').textContent.split(',').map(k => k.trim()).filter(k => k),
                    cityCode: Array.from(document.getElementById('bossCityCode').selectedOptions).map(o => o.value),
                    experience: Array.from(document.getElementById('bossExperience').selectedOptions).map(o => o.value),
                    jobType: "不限",
                    salary: document.getElementById('bossSalary').value,
                    degree: ["不限"],
                    scale: ["不限"],
                    stage: ["不限"],
                    expectedSalary: [
                        parseInt(document.getElementById('expectedSalaryMin').value),
                        parseInt(document.getElementById('expectedSalaryMax').value)
                    ],
                    waitTime: parseInt(document.getElementById('bossWaitTime').value),
                    filterDeadHR: document.getElementById('filterDeadHR').checked,
                    enableAI: document.getElementById('enableAI').checked,
                    sendImgResume: document.getElementById('sendImgResume').checked,
                    deadStatus: ["2周内活跃", "本月活跃", "2月内活跃", "半年前活跃"]
                },
                ai: {
                    introduce: document.getElementById('aiIntroduce').value,
                    prompt: document.getElementById('aiPrompt').value
                },
                bot: {
                    is_send: document.getElementById('botIsSend').checked
                }
            };

            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('配置保存成功', 'success');
                } else {
                    showMessage('保存失败: ' + result.message, 'error');
                }
            } catch (error) {
                showMessage('保存配置失败: ' + error.message, 'error');
            }
        }

        // 启动程序
        async function startProgram() {
            const platform = document.getElementById('platformSelect').value;
            
            try {
                const response = await fetch('/api/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ platform: platform })
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('程序启动成功', 'success');
                    isRunning = true;
                    updateStatus();
                } else {
                    showMessage('启动失败: ' + result.message, 'error');
                }
            } catch (error) {
                showMessage('启动程序失败: ' + error.message, 'error');
            }
        }

        // 停止程序
        async function stopProgram() {
            try {
                const response = await fetch('/api/stop', {
                    method: 'POST'
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('程序已停止', 'success');
                    isRunning = false;
                    updateStatus();
                } else {
                    showMessage('停止失败: ' + result.message, 'error');
                }
            } catch (error) {
                showMessage('停止程序失败: ' + error.message, 'error');
            }
        }

        // 更新状态
        async function updateStatus() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();
                
                isRunning = status.isRunning;
                const statusIndicator = document.getElementById('statusIndicator');
                const statusText = document.getElementById('statusText');
                const deliveryCount = document.getElementById('deliveryCount');
                const startBtn = document.getElementById('startBtn');
                const stopBtn = document.getElementById('stopBtn');

                if (isRunning) {
                    statusIndicator.className = 'status-indicator status-running';
                    statusText.textContent = '运行中';
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                } else {
                    statusIndicator.className = 'status-indicator status-stopped';
                    statusText.textContent = '已停止';
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                }

                deliveryCount.textContent = status.deliveryCount || 0;
                
                // 更新日志显示
                if (status.recentLogs && status.recentLogs.length > 0) {
                    const logContainer = document.getElementById('logContainer');
                    logContainer.innerHTML = status.recentLogs.map(log => 
                        `<div class="log-line">${escapeHtml(log)}</div>`
                    ).join('');
                    logContainer.scrollTop = logContainer.scrollHeight;
                }
            } catch (error) {
                console.error('更新状态失败:', error);
            }
        }

        // 刷新日志
        async function refreshLogs() {
            try {
                const response = await fetch('/api/logs?lines=100');
                const result = await response.json();
                
                if (result.success) {
                    const logContainer = document.getElementById('logContainer');
                    logContainer.innerHTML = result.logs.map(log => 
                        `<div class="log-line">${escapeHtml(log)}</div>`
                    ).join('');
                    logContainer.scrollTop = logContainer.scrollHeight;
                }
            } catch (error) {
                console.error('刷新日志失败:', error);
            }
        }

        // 清空日志显示
        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '<div class="text-muted">日志已清空</div>';
        }

        // 开始自动刷新
        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            autoRefreshInterval = setInterval(() => {
                updateStatus();
                if (document.getElementById('autoRefresh').checked) {
                    refreshLogs();
                }
            }, 3000);
        }

        // 显示消息
        function showMessage(message, type = 'info') {
            const toast = document.getElementById('messageToast');
            const toastMessage = document.getElementById('toastMessage');
            const toastHeader = toast.querySelector('.toast-header i');
            
            toastMessage.textContent = message;
            
            // 设置图标和颜色
            toastHeader.className = 'bi me-2';
            if (type === 'success') {
                toastHeader.classList.add('bi-check-circle', 'text-success');
            } else if (type === 'error') {
                toastHeader.classList.add('bi-exclamation-triangle', 'text-danger');
            } else {
                toastHeader.classList.add('bi-info-circle', 'text-primary');
            }
            
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }

        // HTML转义
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 加载AI配置
        async function loadAIConfig() {
            try {
                const response = await fetch('/api/ai-config');
                const result = await response.json();
                
                if (result.success) {
                    const config = result.config;
                    document.getElementById('aiBaseUrl').value = config.BASE_URL || '';
                    document.getElementById('aiApiKey').value = config.API_KEY || '';
                    document.getElementById('aiModel').value = config.MODEL || '';
                    document.getElementById('hookUrl').value = config.HOOK_URL || '';
                    document.getElementById('barkUrl').value = config.BARK_URL || '';
                    
                    // 根据BASE_URL自动选择服务类型
                    updateServiceTypeFromUrl(config.BASE_URL || '');
                }
            } catch (error) {
                console.error('加载AI配置失败:', error);
            }
        }

        // 根据URL自动选择服务类型
        function updateServiceTypeFromUrl(url) {
            const select = document.getElementById('aiServiceType');
            if (url.includes('localhost:11434') || url.includes('127.0.0.1:11434')) {
                select.value = 'ollama';
            } else if (url.includes('deepseek.com')) {
                select.value = 'deepseek';
            } else if (url.includes('openai.com')) {
                select.value = 'openai';
            } else {
                select.value = 'custom';
            }
        }

        // 更新AI服务配置
        function updateAIServiceConfig() {
            const serviceType = document.getElementById('aiServiceType').value;
            const baseUrlInput = document.getElementById('aiBaseUrl');
            const apiKeyInput = document.getElementById('aiApiKey');
            const modelInput = document.getElementById('aiModel');
            
            switch (serviceType) {
                case 'ollama':
                    baseUrlInput.value = 'http://localhost:11434';
                    apiKeyInput.value = 'ollama';
                    modelInput.value = 'qwen2:7b';
                    break;
                case 'deepseek':
                    baseUrlInput.value = 'https://api.deepseek.com';
                    apiKeyInput.value = '';
                    modelInput.value = 'deepseek-chat';
                    break;
                case 'openai':
                    baseUrlInput.value = 'https://api.openai.com';
                    apiKeyInput.value = '';
                    modelInput.value = 'gpt-4o-mini';
                    break;
                case 'custom':
                    baseUrlInput.value = '';
                    apiKeyInput.value = '';
                    modelInput.value = '';
                    break;
            }
        }

        // 保存AI配置
        async function saveAIConfig() {
            const config = {
                BASE_URL: document.getElementById('aiBaseUrl').value,
                API_KEY: document.getElementById('aiApiKey').value,
                MODEL: document.getElementById('aiModel').value,
                HOOK_URL: document.getElementById('hookUrl').value,
                BARK_URL: document.getElementById('barkUrl').value
            };

            try {
                const response = await fetch('/api/ai-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('AI配置保存成功', 'success');
                } else {
                    showMessage('保存失败: ' + result.message, 'error');
                }
            } catch (error) {
                showMessage('保存AI配置失败: ' + error.message, 'error');
            }
        }

        // 测试AI连接
        async function testAIConnection() {
            const baseUrl = document.getElementById('aiBaseUrl').value;
            const apiKey = document.getElementById('aiApiKey').value;
            const model = document.getElementById('aiModel').value;
            
            if (!baseUrl || !model) {
                showMessage('请先填写API地址和模型名称', 'error');
                return;
            }
            
            try {
                showMessage('正在测试AI连接...', 'info');
                
                // 构建测试请求
                const testData = {
                    model: model,
                    messages: [{"role": "user", "content": "你好"}],
                    stream: false
                };
                
                const response = await fetch(baseUrl + '/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': apiKey && apiKey !== 'ollama' ? `Bearer ${apiKey}` : ''
                    },
                    body: JSON.stringify(testData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.choices && result.choices.length > 0) {
                        showMessage('AI连接测试成功！', 'success');
                    } else {
                        showMessage('AI连接测试失败：响应格式错误', 'error');
                    }
                } else {
                    showMessage(`AI连接测试失败：HTTP ${response.status}`, 'error');
                }
            } catch (error) {
                showMessage('AI连接测试失败: ' + error.message, 'error');
            }
        }

        // 关键词输入处理
        document.getElementById('bossKeywords').addEventListener('input', function() {
            const text = this.textContent;
            const keywords = text.split(',').map(k => k.trim()).filter(k => k);
            console.log('关键词:', keywords);
        });
    </script>
</body>
</html>
