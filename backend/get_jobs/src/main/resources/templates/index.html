<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>智投简历 - 找工作更轻松</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      .config-section {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
      }
      .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
      }
      .status-running {
        background-color: #28a745;
        animation: pulse 2s infinite;
      }
      .status-stopped {
        background-color: #dc3545;
      }
      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }
      .log-container {
        background: #1e1e1e;
        color: #ffffff;
        border-radius: 8px;
        padding: 15px;
        height: 400px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 12px;
      }
      .keyword-tag {
        background: #007bff;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
        margin: 2px;
        display: inline-block;
      }
      .keyword-input {
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 10px;
        min-height: 50px;
      }
      .nav-tabs .nav-link {
        border-radius: 8px 8px 0 0;
      }
      .nav-tabs .nav-link.active {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <!-- 侧边栏 -->
        <div class="col-md-3 bg-light p-3">
          <h4 class="mb-4"><i class="bi bi-robot"></i> AI找工作助手</h4>

          <!-- 程序状态 -->
          <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h6 class="mb-0">投递状态</h6>
            </div>
            <div class="card-body">
              <div class="d-flex align-items-center mb-2">
                <span class="status-indicator" id="statusIndicator"></span>
                <span id="statusText">已停止</span>
              </div>
              <div class="mb-2">
                <small class="text-muted">投递统计: </small>
                <span id="deliveryCount" class="badge bg-primary">0</span>
              </div>
              <div class="d-grid gap-2">
                <button
                  class="btn btn-success btn-lg"
                  id="startBossTaskBtn"
                  onclick="startBossTask()"
                >
                  <i class="bi bi-play-fill"></i> 启动投递
                </button>
                <button class="btn btn-danger btn-sm" id="stopBtn" onclick="stopProgram()" disabled>
                  <i class="bi bi-stop-fill"></i> 停止投递
                </button>
              </div>
            </div>
          </div>

          <!-- 平台选择 -->
          <div class="card mb-3">
            <div class="card-header">
              <h6 class="mb-0">选择平台</h6>
            </div>
            <div class="card-body">
              <select class="form-select form-select-sm" id="platformSelect">
                <option value="boss.Boss">Boss直聘</option>
                <option value="job51.Job51">前程无忧</option>
                <option value="lagou.Lagou">拉勾网</option>
                <option value="liepin.Liepin">猎聘网</option>
                <option value="zhilian.ZhiLian">智联招聘</option>
              </select>
            </div>
          </div>

          <!-- 操作按钮 -->
          <div class="d-grid gap-2">
            <button class="btn btn-primary" onclick="saveConfig()">
              <i class="bi bi-save"></i> 保存配置
            </button>
            <button class="btn btn-outline-secondary" onclick="loadConfig()">
              <i class="bi bi-arrow-clockwise"></i> 重新加载
            </button>
          </div>
        </div>

        <!-- 主内容区 -->
        <div class="col-md-9 p-3">
          <!-- 配置标签页 -->
          <ul class="nav nav-tabs" id="configTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button
                class="nav-link active"
                id="boss-tab"
                data-bs-toggle="tab"
                data-bs-target="#boss"
                type="button"
              >
                <i class="bi bi-briefcase"></i> Boss直聘
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button
                class="nav-link"
                id="resume-tab"
                data-bs-toggle="tab"
                data-bs-target="#resume"
                type="button"
              >
                <i class="bi bi-file-earmark-person"></i> 简历管理
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button
                class="nav-link"
                id="logs-tab"
                data-bs-toggle="tab"
                data-bs-target="#logs"
                type="button"
              >
                <i class="bi bi-journal-text"></i> 运行日志
              </button>
            </li>
          </ul>

          <div class="tab-content" id="configTabContent">
            <!-- Boss直聘配置 -->
            <div class="tab-pane fade show active" id="boss" role="tabpanel">
              <div class="config-section">
                <h5><i class="bi bi-gear"></i> Boss直聘配置</h5>

                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">搜索关键词</label>
                      <div
                        class="keyword-input"
                        id="bossKeywords"
                        contenteditable="true"
                        data-placeholder="输入关键词，用逗号分隔"
                      ></div>
                      <small class="text-muted">例如：市场总监,市场营销,品牌营销</small>
                    </div>

                    <div class="mb-3">
                      <label class="form-label">工作城市</label>
                      <select class="form-select" id="bossCityCode" multiple>
                        <option value="全国">全国</option>
                        <option value="北京">北京</option>
                        <option value="上海" selected>上海</option>
                        <option value="杭州">杭州</option>
                        <option value="广州">广州</option>
                        <option value="深圳">深圳</option>
                        <option value="成都">成都</option>
                        <option value="天津">天津</option>
                      </select>
                    </div>

                    <div class="mb-3">
                      <label class="form-label">工作经验</label>
                      <select class="form-select" id="bossExperience" multiple>
                        <option value="应届毕业生">应届毕业生</option>
                        <option value="1年以下">1年以下</option>
                        <option value="1-3年">1-3年</option>
                        <option value="3-5年">3-5年</option>
                        <option value="5-10年">5-10年</option>
                        <option value="10年以上" selected>10年以上</option>
                      </select>
                    </div>

                    <div class="mb-3">
                      <label class="form-label">薪资要求</label>
                      <select class="form-select" id="bossSalary">
                        <option value="3K以下">3K以下</option>
                        <option value="3-5K">3-5K</option>
                        <option value="5-10K">5-10K</option>
                        <option value="10-20K">10-20K</option>
                        <option value="20-50K">20-50K</option>
                        <option value="30K以上" selected>30K以上</option>
                        <option value="50K以上">50K以上</option>
                      </select>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">期望薪资范围 (K)</label>
                      <div class="row">
                        <div class="col-6">
                          <input
                            type="number"
                            class="form-control"
                            id="expectedSalaryMin"
                            placeholder="最低"
                            value="30"
                          />
                        </div>
                        <div class="col-6">
                          <input
                            type="number"
                            class="form-control"
                            id="expectedSalaryMax"
                            placeholder="最高"
                            value="50"
                          />
                        </div>
                      </div>
                    </div>

                    <div class="mb-3">
                      <label class="form-label">投递间隔 (秒)</label>
                      <input
                        type="number"
                        class="form-control"
                        id="bossWaitTime"
                        value="10"
                        min="1"
                        max="60"
                      />
                    </div>

                    <div class="mb-3">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="filterDeadHR" checked />
                        <label class="form-check-label" for="filterDeadHR"> 过滤不活跃HR </label>
                      </div>
                    </div>

                    <div class="mb-3">
                      <div class="form-check">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          id="enableSmartGreeting"
                          checked
                        />
                        <label class="form-check-label" for="enableSmartGreeting">
                          <strong>启用智能打招呼语生成（基于简历+JD）</strong>
                        </label>
                        <small class="form-text text-muted d-block mt-1">
                          <i class="bi bi-info-circle"></i> 需先在"简历管理"页面上传简历
                        </small>
                      </div>
                    </div>

                    <div class="mb-3">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="sendImgResume" />
                        <label class="form-check-label" for="sendImgResume"> 发送图片简历 </label>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
            </div>

            <!-- 简历管理 -->
            <div class="tab-pane fade" id="resume" role="tabpanel">
              <div class="config-section">
                <h5><i class="bi bi-file-earmark-person"></i> 简历管理</h5>

                <!-- 简历上传区域 -->
                <div class="card border-0 shadow-sm mb-4">
                  <div class="card-body p-4">
                    <h5 class="card-title mb-4"><i class="bi bi-cloud-upload"></i> 上传简历</h5>

                    <!-- 文件上传 -->
                    <div
                      class="upload-area"
                      id="uploadArea"
                      style="
                        border: 3px dashed #dee2e6;
                        border-radius: 15px;
                        padding: 60px 40px;
                        text-align: center;
                        transition: all 0.3s ease;
                        cursor: pointer;
                        background: #f8f9fa;
                      "
                    >
                      <i class="bi bi-file-earmark-arrow-up fs-1 text-primary"></i>
                      <h4 class="mt-3">拖拽文件到此处或点击上传</h4>
                      <p class="text-muted">
                        <strong class="text-success">✅ 支持 TXT、PDF、DOC、DOCX 格式</strong><br />
                        <small>文件大小不超过 10MB | AI自动提取文本内容</small>
                      </p>
                      <input
                        type="file"
                        id="fileInput"
                        class="d-none"
                        accept=".txt,.pdf,.doc,.docx"
                      />
                    </div>

                    <!-- 文本输入 -->
                    <div class="mt-4">
                      <label for="resumeText" class="form-label fw-bold">
                        <i class="bi bi-pencil-square"></i> 或直接粘贴简历文本：
                      </label>
                      <textarea
                        class="form-control"
                        id="resumeText"
                        rows="12"
                        placeholder="请粘贴您的简历内容...&#10;&#10;建议包含：&#10;- 个人信息（姓名、职位）&#10;- 工作经历（公司、职位、年限）&#10;- 核心技能&#10;- 主要成就&#10;- 教育背景"
                      ></textarea>
                    </div>

                    <div class="mt-4 d-flex gap-3">
                      <button class="btn btn-primary btn-lg" id="parseBtn" onclick="parseResume()">
                        <i class="bi bi-cpu"></i> AI解析简历
                      </button>
                      <button
                        class="btn btn-outline-danger"
                        id="deleteBtn"
                        onclick="deleteResume()"
                        style="display: none"
                      >
                        <i class="bi bi-trash"></i> 删除简历
                      </button>
                    </div>
                  </div>
                </div>

                <!-- 解析结果展示 -->
                <div id="parseResult" style="display: none">
                  <div
                    class="candidate-card"
                    style="
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: white;
                      border-radius: 15px;
                      padding: 30px;
                      margin-bottom: 30px;
                    "
                  >
                    <h4 class="mb-3">
                      <i class="bi bi-person-check-fill"></i>
                      解析结果
                    </h4>
                    <div id="candidateInfo">
                      <!-- 候选人信息将在这里显示 -->
                    </div>
                  </div>

                </div>
              </div>
            </div>

            <!-- 运行日志 -->
            <div class="tab-pane fade" id="logs" role="tabpanel">
              <div class="config-section">
                <h5><i class="bi bi-journal-text"></i> 运行日志</h5>
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <div>
                    <button class="btn btn-outline-primary btn-sm" onclick="refreshLogs()">
                      <i class="bi bi-arrow-clockwise"></i> 刷新日志
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="clearLogs()">
                      <i class="bi bi-trash"></i> 清空显示
                    </button>
                  </div>
                  <div>
                    <small class="text-muted">自动刷新: </small>
                    <div class="form-check form-switch d-inline-block">
                      <input class="form-check-input" type="checkbox" id="autoRefresh" checked />
                    </div>
                  </div>
                </div>
                <div class="log-container" id="logContainer">
                  <div class="text-muted">等待程序启动...</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 消息提示 -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <div id="messageToast" class="toast" role="alert">
        <div class="toast-header">
          <i class="bi bi-info-circle text-primary me-2"></i>
          <strong class="me-auto">系统消息</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toastMessage">消息内容</div>
      </div>
    </div>

    <!-- 加载提示 -->
    <div
      class="loading"
      id="loading"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
      "
    >
      <div
        class="loading-content"
        style="
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          text-align: center;
          color: white;
        "
      >
        <div class="spinner-border text-light mb-3" role="status" style="width: 3rem; height: 3rem">
          <span class="visually-hidden">处理中...</span>
        </div>
        <h4 id="loadingText">AI正在处理中，请稍候...</h4>
        <p class="text-light">这可能需要10-30秒</p>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let autoRefreshInterval;
      let isRunning = false;

      // 定时器引用，用于清除
      let statusTimer = null;
      let logsTimer = null;

      /**
       * 验证Token是否有效
       */
      async function checkTokenValidity() {
        const token = localStorage.getItem('authToken') || localStorage.getItem('token');
        if (!token) {
          console.warn('⚠️ 未找到Token');
          return false;
        }

        try {
          // 直接使用fetch验证Token，避免循环依赖
          const response = await fetch('/api/config', {
            headers: {
              Authorization: `Bearer ${token}`,
              'X-Requested-With': 'XMLHttpRequest',
            },
            redirect: 'manual',
          });

          // 检查响应状态
          if (
            response.type === 'opaqueredirect' ||
            response.status === 302 ||
            response.status === 401
          ) {
            console.warn('⚠️ Token已过期');
            return false;
          }

          return response.ok;
        } catch (error) {
          console.error('❌ Token验证失败:', error);
          return false;
        }
      }

      /**
       * 清除所有定时器
       */
      function clearAllTimers() {
        if (statusTimer) {
          clearInterval(statusTimer);
          statusTimer = null;
        }
        if (logsTimer) {
          clearInterval(logsTimer);
          logsTimer = null;
        }
        console.log('✅ 已清除所有定时器');
      }

      // 通用认证请求函数
      function fetchWithAuth(url, options = {}) {
        const token = localStorage.getItem('authToken') || localStorage.getItem('token');
        if (!token) {
          console.log('🔓 未检测到认证token，使用普通请求（安全认证可能已禁用）');
          // 添加 X-Requested-With 头，确保后端识别为AJAX请求
          options.headers = options.headers || {};
          options.headers['X-Requested-With'] = 'XMLHttpRequest';
          return fetch(url, options);
        } else {
          // 如果有token，添加到请求头
          options.headers = options.headers || {};
          options.headers['Authorization'] = `Bearer ${token}`;
          options.headers['X-Requested-With'] = 'XMLHttpRequest';
          return fetch(url, options);
        }

        // 🔧 关键修复：阻止自动跟随重定向
        options.redirect = 'manual';

        return fetch(url, options).then(response => {
          // 现在可以正确检测到302了
          if (response.type === 'opaqueredirect' || response.status === 0) {
            console.warn('⚠️ 检测到302重定向，token可能已过期');
            localStorage.removeItem('authToken');
            clearAllTimers(); // 清除定时器
            window.location.href = 'https://zhitoujianli.com/login';
            throw new Error('登录已过期');
          }

          // 处理401未授权
          if (response.status === 401) {
            console.warn('⚠️ 401未授权，token已过期');
            localStorage.removeItem('authToken');
            clearAllTimers(); // 清除定时器
            window.location.href = 'https://zhitoujianli.com/login';
            throw new Error('登录已过期');
          }

          // 处理非JSON响应
          const contentType = response.headers.get('content-type');
          if (!contentType || !contentType.includes('application/json')) {
            console.error('非JSON响应，Content-Type:', contentType);
            throw new Error('服务器返回了非JSON响应');
          }

          return response;
        });
      }

      // 检查登录状态
      function checkLoginStatus() {
        const token = localStorage.getItem('authToken');
        if (!token) {
          window.location.href = 'https://zhitoujianli.com/login';
          return false;
        }
        return true;
      }

      // 页面加载完成后初始化 - 已删除，使用下面的async版本

      // 加载配置
      async function loadConfig() {
        try {
          const response = await fetchWithAuth('/api/config');
          const result = await response.json();

          if (result.success && result.config) {
            // 将配置数据填充到表单中
            const config = result.config;

            // Boss直聘配置
            if (config.boss) {
              // 加载关键词
              if (config.boss.keywords && Array.isArray(config.boss.keywords)) {
                const keywordsElement = document.getElementById('bossKeywords');
                if (keywordsElement) {
                  keywordsElement.textContent = config.boss.keywords.join(', ');
                }
              }


              // 加载城市
              if (config.boss.cityCode && Array.isArray(config.boss.cityCode)) {
                const citySelect = document.getElementById('bossCityCode');
                if (citySelect) {
                  citySelect.value = config.boss.cityCode[0]; // 取第一个城市
                }
              }

              // 加载工作经验
              if (config.boss.experience && Array.isArray(config.boss.experience)) {
                const expSelect = document.getElementById('bossExperience');
                if (expSelect) {
                  expSelect.value = config.boss.experience[0]; // 取第一个经验要求
                }
              }

              // 加载薪资
              if (config.boss.salary && Array.isArray(config.boss.salary)) {
                const salarySelect = document.getElementById('bossSalary');
                if (salarySelect) {
                  salarySelect.value = config.boss.salary[0]; // 取第一个薪资范围
                }
              } else if (config.boss.salary) {
                const salarySelect = document.getElementById('bossSalary');
                if (salarySelect) {
                  salarySelect.value = config.boss.salary;
                }
              }

              // 加载期望薪资
              if (config.boss.expectedSalary && Array.isArray(config.boss.expectedSalary)) {
                const minSalaryElement = document.getElementById('expectedSalaryMin');
                const maxSalaryElement = document.getElementById('expectedSalaryMax');
                if (minSalaryElement && config.boss.expectedSalary[0]) {
                  minSalaryElement.value = config.boss.expectedSalary[0];
                }
                if (maxSalaryElement && config.boss.expectedSalary[1]) {
                  maxSalaryElement.value = config.boss.expectedSalary[1];
                }
              }

              // 加载投递间隔
              if (config.boss.waitTime) {
                const waitTimeElement = document.getElementById('bossWaitTime');
                if (waitTimeElement) {
                  waitTimeElement.value = config.boss.waitTime;
                }
              }

              // 加载开关选项
              if (config.boss.filterDeadHR !== undefined) {
                const filterDeadHRElement = document.getElementById('filterDeadHR');
                if (filterDeadHRElement) {
                  filterDeadHRElement.checked = config.boss.filterDeadHR;
                }
              }

              if (config.boss.enableAI !== undefined) {
                const enableAIElement = document.getElementById('enableAI');
                if (enableAIElement) {
                  enableAIElement.checked = config.boss.enableAI;
                }
              }

              if (config.boss.enableSmartGreeting !== undefined) {
                const enableSmartGreetingElement = document.getElementById('enableSmartGreeting');
                if (enableSmartGreetingElement) {
                  enableSmartGreetingElement.checked = config.boss.enableSmartGreeting;
                }
              }

              if (config.boss.sendImgResume !== undefined) {
                const sendImgResumeElement = document.getElementById('sendImgResume');
                if (sendImgResumeElement) {
                  sendImgResumeElement.checked = config.boss.sendImgResume;
                }
              }
            }

            console.log('配置加载完成');
          } else {
            showMessage('加载配置失败: ' + (result.message || '未知错误'), 'error');
          }
        } catch (error) {
          console.error('加载配置错误:', error);
          showMessage('加载配置失败: ' + error.message, 'error');
        }
      }

      // 保存配置
      async function saveConfig() {
        console.log('🔄 开始保存配置...');

        // 检查所有必需的元素是否存在
        const requiredElements = [
          'bossKeywords', 'bossSalary', 'expectedSalaryMin',
          'expectedSalaryMax', 'bossWaitTime', 'filterDeadHR', 'enableSmartGreeting', 'sendImgResume'
        ];

        for (const elementId of requiredElements) {
          const element = document.getElementById(elementId);
          if (!element) {
            console.error(`❌ 元素不存在: ${elementId}`);
            showMessage(`配置错误：找不到元素 ${elementId}`, 'error');
            return;
          }
          console.log(`✅ 元素存在: ${elementId}`);
        }

        const config = {
          boss: {
            debugger: false,
            keywords: document
              .getElementById('bossKeywords')
              .textContent.split(',')
              .map(k => k.trim())
              .filter(k => k),
            industry: ['不限'], // 添加行业字段
            cityCode: Array.from(document.getElementById('bossCityCode').selectedOptions).map(
              o => o.value
            ),
            experience: Array.from(document.getElementById('bossExperience').selectedOptions).map(
              o => o.value
            ),
            jobType: '不限',
            salary: [document.getElementById('bossSalary').value],
            degree: ['不限'],
            scale: ['不限'],
            stage: ['不限'],
            expectedSalary: [
              parseInt(document.getElementById('expectedSalaryMin').value),
              parseInt(document.getElementById('expectedSalaryMax').value),
            ],
            waitTime: document.getElementById('bossWaitTime').value,
            filterDeadHR: document.getElementById('filterDeadHR').checked,
            enableAI: document.getElementById('enableAI') ? document.getElementById('enableAI').checked : false,
            enableSmartGreeting: document.getElementById('enableSmartGreeting').checked,
            sendImgResume: document.getElementById('sendImgResume').checked,
            deadStatus: ['3月前活跃', '半年前活跃', '1年前活跃', '2年前活跃'],
          },
          ai: {
            introduce: document.getElementById('aiIntroduce') ? document.getElementById('aiIntroduce').value : '',
            prompt: document.getElementById('aiPrompt') ? document.getElementById('aiPrompt').value : '',
          },
          bot: {
            is_send: document.getElementById('botIsSend') ? document.getElementById('botIsSend').checked : false,
          },
        };

        try {
          console.log('🔄 开始保存配置...');
          const response = await fetchWithAuth('/api/config', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(config),
          });

          console.log('📡 收到响应:', response.status);
          const result = await response.json();
          console.log('📋 响应数据:', result);

          if (result.success) {
            console.log('✅ 准备显示成功消息');
            showMessage('配置保存成功', 'success');
            console.log('✅ showMessage已调用');
          } else {
            console.log('❌ 准备显示失败消息');
            showMessage('保存失败: ' + result.message, 'error');
          }
        } catch (error) {
          console.error('❌ 保存配置异常:', error);
          showMessage('保存配置失败: ' + error.message, 'error');
        }
      }

      // 启动程序
      async function startProgram() {
        const platform = document.getElementById('platformSelect').value;

        try {
          const response = await fetchWithAuth('/start-program', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'platform=' + encodeURIComponent(platform),
          });

          const result = await response.json();
          if (result.success) {
            showMessage('程序启动成功', 'success');
            isRunning = true;
            updateStatus();
          } else {
            showMessage('启动失败: ' + result.message, 'error');
          }
        } catch (error) {
          showMessage('启动程序失败: ' + error.message, 'error');
        }
      }

      // 启动投递任务
      async function startBossTask() {
        try {
          const response = await fetchWithAuth('/start-boss-task', {
            method: 'POST',
          });

          const result = await response.json();
          if (result.success) {
            showMessage('投递任务启动成功！开始自动投递简历...', 'success');
            isRunning = true;
            updateStatus();
          } else {
            showMessage('启动投递失败: ' + result.message, 'error');
          }
        } catch (error) {
          showMessage('启动投递失败: ' + error.message, 'error');
        }
      }

      // 停止程序
      async function stopProgram() {
        try {
          const response = await fetchWithAuth('/stop-program', {
            method: 'POST',
          });

          const result = await response.json();
          if (result.success) {
            showMessage('投递已停止', 'success');
            isRunning = false;
            updateStatus();
          } else {
            showMessage('停止失败: ' + result.message, 'error');
          }
        } catch (error) {
          showMessage('停止程序失败: ' + error.message, 'error');
        }
      }

      // 更新状态
      async function updateStatus() {
        try {
          const response = await fetchWithAuth('/status');
          const status = await response.json();

          isRunning = status.isRunning;
          const statusIndicator = document.getElementById('statusIndicator');
          const statusText = document.getElementById('statusText');
          const deliveryCount = document.getElementById('deliveryCount');
          const startBtn = document.getElementById('startBossTaskBtn');
          const stopBtn = document.getElementById('stopBtn');

          if (isRunning) {
            statusIndicator.className = 'status-indicator status-running';
            statusText.textContent = '运行中';
            startBtn.disabled = true;
            stopBtn.disabled = false;
          } else {
            statusIndicator.className = 'status-indicator status-stopped';
            statusText.textContent = '已停止';
            startBtn.disabled = false;
            stopBtn.disabled = true;
          }

          // 更新投递统计
          const count = status.deliveryCount || 0;
          deliveryCount.textContent = count;
          console.log('投递统计更新:', count);
        } catch (error) {
          // 如果是登录过期错误，不显示错误消息（fetchWithAuth已处理）
          if (!error.message.includes('登录已过期')) {
            console.error('更新状态失败:', error);
            showMessage('更新状态失败: ' + error.message, 'error');
          }
        }
      }

      // 刷新日志
      async function refreshLogs() {
        try {
          const response = await fetchWithAuth('/logs?lines=100');
          const result = await response.json();

          if (result.success && result.logs) {
            const logContainer = document.getElementById('logContainer');
            if (logContainer) {
              logContainer.innerHTML = result.logs
                .map(log => `<div class="log-line">${escapeHtml(log)}</div>`)
                .join('');
              logContainer.scrollTop = logContainer.scrollHeight;
            }
          } else {
            console.warn('日志加载失败:', result.message);
          }
        } catch (error) {
          // 如果是登录过期错误，不显示错误消息
          if (!error.message.includes('登录已过期')) {
            console.error('刷新日志失败:', error);
            showMessage('刷新日志失败: ' + error.message, 'error');
          }
        }
      }

      // 清空日志显示
      function clearLogs() {
        document.getElementById('logContainer').innerHTML =
          '<div class="text-muted">日志已清空</div>';
      }

      // 开始自动刷新
      function startAutoRefresh() {
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
        }

        autoRefreshInterval = setInterval(() => {
          updateStatus();
          if (document.getElementById('autoRefresh').checked) {
            refreshLogs();
          }
        }, 3000);
      }

      // 显示消息
      function showMessage(message, type = 'info') {
        console.log('📢 showMessage被调用:', message, type);
        try {
          const toast = document.getElementById('messageToast');
          const toastMessage = document.getElementById('toastMessage');
          const toastHeader = toast.querySelector('.toast-header i');

          console.log('📢 Toast元素:', toast ? '存在' : '不存在');
          console.log('📢 ToastMessage元素:', toastMessage ? '存在' : '不存在');

          toastMessage.textContent = message;

          // 设置图标和颜色
          toastHeader.className = 'bi me-2';
          if (type === 'success') {
            toastHeader.classList.add('bi-check-circle', 'text-success');
          } else if (type === 'error') {
            toastHeader.classList.add('bi-exclamation-triangle', 'text-danger');
          } else {
            toastHeader.classList.add('bi-info-circle', 'text-primary');
          }

          // 确保toast容器可见
          const toastContainer = document.querySelector('.toast-container');
          toastContainer.style.display = 'block';

          console.log('📢 准备初始化Bootstrap Toast');
          const bsToast = new bootstrap.Toast(toast, {
            autohide: true,
            delay: 3000,
          });
          console.log('📢 调用bsToast.show()');
          bsToast.show();
          console.log('📢 Toast应该已显示');
        } catch (error) {
          console.error('❌ showMessage执行失败:', error);
        }
      }

      // HTML转义
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // 关键词输入处理
      document.getElementById('bossKeywords').addEventListener('input', function () {
        const text = this.textContent;
        const keywords = text
          .split(',')
          .map(k => k.trim())
          .filter(k => k);

        // 可以在这里添加关键词标签显示
        console.log('关键词:', keywords);
      });

      // 检查登录状态 - 已禁用认证，直接返回true
      async function checkAuth() {
        console.log('认证已禁用，允许所有访问');
        return true;
      }

      // 退出登录 - 已禁用
      function logout() {
        console.log('登录功能已禁用');
        // 不执行任何操作
      }

      // 页面加载完成后初始化
      document.addEventListener('DOMContentLoaded', async function () {
        console.log('主页面开始加载');

        // 检查登录状态
        const isLoggedIn = await checkTokenValidity();
        if (!isLoggedIn) {
          console.warn('⚠️ 用户未登录或Token已过期，重定向到登录页');
          window.location.href = '/login';
          return;
        }

        console.log('✅ 认证检查通过，开始初始化页面');

        // 加载配置
        await loadConfig();

        // 启动自动刷新
        startAutoRefresh();

        // 立即执行一次
        updateStatus();
        refreshLogs();

        // 保存定时器引用，每5秒更新一次状态
        statusTimer = setInterval(updateStatus, 5000);

        // 保存定时器引用，每2秒刷新一次日志
        logsTimer = setInterval(refreshLogs, 2000);

        // 初始化简历管理功能
        initializeResumeEventListeners();
        checkExistingResume();
      });

      // 简历管理相关函数 - 完全移植自resume-manager页面
      let candidateData = null;

      // 初始化简历管理事件监听器
      function initializeResumeEventListeners() {
        console.log('初始化简历管理事件监听器...');

        // 文件上传点击事件
        const uploadArea = document.getElementById('uploadArea');
        if (uploadArea) {
          uploadArea.addEventListener('click', function () {
            console.log('点击上传区域');
            document.getElementById('fileInput').click();
          });
        }

        // 文件选择事件
        const fileInput = document.getElementById('fileInput');
        if (fileInput) {
          fileInput.addEventListener('change', function (event) {
            console.log('文件选择事件触发');
            handleFileUpload(event);
          });
        }

        // 拖拽事件
        if (uploadArea) {
          uploadArea.addEventListener('dragover', function (e) {
            e.preventDefault();
            console.log('拖拽中...');
            uploadArea.classList.add('dragover');
          });

          uploadArea.addEventListener('dragleave', function () {
            console.log('拖拽离开');
            uploadArea.classList.remove('dragover');
          });

          uploadArea.addEventListener('drop', function (e) {
            e.preventDefault();
            console.log('文件拖放');
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
              console.log('拖放文件:', files[0].name);
              handleFileUpload({ target: { files: files } });
            }
          });
        }

        console.log('简历管理事件监听器初始化完成');
      }

      // 检查是否已有简历
      function checkExistingResume() {
        fetchWithAuth('/api/candidate-resume/check')
          .then(response => response.json())
          .then(data => {
            if (data.success && data.hasResume) {
              // 加载已有简历
              loadExistingResume();
            }
          })
          .catch(error => {
            console.error('Error:', error);
          });
      }

      // 加载已有简历
      function loadExistingResume() {
        console.log('加载已有简历...');
        fetchWithAuth('/api/candidate-resume/load')
          .then(response => response.json())
          .then(data => {
            console.log('简历加载结果:', data);
            if (data.success) {
              candidateData = data.data;
              displayCandidateInfo(candidateData);
              document.getElementById('deleteBtn').style.display = 'inline-block';

            }
          })
          .catch(error => {
            console.error('加载简历错误:', error);
          });
      }

      // 处理文件上传
      function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) {
          console.log('没有选择文件');
          return;
        }

        console.log('选择的文件:', file.name, '大小:', file.size, '类型:', file.type);

        // 检查文件大小（10MB）
        if (file.size > 10 * 1024 * 1024) {
          alert('文件过大，请上传小于10MB的文件');
          return;
        }

        // 检查文件类型
        const fileName = file.name.toLowerCase();
        if (
          !fileName.endsWith('.txt') &&
          !fileName.endsWith('.pdf') &&
          !fileName.endsWith('.doc') &&
          !fileName.endsWith('.docx')
        ) {
          alert('❌ 不支持的文件格式\n\n支持的格式：TXT、PDF、DOC、DOCX\n请上传正确格式的简历文件');
          return;
        }

        const formData = new FormData();
        formData.append('file', file);

        console.log('开始上传文件...');
        showLoading('正在上传文件并解析简历...');

        fetchWithAuth('/api/candidate-resume/upload', {
          method: 'POST',
          body: formData,
        })
          .then(response => {
            console.log('收到响应，状态:', response.status);
            return response.json();
          })
          .then(data => {
            console.log('解析响应数据:', data);
            hideLoading();
            if (data.success) {
              candidateData = data.data;
              displayCandidateInfo(candidateData);
              document.getElementById('deleteBtn').style.display = 'inline-block';


              alert('简历解析成功！');
            } else {
              alert('文件解析失败：' + data.message);
            }
          })
          .catch(error => {
            hideLoading();
            console.error('上传错误:', error);
            alert('文件上传失败：' + error.message);
          });

        // 重置文件输入，允许重新选择相同文件
        event.target.value = '';
      }

      // 解析简历文本
      function parseResume() {
        const resumeText = document.getElementById('resumeText').value.trim();
        if (!resumeText) {
          alert('请输入简历文本');
          return;
        }

        showLoading('AI正在解析简历...');

        fetchWithAuth('/api/candidate-resume/parse', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ resume_text: resumeText }),
        })
          .then(response => response.json())
          .then(data => {
            hideLoading();
            if (data.success) {
              candidateData = data.data;
              displayCandidateInfo(candidateData);
              document.getElementById('deleteBtn').style.display = 'inline-block';

            } else {
              alert('简历解析失败：' + data.message);
            }
          })
          .catch(error => {
            hideLoading();
            console.error('Error:', error);
            alert('简历解析失败：' + error.message);
          });
      }

      // 删除简历
      function deleteResume() {
        if (!confirm('确定要删除已保存的简历吗？')) {
          return;
        }

        fetchWithAuth('/api/candidate-resume/delete', {
          method: 'POST',
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert('简历已删除');
              candidateData = null;
              document.getElementById('parseResult').style.display = 'none';
              document.getElementById('deleteBtn').style.display = 'none';
              document.getElementById('resumeText').value = '';
            } else {
              alert('删除失败：' + data.message);
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('删除失败：' + error.message);
          });
      }

      // 显示候选人信息
      function displayCandidateInfo(candidate) {
        console.log('显示候选人信息:', candidate);
        const candidateInfo = document.getElementById('candidateInfo');
        if (!candidateInfo) {
          console.error('未找到candidateInfo元素');
          return;
        }
        console.log('开始渲染候选人信息...');
        candidateInfo.innerHTML = `
           <div class="row">
             <div class="col-md-6">
               <h5><i class="bi bi-person-circle"></i> 候选人信息</h5>
               <p class="mb-2"><i class="bi bi-briefcase"></i> <strong>当前职位：</strong>${candidate.current_title || '未知'}</p>
               <p class="mb-2"><i class="bi bi-calendar-check"></i> <strong>工作年限：</strong>${candidate.years_experience || 0}年</p>
               <p class="mb-2"><i class="bi bi-mortarboard"></i> <strong>学历：</strong>${candidate.education || '未知'}</p>
               <p class="mb-2"><i class="bi bi-building"></i> <strong>公司：</strong>${candidate.company || '未知'}</p>
             </div>
             <div class="col-md-6">
               <h6><i class="bi bi-stars"></i> 核心优势：</h6>
               <div class="mb-3">
                 ${(candidate.core_strengths || [])
                   .map(
                     strength =>
                       `<span class="strength-tag" style="display: inline-block; background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; margin: 5px; font-size: 0.9em; backdrop-filter: blur(10px);">${strength}</span>`
                   )
                   .join('')}
               </div>
               <h6><i class="bi bi-tools"></i> 技能：</h6>
               <div>
                 ${(candidate.skills || [])
                   .map(
                     skill =>
                       `<span class="skill-badge" style="background: white; color: #667eea; padding: 6px 12px; border-radius: 15px; margin: 3px; font-size: 0.85em; display: inline-block;">${skill}</span>`
                   )
                   .join('')}
               </div>
             </div>
           </div>
         `;
        console.log('候选人信息已渲染');
        const parseResult = document.getElementById('parseResult');
        if (parseResult) {
          parseResult.style.display = 'block';
          console.log('解析结果区域已显示');
        } else {
          console.error('未找到parseResult元素');
        }
      }





      // 显示/隐藏加载状态
      function showLoading(text) {
        document.getElementById('loadingText').textContent = text || 'AI正在处理中...';
        document.getElementById('loading').style.display = 'block';
      }

      function hideLoading() {
        document.getElementById('loading').style.display = 'none';
      }
    </script>
  </body>
</html>

