<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智投简历 - 简化版Boss任务控制台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
</head>
<body class="bg-light">
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-md-6">
                <!-- Boss任务控制 -->
                <div class="card shadow">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-lightning"></i> Boss任务控制台</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="d-flex align-items-center mb-2">
                                <span class="badge" id="statusBadge" th:classappend="${isRunning ? 'bg-success' : 'bg-danger'}">
                                    <span th:text="${isRunning ? '运行中' : '已停止'}">已停止</span>
                                </span>
                                <button class="btn btn-sm btn-outline-secondary ms-2" onclick="refreshStatus()">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">投递统计: </small>
                                <span id="deliveryCount" class="badge bg-primary">0</span>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button class="btn btn-success btn-lg" id="startBtn" onclick="startBossTask()" th:disabled="${isRunning}">
                                <i class="bi bi-play-fill"></i> 启动Boss任务
                            </button>
                            <button class="btn btn-danger" id="refreshBtn" onclick="refreshStatus()">
                                <i class="bi bi-arrow-clockwise"></i> 刷新状态
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <!-- 实时日志 -->
                <div class="card shadow">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-terminal"></i> 实时日志</h5>
                    </div>
                    <div class="card-body p-0">
                        <div id="logContainer" class="bg-dark text-light p-3" style="height: 400px; overflow-y: auto; font-family: monospace; font-size: 0.9em;">
                            <!-- 日志内容将在这里显示 -->
                            <div class="text-muted">点击"启动Boss任务"开始执行...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 消息提示 -->
        <div id="messageContainer" class="mt-3"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let isRunning = false;
        let logInterval;

        // 启动Boss任务
        async function startBossTask() {
            try {
                const response = await fetch('/start-simple-boss', {
                    method: 'POST'
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('Boss任务启动成功！开始自动投递简历...', 'success');
                    isRunning = true;
                    updateStatus();
                    startLogPolling();
                } else {
                    showMessage('启动Boss失败: ' + result.message, 'error');
                }
            } catch (error) {
                showMessage('启动Boss失败: ' + error.message, 'error');
            }
        }

        // 刷新状态
        async function refreshStatus() {
            try {
                const response = await fetch('/simple-status');
                const status = await response.json();
                
                isRunning = status.isRunning;
                updateStatus();
                
                if (status.deliveryCount) {
                    document.getElementById('deliveryCount').textContent = status.deliveryCount;
                }
            } catch (error) {
                showMessage('获取状态失败: ' + error.message, 'error');
            }
        }

        // 更新状态显示
        function updateStatus() {
            const statusBadge = document.getElementById('statusBadge');
            const startBtn = document.getElementById('startBtn');
            
            if (isRunning) {
                statusBadge.className = 'badge bg-success';
                statusBadge.innerHTML = '运行中';
                startBtn.disabled = true;
                startBtn.innerHTML = '<i class="bi bi-pause-fill"></i> 任务运行中';
            } else {
                statusBadge.className = 'badge bg-danger';
                statusBadge.innerHTML = '已停止';
                startBtn.disabled = false;
                startBtn.innerHTML = '<i class="bi bi-play-fill"></i> 启动Boss任务';
            }
        }

        // 开始轮询日志
        function startLogPolling() {
            // 停止现有的轮询
            if (logInterval) {
                clearInterval(logInterval);
            }
            
            // 每2秒获取一次日志
            logInterval = setInterval(async () => {
                try {
                    if (!isRunning) {
                        clearInterval(logInterval);
                        return;
                    }
                    
                    const response = await fetch('/simple-status');
                    const status = await response.json();
                    
                    if (!status.isRunning) {
                        isRunning = false;
                        updateStatus();
                        clearInterval(logInterval);
                        showMessage('Boss任务已结束', 'info');
                    }
                } catch (error) {
                    console.error('日志轮询错误:', error);
                }
            }, 2000);
        }

        // 显示消息
        function showMessage(message, type) {
            const container = document.getElementById('messageContainer');
            const alertClass = type === 'success' ? 'alert-success' : 
                              type === 'error' ? 'alert-danger' : 
                              type === 'info' ? 'alert-info' : 'alert-secondary';
            
            const alert = document.createElement('div');
            alert.className = `alert ${alertClass} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            container.appendChild(alert);
            
            // 3秒后自动消失
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 3000);
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            refreshStatus();
        });
    </script>
</body>
</html>
