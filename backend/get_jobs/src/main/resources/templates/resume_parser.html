<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能简历解析与打招呼语生成</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .upload-area:hover {
            border-color: #0d6efd;
            background-color: #f8f9fa;
        }
        .upload-area.dragover {
            border-color: #0d6efd;
            background-color: #e3f2fd;
        }
        .greeting-card {
            border-left: 4px solid #0d6efd;
            margin-bottom: 15px;
        }
        .greeting-card.professional {
            border-left-color: #198754;
        }
        .greeting-card.sincere {
            border-left-color: #fd7e14;
        }
        .greeting-card.concise {
            border-left-color: #6f42c1;
        }
        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
        }
        .loading {
            display: none;
        }
        .candidate-info {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .strength-tag {
            display: inline-block;
            background-color: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.85em;
            margin: 2px;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">
                    <i class="bi bi-file-earmark-person"></i>
                    智能简历解析与打招呼语生成系统
                </h1>
            </div>
        </div>

        <div class="row">
            <!-- 左侧：简历上传和解析 -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-upload"></i> 简历上传与解析</h5>
                    </div>
                    <div class="card-body">
                        <!-- 文件上传区域 -->
                        <div class="upload-area" id="uploadArea">
                            <i class="bi bi-cloud-upload fs-1 text-muted"></i>
                            <h5 class="mt-3">拖拽文件到此处或点击上传</h5>
                            <p class="text-muted">支持 TXT、DOC、DOCX、PDF 格式</p>
                            <input type="file" id="fileInput" class="d-none" accept=".txt,.doc,.docx,.pdf">
                        </div>

                        <!-- 文本输入区域 -->
                        <div class="mt-4">
                            <label for="resumeText" class="form-label">或直接粘贴简历文本：</label>
                            <textarea class="form-control" id="resumeText" rows="10" 
                                placeholder="请粘贴您的简历内容..."></textarea>
                        </div>

                        <div class="mt-3">
                            <button class="btn btn-primary" id="parseBtn" onclick="parseResume()">
                                <i class="bi bi-gear"></i> 解析简历
                            </button>
                        </div>

                        <!-- 解析结果 -->
                        <div id="parseResult" class="mt-4" style="display: none;">
                            <h6><i class="bi bi-person-check"></i> 解析结果：</h6>
                            <div class="candidate-info" id="candidateInfo">
                                <!-- 候选人信息将在这里显示 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧：岗位JD和打招呼语生成 -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-chat-quote"></i> 打招呼语生成</h5>
                    </div>
                    <div class="card-body">
                        <!-- 岗位JD输入 -->
                        <div class="mb-3">
                            <label for="jobDescription" class="form-label">岗位描述 (JD)：</label>
                            <textarea class="form-control" id="jobDescription" rows="8" 
                                placeholder="请粘贴岗位描述内容..."></textarea>
                        </div>

                        <!-- 生成模式选择 -->
                        <div class="mb-3">
                            <label class="form-label">生成模式：</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="mode" id="modeProduction" value="production" checked>
                                <label class="form-check-label" for="modeProduction">
                                    生产模式（仅生成打招呼语）
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="mode" id="modeDebug" value="debug">
                                <label class="form-check-label" for="modeDebug">
                                    调试模式（包含匹配分析）
                                </label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <button class="btn btn-success" id="generateBtn" onclick="generateGreetings()" disabled>
                                <i class="bi bi-magic"></i> 生成打招呼语
                            </button>
                        </div>

                        <!-- 生成结果 -->
                        <div id="greetingResult" style="display: none;">
                            <h6><i class="bi bi-chat-heart"></i> 生成的打招呼语：</h6>
                            
                            <!-- 匹配分析（调试模式） -->
                            <div id="matchAnalysis" style="display: none;">
                                <div class="alert alert-info">
                                    <h6><i class="bi bi-search"></i> 匹配分析：</h6>
                                    <div id="analysisContent"></div>
                                </div>
                            </div>

                            <!-- 打招呼语卡片 -->
                            <div id="greetingCards">
                                <!-- 打招呼语卡片将在这里显示 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 加载提示 -->
        <div class="loading text-center mt-4" id="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">处理中...</span>
            </div>
            <p class="mt-2">AI正在处理中，请稍候...</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let candidateData = null;

        // 文件上传处理
        document.getElementById('uploadArea').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });

        document.getElementById('fileInput').addEventListener('change', handleFileUpload);

        // 拖拽上传
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileUpload({ target: { files: files } });
            }
        });

        // 处理文件上传
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            showLoading(true);
            
            fetch('/api/upload_resume', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                if (data.success) {
                    candidateData = data.data;
                    displayCandidateInfo(candidateData);
                    document.getElementById('generateBtn').disabled = false;
                } else {
                    alert('文件解析失败：' + data.message);
                }
            })
            .catch(error => {
                showLoading(false);
                console.error('Error:', error);
                alert('文件上传失败：' + error.message);
            });
        }

        // 解析简历文本
        function parseResume() {
            const resumeText = document.getElementById('resumeText').value.trim();
            if (!resumeText) {
                alert('请输入简历文本');
                return;
            }

            showLoading(true);

            fetch('/api/parse_resume', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ resume_text: resumeText })
            })
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                if (data.success) {
                    candidateData = data.data;
                    displayCandidateInfo(candidateData);
                    document.getElementById('generateBtn').disabled = false;
                } else {
                    alert('简历解析失败：' + data.message);
                }
            })
            .catch(error => {
                showLoading(false);
                console.error('Error:', error);
                alert('简历解析失败：' + error.message);
            });
        }

        // 生成打招呼语
        function generateGreetings() {
            if (!candidateData) {
                alert('请先解析简历');
                return;
            }

            const jobDescription = document.getElementById('jobDescription').value.trim();
            if (!jobDescription) {
                alert('请输入岗位描述');
                return;
            }

            const mode = document.querySelector('input[name="mode"]:checked').value;

            showLoading(true);

            fetch('/api/generate_greetings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    candidate: candidateData,
                    job_description: jobDescription,
                    mode: mode
                })
            })
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                if (data.success) {
                    displayGreetingResult(data.data, mode);
                } else {
                    alert('打招呼语生成失败：' + data.message);
                }
            })
            .catch(error => {
                showLoading(false);
                console.error('Error:', error);
                alert('打招呼语生成失败：' + error.message);
            });
        }

        // 显示候选人信息
        function displayCandidateInfo(candidate) {
            const candidateInfo = document.getElementById('candidateInfo');
            candidateInfo.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="bi bi-person"></i> ${candidate.name || '未知'}</h6>
                        <p><strong>当前职位：</strong>${candidate.current_title || '未知'}</p>
                        <p><strong>工作年限：</strong>${candidate.years_experience || 0}年</p>
                        <p><strong>学历：</strong>${candidate.education || '未知'}</p>
                        <p><strong>公司：</strong>${candidate.company || '未知'}</p>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="bi bi-award"></i> 核心优势：</h6>
                        <div>
                            ${(candidate.core_strengths || []).map(strength => 
                                `<span class="strength-tag">${strength}</span>`
                            ).join('')}
                        </div>
                        <h6 class="mt-3"><i class="bi bi-tools"></i> 技能：</h6>
                        <div>
                            ${(candidate.skills || []).map(skill => 
                                `<span class="badge bg-secondary me-1">${skill}</span>`
                            ).join('')}
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('parseResult').style.display = 'block';
        }

        // 显示打招呼语结果
        function displayGreetingResult(data, mode) {
            const greetingResult = document.getElementById('greetingResult');
            const greetingCards = document.getElementById('greetingCards');
            const matchAnalysis = document.getElementById('matchAnalysis');

            // 显示匹配分析（调试模式）
            if (mode === 'debug' && data.match_analysis) {
                const analysisContent = document.getElementById('analysisContent');
                const analysis = data.match_analysis;
                
                analysisContent.innerHTML = `
                    <p><strong>整体匹配度：</strong>${(analysis.overall_score * 100).toFixed(1)}%</p>
                    <p><strong>匹配技能：</strong>${(analysis.matched_skills || []).join(', ')}</p>
                    <p><strong>匹配要求：</strong>${(analysis.matched_requirements || []).join(', ')}</p>
                    <p><strong>差距：</strong>${(analysis.gaps || []).join(', ')}</p>
                `;
                matchAnalysis.style.display = 'block';
            } else {
                matchAnalysis.style.display = 'none';
            }

            // 显示打招呼语卡片
            if (data.greetings) {
                greetingCards.innerHTML = '';
                
                const greetingTypes = [
                    { key: 'professional', title: '专业风格', icon: 'bi-briefcase', class: 'professional' },
                    { key: 'sincere', title: '真诚风格', icon: 'bi-heart', class: 'sincere' },
                    { key: 'concise', title: '简洁风格', icon: 'bi-chat', class: 'concise' }
                ];

                greetingTypes.forEach(type => {
                    if (data.greetings[type.key]) {
                        const card = document.createElement('div');
                        card.className = `card greeting-card ${type.class}`;
                        card.innerHTML = `
                            <div class="card-body position-relative">
                                <button class="btn btn-sm btn-outline-primary copy-btn" onclick="copyToClipboard('${type.key}')">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                                <h6><i class="bi ${type.icon}"></i> ${type.title}</h6>
                                <p class="mb-0" id="${type.key}">${data.greetings[type.key]}</p>
                            </div>
                        `;
                        greetingCards.appendChild(card);
                    }
                });
            }

            greetingResult.style.display = 'block';
        }

        // 复制到剪贴板
        function copyToClipboard(type) {
            const text = document.getElementById(type).textContent;
            navigator.clipboard.writeText(text).then(() => {
                // 显示复制成功提示
                const btn = event.target.closest('button');
                const originalIcon = btn.innerHTML;
                btn.innerHTML = '<i class="bi bi-check"></i>';
                btn.classList.remove('btn-outline-primary');
                btn.classList.add('btn-success');
                
                setTimeout(() => {
                    btn.innerHTML = originalIcon;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-primary');
                }, 2000);
            }).catch(err => {
                console.error('复制失败:', err);
                alert('复制失败，请手动复制');
            });
        }

        // 显示/隐藏加载状态
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
    </script>
</body>
</html>
