<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI找工作助手 - 可视化配置</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      .config-section {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
      }
      .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
      }
      .status-running {
        background-color: #28a745;
        animation: pulse 2s infinite;
      }
      .status-stopped {
        background-color: #dc3545;
      }
      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }
      .log-container {
        background: #1e1e1e;
        color: #ffffff;
        border-radius: 8px;
        padding: 15px;
        height: 400px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 12px;
      }
      .keyword-tag {
        background: #007bff;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
        margin: 2px;
        display: inline-block;
      }
      .keyword-input {
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 10px;
        min-height: 50px;
      }
      .nav-tabs .nav-link {
        border-radius: 8px 8px 0 0;
      }
      .nav-tabs .nav-link.active {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <!-- 侧边栏 -->
        <div class="col-md-3 bg-light p-3">
          <h4 class="mb-4"><i class="bi bi-robot"></i> AI找工作助手</h4>

          <!-- 程序状态 -->
          <div class="card mb-3">
            <div class="card-header">
              <h6 class="mb-0">程序状态</h6>
            </div>
            <div class="card-body">
              <div class="d-flex align-items-center mb-2">
                <span class="status-indicator" id="statusIndicator"></span>
                <span id="statusText">已停止</span>
              </div>
              <div class="mb-2">
                <small class="text-muted">投递统计: </small>
                <span id="deliveryCount" class="badge bg-primary">0</span>
              </div>
              <div class="d-grid gap-2">
                <button class="btn btn-success btn-sm" id="startBtn" onclick="startProgram()">
                  <i class="bi bi-play-fill"></i> 启动程序
                </button>
                <button class="btn btn-danger btn-sm" id="stopBtn" onclick="stopProgram()" disabled>
                  <i class="bi bi-stop-fill"></i> 停止程序
                </button>
              </div>
            </div>
          </div>

          <!-- 平台选择 -->
          <div class="card mb-3">
            <div class="card-header">
              <h6 class="mb-0">选择平台</h6>
            </div>
            <div class="card-body">
              <select class="form-select form-select-sm" id="platformSelect">
                <option value="boss.Boss">Boss直聘</option>
                <option value="job51.Job51">前程无忧</option>
                <option value="lagou.Lagou">拉勾网</option>
                <option value="liepin.Liepin">猎聘网</option>
                <option value="zhilian.ZhiLian">智联招聘</option>
              </select>
            </div>
          </div>

          <!-- 操作按钮 -->
          <div class="d-grid gap-2">
            <button class="btn btn-primary" onclick="saveConfig()">
              <i class="bi bi-save"></i> 保存配置
            </button>
            <button class="btn btn-outline-secondary" onclick="loadConfig()">
              <i class="bi bi-arrow-clockwise"></i> 重新加载
            </button>
          </div>
        </div>

        <!-- 主内容区 -->
        <div class="col-md-9 p-3">
          <!-- 配置标签页 -->
          <ul class="nav nav-tabs" id="configTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button
                class="nav-link active"
                id="boss-tab"
                data-bs-toggle="tab"
                data-bs-target="#boss"
                type="button"
              >
                <i class="bi bi-briefcase"></i> Boss直聘
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button
                class="nav-link"
                id="resume-tab"
                data-bs-toggle="tab"
                data-bs-target="#resume"
                type="button"
              >
                <i class="bi bi-file-earmark-person"></i> 简历管理
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button
                class="nav-link"
                id="logs-tab"
                data-bs-toggle="tab"
                data-bs-target="#logs"
                type="button"
              >
                <i class="bi bi-journal-text"></i> 运行日志
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button
                class="nav-link"
                id="resume-tab"
                data-bs-toggle="tab"
                data-bs-target="#resume"
                type="button"
              >
                <i class="bi bi-file-text"></i> 个人简历
              </button>
            </li>
          </ul>

          <div class="tab-content" id="configTabContent">
            <!-- Boss直聘配置 -->
            <div class="tab-pane fade show active" id="boss" role="tabpanel">
              <div class="config-section">
                <h5><i class="bi bi-gear"></i> Boss直聘配置</h5>

                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">搜索关键词</label>
                      <div
                        class="keyword-input"
                        id="bossKeywords"
                        contenteditable="true"
                        data-placeholder="输入关键词，用逗号分隔"
                      ></div>
                      <small class="text-muted">例如：市场总监,市场营销,品牌营销</small>
                    </div>

                    <div class="mb-3">
                      <label class="form-label">工作城市</label>
                      <select class="form-select" id="bossCityCode" multiple>
                        <option value="全国">全国</option>
                        <option value="北京">北京</option>
                        <option value="上海" selected>上海</option>
                        <option value="杭州">杭州</option>
                        <option value="广州">广州</option>
                        <option value="深圳">深圳</option>
                        <option value="成都">成都</option>
                        <option value="天津">天津</option>
                      </select>
                    </div>

                    <div class="mb-3">
                      <label class="form-label">工作经验</label>
                      <select class="form-select" id="bossExperience" multiple>
                        <option value="应届毕业生">应届毕业生</option>
                        <option value="1年以下">1年以下</option>
                        <option value="1-3年">1-3年</option>
                        <option value="3-5年">3-5年</option>
                        <option value="5-10年">5-10年</option>
                        <option value="10年以上" selected>10年以上</option>
                      </select>
                    </div>

                    <div class="mb-3">
                      <label class="form-label">薪资要求</label>
                      <select class="form-select" id="bossSalary">
                        <option value="3K以下">3K以下</option>
                        <option value="3-5K">3-5K</option>
                        <option value="5-10K">5-10K</option>
                        <option value="10-20K">10-20K</option>
                        <option value="20-50K">20-50K</option>
                        <option value="30K以上" selected>30K以上</option>
                        <option value="50K以上">50K以上</option>
                      </select>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">期望薪资范围 (K)</label>
                      <div class="row">
                        <div class="col-6">
                          <input
                            type="number"
                            class="form-control"
                            id="expectedSalaryMin"
                            placeholder="最低"
                            value="30"
                          />
                        </div>
                        <div class="col-6">
                          <input
                            type="number"
                            class="form-control"
                            id="expectedSalaryMax"
                            placeholder="最高"
                            value="50"
                          />
                        </div>
                      </div>
                    </div>

                    <div class="mb-3">
                      <label class="form-label">投递间隔 (秒)</label>
                      <input
                        type="number"
                        class="form-control"
                        id="bossWaitTime"
                        value="10"
                        min="1"
                        max="60"
                      />
                    </div>

                    <div class="mb-3">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="filterDeadHR" checked />
                        <label class="form-check-label" for="filterDeadHR"> 过滤不活跃HR </label>
                      </div>
                    </div>

                    <div class="mb-3">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="enableAI" />
                        <label class="form-check-label" for="enableAI"> 启用AI智能打招呼 </label>
                      </div>
                    </div>

                    <div class="mb-3">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="sendImgResume" />
                        <label class="form-check-label" for="sendImgResume"> 发送图片简历 </label>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="mb-3">
                  <label class="form-label">打招呼语</label>
                  <textarea
                    class="form-control"
                    id="bossSayHi"
                    rows="8"
                    placeholder="输入您的打招呼语..."
                  >
您好！
我对这个岗位非常感兴趣。我简单介绍一下：过往18年的职业生涯中，我始终专注于B2B领域的市场增长与品牌构建。在泛微网络（股票代码：603039）担任网络营销总监期间，我成功主导构建了一套融合销售与营销的数字化增长体系，助力公司营收在6年内实现了从7亿到近24亿的跨越，其中市场营销部门直接贡献了超过10亿的销售额 。

我深信，我在全链路营销策略、大规模市场活动策划（年度活动报名超6万人次） 以及高效能团队管理方面的深度实践，能够为贵公司在品牌影响力提升、业务增长方面带来切实的价值。

期待有机会能与您进一步交流，探讨我如何为团队贡献力量。</textarea
                  >
                </div>
              </div>
            </div>

             <!-- 简历管理 -->
             <div class="tab-pane fade" id="resume" role="tabpanel">
               <div class="config-section">
                 <h5><i class="bi bi-file-earmark-person"></i> 简历管理</h5>

                 <!-- 简历上传区域 -->
                 <div class="card border-0 shadow-sm mb-4">
                   <div class="card-body p-4">
                     <h5 class="card-title mb-4">
                       <i class="bi bi-cloud-upload"></i> 上传简历
                     </h5>

                     <!-- 文件上传 -->
                     <div class="upload-area" id="uploadArea" style="border: 3px dashed #dee2e6; border-radius: 15px; padding: 60px 40px; text-align: center; transition: all 0.3s ease; cursor: pointer; background: #f8f9fa;">
                       <i class="bi bi-file-earmark-arrow-up fs-1 text-primary"></i>
                       <h4 class="mt-3">拖拽文件到此处或点击上传</h4>
                       <p class="text-muted">
                         <strong class="text-success">✅ 支持 TXT、PDF、DOC、DOCX 格式</strong><br>
                         <small>文件大小不超过 10MB | AI自动提取文本内容</small>
                       </p>
                       <input type="file" id="fileInput" class="d-none" accept=".txt,.pdf,.doc,.docx">
                     </div>

                     <!-- 文本输入 -->
                     <div class="mt-4">
                       <label for="resumeText" class="form-label fw-bold">
                         <i class="bi bi-pencil-square"></i> 或直接粘贴简历文本：
                       </label>
                       <textarea class="form-control" id="resumeText" rows="12"
                         placeholder="请粘贴您的简历内容...&#10;&#10;建议包含：&#10;- 个人信息（姓名、职位）&#10;- 工作经历（公司、职位、年限）&#10;- 核心技能&#10;- 主要成就&#10;- 教育背景"></textarea>
                     </div>

                     <div class="mt-4 d-flex gap-3">
                       <button class="btn btn-primary btn-lg" id="parseBtn" onclick="parseResume()">
                         <i class="bi bi-cpu"></i> AI解析简历
                       </button>
                       <button class="btn btn-outline-danger" id="deleteBtn" onclick="deleteResume()" style="display:none;">
                         <i class="bi bi-trash"></i> 删除简历
                       </button>
                     </div>
                   </div>
                 </div>

                 <!-- 解析结果展示 -->
                 <div id="parseResult" style="display: none;">
                   <div class="candidate-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px; padding: 30px; margin-bottom: 30px;">
                     <h4 class="mb-3">
                       <i class="bi bi-person-check-fill"></i>
                       解析结果
                     </h4>
                     <div id="candidateInfo">
                       <!-- 候选人信息将在这里显示 -->
                     </div>
                   </div>

                   <!-- AI生成默认打招呼语 -->
                   <div class="card border-0 shadow-sm">
                     <div class="card-body p-4">
                       <h5 class="card-title mb-3">
                         <i class="bi bi-chat-heart-fill text-success"></i>
                         AI生成的默认打招呼语
                       </h5>
                       <div class="alert alert-info">
                         <i class="bi bi-info-circle"></i>
                         <strong>说明：</strong>基于您的简历，AI已生成一段通用的打招呼语。您可以直接使用，也可以根据需要修改。
                       </div>
                       <div class="mb-3">
                         <label for="defaultGreeting" class="form-label fw-bold">默认打招呼语：</label>
                         <textarea class="form-control" id="defaultGreeting" rows="6"
                           placeholder="AI正在生成中..."></textarea>
                       </div>
                       <div class="d-flex gap-2">
                         <button class="btn btn-primary" onclick="saveDefaultGreeting()">
                           <i class="bi bi-save"></i> 保存为默认招呼语
                         </button>
                         <button class="btn btn-outline-primary" onclick="regenerateGreeting()">
                           <i class="bi bi-arrow-clockwise"></i> 重新生成
                         </button>
                       </div>
                     </div>
                   </div>
                 </div>
               </div>
             </div>

            <!-- 运行日志 -->
            <div class="tab-pane fade" id="logs" role="tabpanel">
              <div class="config-section">
                <h5><i class="bi bi-journal-text"></i> 运行日志</h5>
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <div>
                    <button class="btn btn-outline-primary btn-sm" onclick="refreshLogs()">
                      <i class="bi bi-arrow-clockwise"></i> 刷新日志
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="clearLogs()">
                      <i class="bi bi-trash"></i> 清空显示
                    </button>
                  </div>
                  <div>
                    <small class="text-muted">自动刷新: </small>
                    <div class="form-check form-switch d-inline-block">
                      <input class="form-check-input" type="checkbox" id="autoRefresh" checked />
                    </div>
                  </div>
                </div>
                <div class="log-container" id="logContainer">
                  <div class="text-muted">等待程序启动...</div>
                </div>
              </div>
            </div>

            <!-- 个人简历 -->
            <div class="tab-pane fade" id="resume" role="tabpanel">
              <div class="config-section">
                <h5><i class="bi bi-file-text"></i> 个人简历管理</h5>
                <p class="text-muted">管理您的个人简历信息，支持用户级数据隔离。</p>

                <div class="mb-3">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <label class="form-label">简历内容</label>
                    <div>
                      <button class="btn btn-outline-primary btn-sm" onclick="loadUserResume()">
                        <i class="bi bi-arrow-clockwise"></i> 加载简历
                      </button>
                      <button class="btn btn-success btn-sm" onclick="saveUserResume()">
                        <i class="bi bi-save"></i> 保存简历
                      </button>
                    </div>
                  </div>
                  <textarea
                    class="form-control"
                    id="userResume"
                    rows="20"
                    placeholder="请输入您的个人简历内容..."
                  ></textarea>
                  <small class="text-muted">简历将保存在您的个人数据目录中，与其他用户隔离。</small>
                </div>

                <div class="mb-3">
                  <h6>简历统计</h6>
                  <div class="row">
                    <div class="col-md-4">
                      <div class="card">
                        <div class="card-body text-center">
                          <h5 class="card-title" id="resumeWordCount">0</h5>
                          <p class="card-text">字数</p>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="card">
                        <div class="card-body text-center">
                          <h5 class="card-title" id="resumeLineCount">0</h5>
                          <p class="card-text">行数</p>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="card">
                        <div class="card-body text-center">
                          <h5 class="card-title" id="resumeLastModified">未保存</h5>
                          <p class="card-text">最后修改</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="alert alert-info" role="alert">
                  <h6>提示：</h6>
                  <ul class="mb-0">
                    <li>您的简历数据将保存在个人数据目录中，与其他用户完全隔离</li>
                    <li>支持实时保存，不用担心数据丢失</li>
                    <li>可以在AI配置中使用该简历生成个性化的打招呼语</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

     <!-- 消息提示 -->
     <div class="toast-container position-fixed bottom-0 end-0 p-3">
       <div id="messageToast" class="toast" role="alert">
         <div class="toast-header">
           <i class="bi bi-info-circle text-primary me-2"></i>
           <strong class="me-auto">系统消息</strong>
           <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
         </div>
         <div class="toast-body" id="toastMessage">消息内容</div>
       </div>
     </div>

     <!-- 加载提示 -->
     <div class="loading" id="loading" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9999;">
       <div class="loading-content" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: white;">
         <div class="spinner-border text-light mb-3" role="status" style="width: 3rem; height: 3rem;">
           <span class="visually-hidden">处理中...</span>
         </div>
         <h4 id="loadingText">AI正在处理中，请稍候...</h4>
         <p class="text-light">这可能需要10-30秒</p>
       </div>
     </div>

    <script>
      // Token同步脚本 - 将Cookie中的token同步到localStorage
      function syncTokenFromCookie() {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
          const [name, value] = cookie.split('=').map(c => c.trim());
          if (name === 'authToken' && value) {
            localStorage.setItem('token', value);
            console.log('✅ Token已从Cookie同步到localStorage');
            return true;
          }
        }
        return false;
      }

      // 获取当前用户信息
      async function getCurrentUserInfo() {
        try {
          const token = localStorage.getItem('token');
          if (!token) return null;

          const response = await fetch('/api/auth/user/info', {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (response.ok) {
            const result = await response.json();
            return result.user;
          }
        } catch (error) {
          console.error('获取用户信息失败:', error);
        }
        return null;
      }

      // 显示用户信息
      async function displayUserInfo() {
        const userInfo = await getCurrentUserInfo();
        if (userInfo) {
          // 在页面上显示用户信息
          const userInfoDiv = document.createElement('div');
          userInfoDiv.id = 'userInfo';
          userInfoDiv.className = 'alert alert-info';
          userInfoDiv.innerHTML = `
                    <strong>当前用户:</strong> ${userInfo.username || userInfo.email}
                    <small class="text-muted">(个人数据独立存储)</small>
                `;

          // 插入到侧边栏顶部
          const sidebar = document.querySelector('.col-md-3');
          if (sidebar) {
            sidebar.insertBefore(userInfoDiv, sidebar.firstChild.nextSibling);
          }
        }
      }

      // 页面加载时检查token和用户信息
      document.addEventListener('DOMContentLoaded', function () {
        const hasToken = syncTokenFromCookie();
        if (!hasToken) {
          // 如果没有token，跳转到首页登录
          console.log('⚠️ 未找到认证token，将跳转到首页登录');
          setTimeout(() => {
            window.location.href = '/login';
          }, 2000);
          document.body.innerHTML = `
                    <div style="text-align: center; padding: 50px; font-family: Arial, sans-serif;">
                        <h2>需要登录认证</h2>
                        <p>正在跳转到登录页面...</p>
                        <p><a href="/login">点击这里立即跳转</a></p>
                    </div>
                `;
        } else {
          // 显示用户信息
          displayUserInfo();
        }
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let autoRefreshInterval;
      let isRunning = false;

      // 页面加载完成后初始化
      document.addEventListener('DOMContentLoaded', function () {
        loadConfig();
        loadAIConfig();
        loadUserResume();
        updateStatus();
        startAutoRefresh();

        // 添加简历统计事件监听器
        const resumeTextarea = document.getElementById('resumeText');
        if (resumeTextarea) {
          resumeTextarea.addEventListener('input', updateResumeStats);
          updateResumeStats(); // 初始化统计
        }
      });

      // 加载配置
      async function loadConfig() {
        try {
          const token = localStorage.getItem('token');
          const response = await fetch('/api/config', {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });
          const result = await response.json();

          if (result.success) {
            const config = result.config;
            if (config.boss) {
              // 填充Boss配置
              document.getElementById('bossKeywords').textContent = config.boss.keywords
                ? config.boss.keywords.join(', ')
                : '';
              document.getElementById('bossSayHi').value = config.boss.sayHi || '';
              document.getElementById('bossWaitTime').value = config.boss.waitTime || 10;
              document.getElementById('expectedSalaryMin').value = config.boss.expectedSalary
                ? config.boss.expectedSalary[0]
                : 30;
              document.getElementById('expectedSalaryMax').value = config.boss.expectedSalary
                ? config.boss.expectedSalary[1]
                : 50;
              document.getElementById('filterDeadHR').checked = config.boss.filterDeadHR || false;
              document.getElementById('enableAI').checked = config.boss.enableAI || false;
              document.getElementById('sendImgResume').checked = config.boss.sendImgResume || false;

              // 设置薪资选择
              if (config.boss.salary) {
                document.getElementById('bossSalary').value = config.boss.salary;
              }
            }

            if (config.ai) {
              document.getElementById('aiIntroduce').value = config.ai.introduce || '';
              document.getElementById('aiPrompt').value = config.ai.prompt || '';
            }

            if (config.bot) {
              document.getElementById('botIsSend').checked = config.bot.is_send || false;
            }

            console.log('✅ 用户配置加载成功');
          } else {
            showMessage('加载配置失败: ' + result.message, 'error');
          }
        } catch (error) {
          showMessage('加载配置失败: ' + error.message, 'error');
        }
      }

      // 保存配置
      async function saveConfig() {
        const config = {
          boss: {
            debugger: false,
            sayHi: document.getElementById('bossSayHi').value,
            keywords: document
              .getElementById('bossKeywords')
              .textContent.split(',')
              .map(k => k.trim())
              .filter(k => k),
            cityCode: Array.from(document.getElementById('bossCityCode').selectedOptions).map(
              o => o.value
            ),
            experience: Array.from(document.getElementById('bossExperience').selectedOptions).map(
              o => o.value
            ),
            jobType: '不限',
            salary: document.getElementById('bossSalary').value,
            degree: ['不限'],
            scale: ['不限'],
            stage: ['不限'],
            expectedSalary: [
              parseInt(document.getElementById('expectedSalaryMin').value),
              parseInt(document.getElementById('expectedSalaryMax').value),
            ],
            waitTime: parseInt(document.getElementById('bossWaitTime').value),
            filterDeadHR: document.getElementById('filterDeadHR').checked,
            enableAI: document.getElementById('enableAI').checked,
            sendImgResume: document.getElementById('sendImgResume').checked,
            deadStatus: ['2周内活跃', '本月活跃', '2月内活跃', '半年前活跃'],
          },
          ai: {
            introduce: document.getElementById('aiIntroduce').value,
            prompt: document.getElementById('aiPrompt').value,
          },
          bot: {
            is_send: document.getElementById('botIsSend').checked,
          },
        };

        try {
          const token = localStorage.getItem('token');
          const response = await fetch('/api/config', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(config),
          });

          const result = await response.json();
          if (result.success) {
            showMessage('用户配置保存成功', 'success');
          } else {
            showMessage('保存失败: ' + result.message, 'error');
          }
        } catch (error) {
          showMessage('保存配置失败: ' + error.message, 'error');
        }
      }

      // 启动程序
      async function startProgram() {
        const platform = document.getElementById('platformSelect').value;

        try {
          const response = await fetch('/api/start', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ platform: platform }),
          });

          const result = await response.json();
          if (result.success) {
            showMessage('程序启动成功', 'success');
            isRunning = true;
            updateStatus();
          } else {
            showMessage('启动失败: ' + result.message, 'error');
          }
        } catch (error) {
          showMessage('启动程序失败: ' + error.message, 'error');
        }
      }

      // 停止程序
      async function stopProgram() {
        try {
          const response = await fetch('/api/stop', {
            method: 'POST',
          });

          const result = await response.json();
          if (result.success) {
            showMessage('程序已停止', 'success');
            isRunning = false;
            updateStatus();
          } else {
            showMessage('停止失败: ' + result.message, 'error');
          }
        } catch (error) {
          showMessage('停止程序失败: ' + error.message, 'error');
        }
      }

      // 更新状态
      async function updateStatus() {
        try {
          const response = await fetch('/api/status');
          const status = await response.json();

          isRunning = status.isRunning;
          const statusIndicator = document.getElementById('statusIndicator');
          const statusText = document.getElementById('statusText');
          const deliveryCount = document.getElementById('deliveryCount');
          const startBtn = document.getElementById('startBtn');
          const stopBtn = document.getElementById('stopBtn');

          if (isRunning) {
            statusIndicator.className = 'status-indicator status-running';
            statusText.textContent = '运行中';
            startBtn.disabled = true;
            stopBtn.disabled = false;
          } else {
            statusIndicator.className = 'status-indicator status-stopped';
            statusText.textContent = '已停止';
            startBtn.disabled = false;
            stopBtn.disabled = true;
          }

          deliveryCount.textContent = status.deliveryCount || 0;

          // 更新日志显示
          if (status.recentLogs && status.recentLogs.length > 0) {
            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML = status.recentLogs
              .map(log => `<div class="log-line">${escapeHtml(log)}</div>`)
              .join('');
            logContainer.scrollTop = logContainer.scrollHeight;
          }
        } catch (error) {
          console.error('更新状态失败:', error);
        }
      }

      // 刷新日志
      async function refreshLogs() {
        try {
          const response = await fetch('/api/logs?lines=100');
          const result = await response.json();

          if (result.success) {
            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML = result.logs
              .map(log => `<div class="log-line">${escapeHtml(log)}</div>`)
              .join('');
            logContainer.scrollTop = logContainer.scrollHeight;
          }
        } catch (error) {
          console.error('刷新日志失败:', error);
        }
      }

      // 清空日志显示
      function clearLogs() {
        document.getElementById('logContainer').innerHTML =
          '<div class="text-muted">日志已清空</div>';
      }

      // 开始自动刷新
      function startAutoRefresh() {
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
        }

        autoRefreshInterval = setInterval(() => {
          updateStatus();
          if (document.getElementById('autoRefresh').checked) {
            refreshLogs();
          }
        }, 3000);
      }

      // 显示消息
      function showMessage(message, type = 'info') {
        const toast = document.getElementById('messageToast');
        const toastMessage = document.getElementById('toastMessage');
        const toastHeader = toast.querySelector('.toast-header i');

        toastMessage.textContent = message;

        // 设置图标和颜色
        toastHeader.className = 'bi me-2';
        if (type === 'success') {
          toastHeader.classList.add('bi-check-circle', 'text-success');
        } else if (type === 'error') {
          toastHeader.classList.add('bi-exclamation-triangle', 'text-danger');
        } else {
          toastHeader.classList.add('bi-info-circle', 'text-primary');
        }

        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
      }

      // HTML转义
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // 加载用户简历
      async function loadUserResume() {
        try {
          const token = localStorage.getItem('token');
          const response = await fetch('/api/resume', {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          const result = await response.json();
          if (result.success) {
            document.getElementById('userResume').value = result.content || '';
            updateResumeStats();
            showMessage('简历加载成功', 'success');
          } else {
            showMessage('加载简历失败: ' + result.message, 'error');
          }
        } catch (error) {
          showMessage('加载简历失败: ' + error.message, 'error');
        }
      }

      // 保存用户简历
      async function saveUserResume() {
        try {
          const resumeContent = document.getElementById('userResume').value;
          const token = localStorage.getItem('token');

          const response = await fetch('/api/resume', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ content: resumeContent }),
          });

          const result = await response.json();
          if (result.success) {
            updateResumeStats();
            document.getElementById('resumeLastModified').textContent = new Date().toLocaleString();
            showMessage('简历保存成功', 'success');
          } else {
            showMessage('保存简历失败: ' + result.message, 'error');
          }
        } catch (error) {
          showMessage('保存简历失败: ' + error.message, 'error');
        }
      }

      // 更新简历统计
      function updateResumeStats() {
        const resumeContent = document.getElementById('userResume').value;
        const wordCount = resumeContent.length;
        const lineCount = resumeContent.split('\n').length;

        document.getElementById('resumeWordCount').textContent = wordCount;
        document.getElementById('resumeLineCount').textContent = lineCount;
      }

      // 简历内容变化时更新统计
      document.addEventListener('DOMContentLoaded', function () {
        const resumeTextarea = document.getElementById('userResume');
        if (resumeTextarea) {
          resumeTextarea.addEventListener('input', updateResumeStats);
        }
      });

      // 加载AI配置
      async function loadAIConfig() {
        try {
          const token = localStorage.getItem('token');
          const response = await fetch('/api/ai-config', {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });
          const result = await response.json();

          if (result.success) {
            const config = result.config;
            document.getElementById('aiBaseUrl').value = config.BASE_URL || '';
            document.getElementById('aiApiKey').value = config.API_KEY || '';
            document.getElementById('aiModel').value = config.MODEL || '';
            document.getElementById('hookUrl').value = config.HOOK_URL || '';
            document.getElementById('barkUrl').value = config.BARK_URL || '';

            // 根据BASE_URL自动选择服务类型
            updateServiceTypeFromUrl(config.BASE_URL || '');

            console.log('✅ 用户AI配置加载成功');
          } else {
            showMessage('加载AI配置失败: ' + result.message, 'error');
          }
        } catch (error) {
          console.error('加载AI配置失败:', error);
        }
      }

      // 根据URL自动选择服务类型
      function updateServiceTypeFromUrl(url) {
        const select = document.getElementById('aiServiceType');
        if (url.includes('localhost:11434') || url.includes('127.0.0.1:11434')) {
          select.value = 'ollama';
        } else if (url.includes('deepseek.com')) {
          select.value = 'deepseek';
        } else if (url.includes('openai.com')) {
          select.value = 'openai';
        } else {
          select.value = 'custom';
        }
      }

      // 更新AI服务配置
      function updateAIServiceConfig() {
        const serviceType = document.getElementById('aiServiceType').value;
        const baseUrlInput = document.getElementById('aiBaseUrl');
        const apiKeyInput = document.getElementById('aiApiKey');
        const modelInput = document.getElementById('aiModel');

        switch (serviceType) {
          case 'ollama':
            baseUrlInput.value = 'http://localhost:11434';
            apiKeyInput.value = 'ollama';
            modelInput.value = 'qwen2:7b';
            break;
          case 'deepseek':
            baseUrlInput.value = 'https://api.deepseek.com';
            apiKeyInput.value = '';
            modelInput.value = 'deepseek-chat';
            break;
          case 'openai':
            baseUrlInput.value = 'https://api.openai.com';
            apiKeyInput.value = '';
            modelInput.value = 'gpt-4o-mini';
            break;
          case 'custom':
            baseUrlInput.value = '';
            apiKeyInput.value = '';
            modelInput.value = '';
            break;
        }
      }

      // 保存AI配置
      async function saveAIConfig() {
        const config = {
          BASE_URL: document.getElementById('aiBaseUrl').value,
          API_KEY: document.getElementById('aiApiKey').value,
          MODEL: document.getElementById('aiModel').value,
          HOOK_URL: document.getElementById('hookUrl').value,
          BARK_URL: document.getElementById('barkUrl').value,
        };

        try {
          const token = localStorage.getItem('token');
          const response = await fetch('/api/ai-config', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(config),
          });

          const result = await response.json();
          if (result.success) {
            showMessage('用户AI配置保存成功', 'success');
          } else {
            showMessage('保存失败: ' + result.message, 'error');
          }
        } catch (error) {
          showMessage('保存AI配置失败: ' + error.message, 'error');
        }
      }

      // 测试AI连接
      async function testAIConnection() {
        const baseUrl = document.getElementById('aiBaseUrl').value;
        const apiKey = document.getElementById('aiApiKey').value;
        const model = document.getElementById('aiModel').value;

        if (!baseUrl || !model) {
          showMessage('请先填写API地址和模型名称', 'error');
          return;
        }

        try {
          showMessage('正在测试AI连接...', 'info');

          // 构建测试请求
          const testData = {
            model: model,
            messages: [{ role: 'user', content: '你好' }],
            stream: false,
          };

          const response = await fetch(baseUrl + '/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: apiKey && apiKey !== 'ollama' ? `Bearer ${apiKey}` : '',
            },
            body: JSON.stringify(testData),
          });

          if (response.ok) {
            const result = await response.json();
            if (result.choices && result.choices.length > 0) {
              showMessage('AI连接测试成功！', 'success');
            } else {
              showMessage('AI连接测试失败：响应格式错误', 'error');
            }
          } else {
            showMessage(`AI连接测试失败：HTTP ${response.status}`, 'error');
          }
        } catch (error) {
          showMessage('AI连接测试失败: ' + error.message, 'error');
        }
      }

      // 关键词输入处理
      document.getElementById('bossKeywords').addEventListener('input', function () {
        const text = this.textContent;
        const keywords = text
          .split(',')
          .map(k => k.trim())
          .filter(k => k);
        console.log('关键词:', keywords);
      });

      // 简历管理相关函数
      function uploadResume() {
        const fileInput = document.getElementById('resumeFile');
        const file = fileInput.files[0];

        if (!file) {
          showMessage('请选择要上传的简历文件', 'warning');
          return;
        }

        const formData = new FormData();
        formData.append('file', file);

        fetch('/candidate-resume/upload', {
          method: 'POST',
          body: formData,
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              showMessage('简历上传并解析成功', 'success');
              if (data.data && data.data.resumeText) {
                document.getElementById('resumeText').value = data.data.resumeText;
                updateResumeStats();
              }
            } else {
              showMessage('上传失败: ' + data.message, 'error');
            }
          })
          .catch(error => {
            console.error('上传失败:', error);
            showMessage('上传失败: ' + error.message, 'error');
          });
      }

      function parseResume() {
        const resumeText = document.getElementById('resumeText').value.trim();

        if (!resumeText) {
          showMessage('请先输入简历内容', 'warning');
          return;
        }

        fetch('/candidate-resume/parse', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ resumeText: resumeText }),
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              showMessage('简历解析成功', 'success');
              console.log('解析结果:', data.data);
            } else {
              showMessage('解析失败: ' + data.message, 'error');
            }
          })
          .catch(error => {
            console.error('解析失败:', error);
            showMessage('解析失败: ' + error.message, 'error');
          });
      }

      function generateDefaultGreeting() {
        const resumeText = document.getElementById('resumeText').value.trim();

        if (!resumeText) {
          showMessage('请先输入简历内容', 'warning');
          return;
        }

        // 这里需要先解析简历获取结构化数据
        fetch('/candidate-resume/parse', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ resumeText: resumeText }),
        })
          .then(response => response.json())
          .then(data => {
            if (data.success && data.data) {
              return fetch('/candidate-resume/generate-default-greeting', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({ candidate: data.data }),
              });
            } else {
              throw new Error('简历解析失败');
            }
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              showMessage('默认打招呼语生成成功', 'success');
              console.log('生成的打招呼语:', data.greeting);
            } else {
              showMessage('生成失败: ' + data.message, 'error');
            }
          })
          .catch(error => {
            console.error('生成失败:', error);
            showMessage('生成失败: ' + error.message, 'error');
          });
      }

      function clearResume() {
        document.getElementById('resumeText').value = '';
        document.getElementById('resumeFile').value = '';
        updateResumeStats();
        showMessage('简历内容已清空', 'info');
      }

      function updateResumeStats() {
        const textarea = document.getElementById('resumeText');
        const charCount = document.getElementById('resumeCharCount');
        const lineCount = document.getElementById('resumeLineCount');

        if (textarea && charCount && lineCount) {
          const text = textarea.value;
          charCount.textContent = text.length;
          lineCount.textContent = text.split('\n').length;
        }
      }
    </script>
  </body>
</html>
