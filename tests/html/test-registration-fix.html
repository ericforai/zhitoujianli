<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ³¨å†ŒåŠŸèƒ½ä¿®å¤æµ‹è¯•</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .test-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .test-result {
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }
      .success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .info {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background-color: #0056b3;
      }
      button:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
      }
      .test-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
        margin: 20px 0;
      }
      .test-item {
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ”§ æ³¨å†ŒåŠŸèƒ½ä¿®å¤æµ‹è¯•</h1>

    <div class="test-container">
      <h2>ğŸ“‹ ä¿®å¤å†…å®¹æ€»ç»“</h2>
      <div class="test-result info">
        <strong>ä¿®å¤çš„é—®é¢˜ï¼š</strong><br />
        1. âœ… æ··åˆå†…å®¹é”™è¯¯ï¼ˆMixed Content Errorï¼‰<br />
        2. âœ… ç¡¬ç¼–ç HTTPåœ°å€æ”¹ä¸ºç›¸å¯¹è·¯å¾„<br />
        3. âœ… ç¯å¢ƒé…ç½®ä¼˜åŒ–ï¼Œæ”¯æŒHTTPS<br />
        4. âœ… CookieåŸŸååŠ¨æ€è®¾ç½®<br />
        5. âœ… APIè°ƒç”¨è·¯å¾„ç»Ÿä¸€åŒ–
      </div>
    </div>

    <div class="test-container">
      <h2>ğŸ§ª ä¿®å¤éªŒè¯æµ‹è¯•</h2>
      <div class="test-grid">
        <div class="test-item">
          <h4>åè®®æ£€æŸ¥</h4>
          <p id="protocol-check">æ£€æŸ¥ä¸­...</p>
        </div>
        <div class="test-item">
          <h4>APIè·¯å¾„æ£€æŸ¥</h4>
          <p id="api-path-check">æ£€æŸ¥ä¸­...</p>
        </div>
        <div class="test-item">
          <h4>ç¯å¢ƒé…ç½®æ£€æŸ¥</h4>
          <p id="env-check">æ£€æŸ¥ä¸­...</p>
        </div>
        <div class="test-item">
          <h4>CookieåŸŸåæ£€æŸ¥</h4>
          <p id="cookie-check">æ£€æŸ¥ä¸­...</p>
        </div>
      </div>

      <div class="test-grid">
        <div class="test-item">
          <h4>å‘é€éªŒè¯ç API</h4>
          <button onclick="testSendCode()">æµ‹è¯•å‘é€éªŒè¯ç </button>
          <p id="send-code-result">æœªæµ‹è¯•</p>
        </div>
        <div class="test-item">
          <h4>éªŒè¯ç éªŒè¯API</h4>
          <button onclick="testVerifyCode()">æµ‹è¯•éªŒè¯ç éªŒè¯</button>
          <p id="verify-code-result">æœªæµ‹è¯•</p>
        </div>
        <div class="test-item">
          <h4>æ³¨å†ŒAPI</h4>
          <button onclick="testRegister()">æµ‹è¯•æ³¨å†Œ</button>
          <p id="register-result">æœªæµ‹è¯•</p>
        </div>
        <div class="test-item">
          <h4>å®Œæ•´æ³¨å†Œæµç¨‹</h4>
          <button onclick="testFullRegistration()">æµ‹è¯•å®Œæ•´æµç¨‹</button>
          <p id="full-registration-result">æœªæµ‹è¯•</p>
        </div>
      </div>
    </div>

    <div class="test-container">
      <h2>ğŸ“Š æµ‹è¯•ç»“æœ</h2>
      <div id="test-results">
        <div class="test-result info">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
      </div>
    </div>

    <script>
      // æµ‹è¯•æ•°æ®
      const testEmail = 'test@example.com';
      const testPassword = 'test123456';
      const testCode = '123456';

      // åˆå§‹åŒ–æ£€æŸ¥
      function initializeChecks() {
        // åè®®æ£€æŸ¥
        const protocol = window.location.protocol;
        const protocolElement = document.getElementById('protocol-check');
        if (protocol === 'https:') {
          protocolElement.innerHTML = 'âœ… HTTPS';
          protocolElement.className = 'success';
        } else {
          protocolElement.innerHTML = 'âš ï¸ HTTP (å¼€å‘ç¯å¢ƒ)';
          protocolElement.className = 'info';
        }

        // APIè·¯å¾„æ£€æŸ¥
        const apiPath = '/api/auth/send-verification-code';
        const apiPathElement = document.getElementById('api-path-check');
        if (apiPath.startsWith('/')) {
          apiPathElement.innerHTML = 'âœ… ç›¸å¯¹è·¯å¾„';
          apiPathElement.className = 'success';
        } else {
          apiPathElement.innerHTML = 'âŒ ç»å¯¹è·¯å¾„';
          apiPathElement.className = 'error';
        }

        // ç¯å¢ƒé…ç½®æ£€æŸ¥
        const envElement = document.getElementById('env-check');
        const hostname = window.location.hostname;
        if (hostname === 'zhitoujianli.com' || hostname === 'www.zhitoujianli.com') {
          envElement.innerHTML = 'âœ… ç”Ÿäº§ç¯å¢ƒ';
          envElement.className = 'success';
        } else if (hostname === 'localhost') {
          envElement.innerHTML = 'âœ… å¼€å‘ç¯å¢ƒ';
          envElement.className = 'info';
        } else {
          envElement.innerHTML = 'âš ï¸ æµ‹è¯•ç¯å¢ƒ';
          envElement.className = 'info';
        }

        // CookieåŸŸåæ£€æŸ¥
        const cookieElement = document.getElementById('cookie-check');
        const domain = hostname === 'localhost' ? 'localhost' : hostname;
        cookieElement.innerHTML = `âœ… ${domain}`;
        cookieElement.className = 'success';
      }

      // æµ‹è¯•å‘é€éªŒè¯ç 
      async function testSendCode() {
        const resultElement = document.getElementById('send-code-result');
        resultElement.innerHTML = 'æµ‹è¯•ä¸­...';
        resultElement.className = 'info';

        try {
          const response = await fetch('/api/auth/send-verification-code', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email: testEmail }),
          });

          const result = await response.json();

          if (response.ok) {
            resultElement.innerHTML = 'âœ… è¯·æ±‚æˆåŠŸ';
            resultElement.className = 'success';
            addTestResult('å‘é€éªŒè¯ç API', 'æˆåŠŸ', 'success');
          } else {
            resultElement.innerHTML = `âš ï¸ ${result.message || 'è¯·æ±‚å¤±è´¥'}`;
            resultElement.className = 'error';
            addTestResult('å‘é€éªŒè¯ç API', `å¤±è´¥: ${result.message}`, 'error');
          }
        } catch (error) {
          resultElement.innerHTML = `âŒ ç½‘ç»œé”™è¯¯: ${error.message}`;
          resultElement.className = 'error';
          addTestResult('å‘é€éªŒè¯ç API', `ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
        }
      }

      // æµ‹è¯•éªŒè¯ç éªŒè¯
      async function testVerifyCode() {
        const resultElement = document.getElementById('verify-code-result');
        resultElement.innerHTML = 'æµ‹è¯•ä¸­...';
        resultElement.className = 'info';

        try {
          const response = await fetch('/api/auth/verify-email-code', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              email: testEmail,
              code: testCode,
            }),
          });

          const result = await response.json();

          if (response.ok) {
            resultElement.innerHTML = 'âœ… è¯·æ±‚æˆåŠŸ';
            resultElement.className = 'success';
            addTestResult('éªŒè¯ç éªŒè¯API', 'æˆåŠŸ', 'success');
          } else {
            resultElement.innerHTML = `âš ï¸ ${result.message || 'è¯·æ±‚å¤±è´¥'}`;
            resultElement.className = 'error';
            addTestResult('éªŒè¯ç éªŒè¯API', `å¤±è´¥: ${result.message}`, 'error');
          }
        } catch (error) {
          resultElement.innerHTML = `âŒ ç½‘ç»œé”™è¯¯: ${error.message}`;
          resultElement.className = 'error';
          addTestResult('éªŒè¯ç éªŒè¯API', `ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
        }
      }

      // æµ‹è¯•æ³¨å†Œ
      async function testRegister() {
        const resultElement = document.getElementById('register-result');
        resultElement.innerHTML = 'æµ‹è¯•ä¸­...';
        resultElement.className = 'info';

        try {
          const response = await fetch('/api/auth/register', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              email: testEmail,
              password: testPassword,
            }),
          });

          const result = await response.json();

          if (response.ok) {
            resultElement.innerHTML = 'âœ… è¯·æ±‚æˆåŠŸ';
            resultElement.className = 'success';
            addTestResult('æ³¨å†ŒAPI', 'æˆåŠŸ', 'success');
          } else {
            resultElement.innerHTML = `âš ï¸ ${result.message || 'è¯·æ±‚å¤±è´¥'}`;
            resultElement.className = 'error';
            addTestResult('æ³¨å†ŒAPI', `å¤±è´¥: ${result.message}`, 'error');
          }
        } catch (error) {
          resultElement.innerHTML = `âŒ ç½‘ç»œé”™è¯¯: ${error.message}`;
          resultElement.className = 'error';
          addTestResult('æ³¨å†ŒAPI', `ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
        }
      }

      // æµ‹è¯•å®Œæ•´æ³¨å†Œæµç¨‹
      async function testFullRegistration() {
        const resultElement = document.getElementById('full-registration-result');
        resultElement.innerHTML = 'æµ‹è¯•ä¸­...';
        resultElement.className = 'info';

        try {
          // 1. å‘é€éªŒè¯ç 
          const sendCodeResponse = await fetch('/api/auth/send-verification-code', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: testEmail }),
          });

          if (!sendCodeResponse.ok) {
            throw new Error('å‘é€éªŒè¯ç å¤±è´¥');
          }

          // 2. éªŒè¯éªŒè¯ç ï¼ˆæ¨¡æ‹Ÿï¼‰
          const verifyResponse = await fetch('/api/auth/verify-email-code', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              email: testEmail,
              code: testCode,
            }),
          });

          if (!verifyResponse.ok) {
            throw new Error('éªŒè¯ç éªŒè¯å¤±è´¥');
          }

          // 3. æ³¨å†Œ
          const registerResponse = await fetch('/api/auth/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              email: testEmail,
              password: testPassword,
            }),
          });

          if (!registerResponse.ok) {
            throw new Error('æ³¨å†Œå¤±è´¥');
          }

          resultElement.innerHTML = 'âœ… å®Œæ•´æµç¨‹æˆåŠŸ';
          resultElement.className = 'success';
          addTestResult('å®Œæ•´æ³¨å†Œæµç¨‹', 'æˆåŠŸ', 'success');
        } catch (error) {
          resultElement.innerHTML = `âŒ ${error.message}`;
          resultElement.className = 'error';
          addTestResult('å®Œæ•´æ³¨å†Œæµç¨‹', `å¤±è´¥: ${error.message}`, 'error');
        }
      }

      // æ·»åŠ æµ‹è¯•ç»“æœ
      function addTestResult(testName, result, type) {
        const resultsContainer = document.getElementById('test-results');
        const resultDiv = document.createElement('div');
        resultDiv.className = `test-result ${type}`;
        resultDiv.innerHTML = `<strong>${testName}:</strong> ${result}`;
        resultsContainer.appendChild(resultDiv);
      }

      // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
      window.addEventListener('load', initializeChecks);
    </script>
  </body>
</html>
