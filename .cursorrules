# ============================================================
# 智投简历项目 - Cursor AI 工作规则
# 每次打开项目时，AI必须遵守以下规则
# ============================================================

## 🚨 部署规则（最高优先级）

### 前端部署 - 绝对禁止手动操作

**❌ 永远不要执行以下操作：**
```bash
# ❌ 禁止！会部署到错误路径
cp build/* /usr/share/nginx/html/

# ❌ 禁止！会部署到错误路径
cp -r build /usr/share/nginx/html/
```

**✅ 必须使用自动化脚本：**
```bash
# ✅ 正确方式（在项目根目录）
./deploy-frontend.sh

# 或者完整路径
/opt/zhitoujianli/scripts/build-and-deploy-frontend.sh
```

**部署流程检查清单：**
1. 修改前端代码
2. 执行 `./deploy-frontend.sh`（自动构建+部署）
3. 等待脚本完成
4. 提醒用户清除浏览器缓存（Ctrl + Shift + R）
5. 验证部署成功

### 后端部署规则

**部署流程：**
1. 修改后端代码
2. 执行 Maven 构建：`cd backend/get_jobs && mvn clean package -DskipTests`
3. 复制 JAR：`cp target/get_jobs-*.jar /opt/zhitoujianli/backend/get_jobs-vX.X.X.jar`
4. 更新符号链接：`ln -sf /opt/zhitoujianli/backend/get_jobs-vX.X.X.jar /opt/zhitoujianli/backend/get_jobs-latest.jar`
5. 执行 `systemctl daemon-reload`（如果修改了systemd配置）
6. 重启服务：`systemctl restart zhitoujianli-backend.service`
7. 验证：`systemctl status zhitoujianli-backend.service`

### 重要路径（必须记住）

```yaml
前端唯一源代码: /root/zhitoujianli/frontend/  # ← v3.0.0后唯一官方源代码
前端构建源: /root/zhitoujianli/frontend/build/
前端部署路径: /var/www/zhitoujianli/build/  # ← Nginx配置的路径
后端JAR路径: /opt/zhitoujianli/backend/
环境变量文件: /etc/zhitoujianli/backend.env
部署脚本: /opt/zhitoujianli/scripts/
```

## 🔧 开发规则

### 代码修改后的标准流程

**前端修改：**
```bash
# 1. 修改代码
# 2. 部署
cd /root/zhitoujianli
./deploy-frontend.sh

# 3. 提醒用户清除缓存
```

**后端修改：**
```bash
# 1. 修改代码
# 2. 构建
cd /root/zhitoujianli/backend/get_jobs
mvn clean package -DskipTests

# 3. 部署（使用自动化脚本）
# TODO: 创建后端部署脚本
```

## 🚫 绝对禁止的操作

1. **❌ 禁止手动复制文件到 /usr/share/nginx/html/**
2. **❌ 禁止在systemd配置中硬编码敏感信息**
3. **❌ 禁止使用 default_user 进行任何操作**
4. **❌ 禁止跳过 systemctl daemon-reload**
5. **❌ 禁止在未验证的情况下重启生产服务**

## ✅ 必须执行的检查

### 每次部署前：
- [ ] 确认使用自动化脚本
- [ ] 检查目标路径正确
- [ ] 验证服务运行状态
- [ ] 备份已完成（脚本自动）

### 每次部署后：
- [ ] 验证文件存在于正确路径
- [ ] 测试API响应
- [ ] 检查服务日志无错误
- [ ] 提醒用户清除浏览器缓存

## 📝 问题排查优先级

1. **二维码不显示** → 检查前端是否部署到正确路径
2. **401错误** → 检查JWT Token是否携带
3. **500错误** → 检查后端日志
4. **服务崩溃** → 检查端口占用、环境变量

## 🎯 AI行为准则

**当用户说"部署前端"时，我必须：**
1. 执行 `./deploy-frontend.sh`
2. **不是**手动复制文件
3. **不是**询问用户路径
4. 自动化脚本会处理一切

**当用户报告"二维码不显示"时，我必须：**
1. 首先检查前端部署路径是否正确
2. 验证 `/var/www/zhitoujianli/build/` 是否有最新文件
3. 提醒用户清除浏览器缓存

**当后端服务崩溃时，我必须：**
1. 检查 `systemctl status zhitoujianli-backend.service`
2. 查看日志 `journalctl -u zhitoujianli-backend.service -n 50`
3. 检查端口占用 `lsof -i:8080`
4. 验证环境变量文件存在

## 📚 参考文档

- 部署指南: `/opt/zhitoujianli/docs/DEPLOYMENT_GUIDE.md`
- 快速参考: `/root/zhitoujianli/README_DEPLOYMENT.md`
- 修复总结: `/opt/zhitoujianli/docs/FIX_SUMMARY_20251102.txt`

## 🔄 版本管理

**当前版本：**
- 前端：v3.0.0（main.66e9065f.js，152.71 kB gzip）
- 后端：v2.1.1（包含用户隔离修复）

**部署记录：**
- 所有部署自动记录到 `/opt/zhitoujianli/logs/deploy-frontend.log`

---

## 🚨 v3.0.0 关键教训（永久记住！）

### ❌ 绝对禁止的前端操作

**禁止创建任何其他前端目录：**
```bash
❌ 禁止：mkdir frontend2
❌ 禁止：mkdir frontend_new
❌ 禁止：mkdir frontend_FINAL
❌ 禁止：mkdir website
❌ 禁止：在任何website/目录下开发前端
```

**禁止创建DEPRECATED标记文件：**
```bash
❌ 禁止：创建任何DEPRECATED.md文件
❌ 如果看到DEPRECATED.md → 立即质疑并验证
```

**禁止修改部署脚本指向其他目录：**
```bash
❌ deploy-frontend.sh 必须永远指向：frontend/build
❌ 不允许指向：website/、frontend_FINAL/、或任何其他目录
```

### ✅ 唯一正确的前端规则（v3.0.0后）

**唯一源代码位置：**
```bash
✅ 唯一正确：/root/zhitoujianli/frontend/
✅ 没有例外
✅ 没有其他选择
```

**唯一构建命令：**
```bash
cd /root/zhitoujianli/frontend && npm run build
```

**唯一部署命令：**
```bash
/opt/zhitoujianli/scripts/deploy-frontend.sh
```

### 🔍 前端混乱问题的根源（已解决但永不忘记）

**历史教训（v3.0.0之前的混乱）：**

1. **自相矛盾的DEPRECATED.md文件**
   - frontend/DEPRECATED.md说"用website"
   - website/DEPRECATED.md说"用frontend"
   - 导致AI陷入无限循环，版本反复切换

2. **多个前端目录共存**
   - frontend/、website/、frontend_FINAL/、build/
   - 不知道哪个是官方源代码
   - 部署时容易选错

3. **部署脚本指向混乱**
   - 脚本指向frontend_FINAL/build（不存在完整代码）
   - 导致部署失败或部署错误版本

4. **缺少明确的单一源代码规则**
   - 没有文档说明哪个是官方目录
   - 开发者和AI都困惑

**v3.0.0解决方案：**
- ✅ 彻底删除website/、frontend_FINAL/、build/
- ✅ 删除所有DEPRECATED.md文件
- ✅ 锁定部署脚本指向frontend/build
- ✅ 创建清晰的README文档
- ✅ 建立永久记忆和规则

### 🛡️ 防护措施（永不再犯）

**AI必须遵守的铁律：**

1. **看到多个前端目录 → 立即警告用户**
   - 只允许存在：frontend/ 和 PRODUCTION_FRONTEND/（备份）
   - 任何其他前端目录都是错误的

2. **看到DEPRECATED.md → 立即质疑**
   - v3.0.0后不应该有任何DEPRECATED文件
   - 如果出现，必须验证是否正确

3. **修改部署脚本前 → 必须确认**
   - deploy-frontend.sh的BUILD_SOURCE必须是frontend/build
   - 不允许指向其他任何路径

4. **创建前端目录前 → 必须拒绝**
   - 前端只有一个官方目录：frontend/
   - 任何创建新前端目录的请求都应该被质疑

**验证命令（AI应定期执行）：**
```bash
# 验证只有2个前端目录
ls -ld /root/zhitoujianli/frontend* /root/zhitoujianli/PRODUCTION_FRONTEND 2>/dev/null | wc -l
# 应该输出：2

# 验证部署脚本正确
grep "BUILD_SOURCE=" /opt/zhitoujianli/scripts/deploy-frontend.sh
# 应该输出：BUILD_SOURCE="/root/zhitoujianli/frontend/build"

# 验证没有DEPRECATED文件
find /root/zhitoujianli -name "DEPRECATED.md" 2>/dev/null
# 应该输出：空（没有结果）
```

---

## 📖 v3.0.0 快速参考

**前端开发的唯一正确流程：**

```bash
# 1. 进入源代码目录
cd /root/zhitoujianli/frontend/

# 2. 修改代码
vi src/components/XXX.tsx

# 3. 构建+部署（一条命令）
cd /root/zhitoujianli && ./deploy-frontend.sh

# 4. 提醒用户清除浏览器缓存
echo "请按 Ctrl + Shift + R 清除缓存"
```

**如果用户说"前端又乱了"：**

1. 检查是否有多个前端目录
2. 检查部署脚本指向是否正确
3. 查看是否有DEPRECATED文件
4. 参考本规则文件恢复正确状态

---

**🤖 AI提醒：每次执行操作前，先检查这个文件！**

**🚨 v3.0.0后的铁律：frontend/是唯一源代码，没有任何例外！**

