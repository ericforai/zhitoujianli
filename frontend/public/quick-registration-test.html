<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ³¨å†ŒåŠŸèƒ½å¿«é€Ÿæµ‹è¯•</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border-radius: 4px;
      }
      .success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .info {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 4px;
        cursor: pointer;
        margin: 10px 5px;
        font-size: 16px;
      }
      button:hover {
        background-color: #0056b3;
      }
      button:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
      }
      input {
        width: 100%;
        padding: 10px;
        margin: 5px 0;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
      }
      .result {
        margin-top: 10px;
        padding: 10px;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ§ª æ³¨å†ŒåŠŸèƒ½å¿«é€Ÿæµ‹è¯•</h1>
      
      <div class="test-section info">
        <h3>ğŸ“‹ æµ‹è¯•è¯´æ˜</h3>
        <p>è¿™ä¸ªé¡µé¢ç”¨äºå¿«é€Ÿæµ‹è¯•æ³¨å†ŒåŠŸèƒ½çš„APIè°ƒç”¨ï¼Œå¸®åŠ©è¯Šæ–­æ··åˆå†…å®¹é”™è¯¯é—®é¢˜ã€‚</p>
      </div>

      <div class="test-section">
        <h3>ğŸ” ç¯å¢ƒæ£€æŸ¥</h3>
        <div id="env-check" class="result info">æ£€æŸ¥ä¸­...</div>
      </div>

      <div class="test-section">
        <h3>ğŸ“§ å‘é€éªŒè¯ç æµ‹è¯•</h3>
        <input
          type="email"
          id="email-input"
          placeholder="è¾“å…¥æµ‹è¯•é‚®ç®±åœ°å€"
          value="test@example.com"
        />
        <br />
        <button onclick="testSendCode()">å‘é€éªŒè¯ç </button>
        <div id="send-result" class="result"></div>
      </div>

      <div class="test-section">
        <h3>ğŸ”— æ³¨å†Œé¡µé¢æµ‹è¯•</h3>
        <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è®¿é—®å®é™…çš„æ³¨å†Œé¡µé¢ï¼š</p>
        <button onclick="openRegistrationPage()">æ‰“å¼€æ³¨å†Œé¡µé¢</button>
        <div id="page-result" class="result"></div>
      </div>

      <div class="test-section">
        <h3>ğŸ“Š æµ‹è¯•ç»“æœæ±‡æ€»</h3>
        <div id="summary-result" class="result info">ç­‰å¾…æµ‹è¯•...</div>
      </div>
    </div>

    <script>
      // ç¯å¢ƒæ£€æŸ¥
      function checkEnvironment() {
        const envCheck = document.getElementById('env-check');
        const protocol = window.location.protocol;
        const hostname = window.location.hostname;
        
        let status = '';
        let className = '';
        
        if (protocol === 'https:') {
          status = `âœ… HTTPSç¯å¢ƒæ­£å¸¸<br>åŸŸå: ${hostname}<br>åè®®: ${protocol}`;
          className = 'success';
        } else {
          status = `âŒ HTTPç¯å¢ƒï¼Œå¯èƒ½å­˜åœ¨æ··åˆå†…å®¹é—®é¢˜<br>åŸŸå: ${hostname}<br>åè®®: ${protocol}`;
          className = 'error';
        }
        
        envCheck.innerHTML = status;
        envCheck.className = `result ${className}`;
      }

      // æµ‹è¯•å‘é€éªŒè¯ç 
      async function testSendCode() {
        const email = document.getElementById('email-input').value;
        const resultDiv = document.getElementById('send-result');
        const button = event.target;
        
        if (!email) {
          resultDiv.innerHTML = 'âŒ è¯·è¾“å…¥é‚®ç®±åœ°å€';
          resultDiv.className = 'result error';
          return;
        }

        button.disabled = true;
        button.textContent = 'å‘é€ä¸­...';
        resultDiv.innerHTML = 'ğŸ”„ æ­£åœ¨å‘é€éªŒè¯ç ...';
        resultDiv.className = 'result info';

        try {
          const response = await fetch('/api/auth/send-verification-code', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email: email }),
          });

          const result = await response.json();

          if (response.ok) {
            resultDiv.innerHTML = `âœ… éªŒè¯ç å‘é€æˆåŠŸï¼<br>é‚®ç®±: ${email}<br>å“åº”: ${JSON.stringify(result)}`;
            resultDiv.className = 'result success';
            updateSummary('send-code', true);
          } else {
            resultDiv.innerHTML = `âš ï¸ éªŒè¯ç å‘é€å¤±è´¥<br>çŠ¶æ€ç : ${response.status}<br>é”™è¯¯: ${result.message || 'æœªçŸ¥é”™è¯¯'}`;
            resultDiv.className = 'result error';
            updateSummary('send-code', false);
          }
        } catch (error) {
          resultDiv.innerHTML = `âŒ ç½‘ç»œé”™è¯¯<br>é”™è¯¯ä¿¡æ¯: ${error.message}<br>å¯èƒ½åŸå› : æ··åˆå†…å®¹é”™è¯¯æˆ–APIä¸å¯ç”¨`;
          resultDiv.className = 'result error';
          updateSummary('send-code', false);
        } finally {
          button.disabled = false;
          button.textContent = 'å‘é€éªŒè¯ç ';
        }
      }

      // æ‰“å¼€æ³¨å†Œé¡µé¢
      function openRegistrationPage() {
        const resultDiv = document.getElementById('page-result');
        resultDiv.innerHTML = 'ğŸ”„ æ­£åœ¨æ‰“å¼€æ³¨å†Œé¡µé¢...';
        resultDiv.className = 'result info';

        try {
          window.open('/register', '_blank');
          resultDiv.innerHTML = 'âœ… æ³¨å†Œé¡µé¢å·²åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€';
          resultDiv.className = 'result success';
          updateSummary('page-access', true);
        } catch (error) {
          resultDiv.innerHTML = `âŒ æ— æ³•æ‰“å¼€æ³¨å†Œé¡µé¢<br>é”™è¯¯: ${error.message}`;
          resultDiv.className = 'result error';
          updateSummary('page-access', false);
        }
      }

      // æ›´æ–°æµ‹è¯•ç»“æœæ±‡æ€»
      const testResults = {};
      
      function updateSummary(testName, success) {
        testResults[testName] = success;
        updateSummaryDisplay();
      }

      function updateSummaryDisplay() {
        const summaryDiv = document.getElementById('summary-result');
        const totalTests = Object.keys(testResults).length;
        const passedTests = Object.values(testResults).filter(Boolean).length;
        
        if (totalTests === 0) {
          summaryDiv.innerHTML = 'ç­‰å¾…æµ‹è¯•...';
          summaryDiv.className = 'result info';
          return;
        }

        const percentage = Math.round((passedTests / totalTests) * 100);
        let status = '';
        let className = '';

        if (percentage === 100) {
          status = `ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ (${passedTests}/${totalTests})`;
          className = 'success';
        } else if (percentage >= 50) {
          status = `âš ï¸ éƒ¨åˆ†æµ‹è¯•é€šè¿‡ (${passedTests}/${totalTests} - ${percentage}%)`;
          className = 'info';
        } else {
          status = `âŒ å¤§éƒ¨åˆ†æµ‹è¯•å¤±è´¥ (${passedTests}/${totalTests} - ${percentage}%)`;
          className = 'error';
        }

        summaryDiv.innerHTML = status;
        summaryDiv.className = `result ${className}`;
      }

      // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥ç¯å¢ƒ
      window.addEventListener('load', () => {
        checkEnvironment();
        updateSummaryDisplay();
      });
    </script>
  </body>
</html>
