<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mixed Content 修复验证测试</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .test-section {
        background: white;
        padding: 20px;
        margin: 20px 0;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .success {
        color: #28a745;
      }
      .error {
        color: #dc3545;
      }
      .warning {
        color: #ffc107;
      }
      .info {
        color: #17a2b8;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }
      .log {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 10px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <h1>🔧 Mixed Content 修复验证测试</h1>

    <div class="test-section">
      <h2>📋 测试环境信息</h2>
      <div id="env-info"></div>
    </div>

    <div class="test-section">
      <h2>🔍 API URL 配置测试</h2>
      <button onclick="testApiConfig()">测试 API 配置</button>
      <div id="api-config-result"></div>
    </div>

    <div class="test-section">
      <h2>📡 发送验证码请求测试</h2>
      <input
        type="email"
        id="test-email"
        placeholder="输入测试邮箱"
        value="test@example.com"
        style="width: 200px; padding: 8px; margin-right: 10px"
      />
      <button onclick="testSendVerificationCode()">测试发送验证码</button>
      <div id="send-code-result"></div>
    </div>

    <div class="test-section">
      <h2>📊 测试日志</h2>
      <button onclick="clearLog()">清空日志</button>
      <div id="test-log" class="log"></div>
    </div>

    <script>
      // 日志功能
      function log(message, type = 'info') {
        const logDiv = document.getElementById('test-log');
        const timestamp = new Date().toLocaleTimeString();
        const className =
          type === 'error'
            ? 'error'
            : type === 'success'
              ? 'success'
              : type === 'warning'
                ? 'warning'
                : 'info';
        logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      function clearLog() {
        document.getElementById('test-log').innerHTML = '';
      }

      // 获取环境信息
      function getEnvironmentInfo() {
        const info = {
          protocol: window.location.protocol,
          hostname: window.location.hostname,
          port: window.location.port,
          userAgent: navigator.userAgent,
          isSecure: window.location.protocol === 'https:',
          productionConfig: window.__PRODUCTION_CONFIG__ || '未定义',
        };
        return info;
      }

      // 显示环境信息
      function displayEnvironmentInfo() {
        const info = getEnvironmentInfo();
        const envDiv = document.getElementById('env-info');

        let html = '<ul>';
        for (const [key, value] of Object.entries(info)) {
          const className =
            key === 'isSecure' ? (value ? 'success' : 'warning') : 'info';
          html += `<li><strong>${key}:</strong> <span class="${className}">${value}</span></li>`;
        }
        html += '</ul>';

        envDiv.innerHTML = html;
        log('环境信息已加载', 'info');
      }

      // 测试 API 配置
      function testApiConfig() {
        log('开始测试 API 配置...', 'info');

        try {
          const getApiBaseUrl = () => {
            // 1. 优先使用生产环境配置
            const config = window.__PRODUCTION_CONFIG__;
            if (config?.API_BASE_URL) {
              return config.API_BASE_URL;
            }

            // 2. 使用环境变量（在浏览器中通常不可用）
            if (
              typeof process !== 'undefined' &&
              process.env?.REACT_APP_API_URL
            ) {
              return process.env.REACT_APP_API_URL;
            }

            // 3. 根据当前环境自动判断
            const isProduction =
              window.location.hostname === 'zhitoujianli.com' ||
              window.location.hostname === 'www.zhitoujianli.com';

            if (isProduction) {
              return 'https://zhitoujianli.com/api';
            } else {
              return '/api'; // 开发环境使用相对路径
            }
          };

          const baseURL = getApiBaseUrl();
          const apiUrl = `${baseURL}/auth/send-verification-code`;

          const resultDiv = document.getElementById('api-config-result');

          let resultHtml = '<div>';
          resultHtml += `<p><strong>检测到的 API 基础 URL:</strong> <span class="info">${baseURL}</span></p>`;
          resultHtml += `<p><strong>完整的验证码请求 URL:</strong> <span class="info">${apiUrl}</span></p>`;

          // 检查是否为 HTTPS
          if (apiUrl.startsWith('https://')) {
            resultHtml += `<p><span class="success">✅ 使用 HTTPS 协议，安全</span></p>`;
            log('API 配置检查通过：使用 HTTPS', 'success');
          } else if (apiUrl.startsWith('/api')) {
            resultHtml += `<p><span class="info">ℹ️ 使用相对路径，由代理处理</span></p>`;
            log('API 配置检查通过：使用相对路径', 'info');
          } else if (apiUrl.startsWith('http://')) {
            resultHtml += `<p><span class="error">❌ 使用 HTTP 协议，可能触发 Mixed Content 错误</span></p>`;
            log('API 配置检查失败：使用 HTTP', 'error');
          } else {
            resultHtml += `<p><span class="warning">⚠️ 未知协议</span></p>`;
            log('API 配置检查：未知协议', 'warning');
          }

          resultHtml += '</div>';
          resultDiv.innerHTML = resultHtml;
        } catch (error) {
          log(`API 配置测试失败: ${error.message}`, 'error');
          document.getElementById('api-config-result').innerHTML =
            `<p class="error">❌ 测试失败: ${error.message}</p>`;
        }
      }

      // 测试发送验证码
      async function testSendVerificationCode() {
        const email = document.getElementById('test-email').value;
        if (!email) {
          log('请输入测试邮箱', 'warning');
          return;
        }

        log(`开始测试发送验证码到: ${email}`, 'info');

        try {
          const getApiBaseUrl = () => {
            const config = window.__PRODUCTION_CONFIG__;
            if (config?.API_BASE_URL) {
              return config.API_BASE_URL;
            }

            const isProduction =
              window.location.hostname === 'zhitoujianli.com' ||
              window.location.hostname === 'www.zhitoujianli.com';

            if (isProduction) {
              return 'https://zhitoujianli.com/api';
            } else {
              return '/api';
            }
          };

          const baseURL = getApiBaseUrl();
          const apiUrl = `${baseURL}/auth/send-verification-code`;

          log(`发送请求到: ${apiUrl}`, 'info');

          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email }),
          });

          log(
            `响应状态: ${response.status} ${response.statusText}`,
            response.ok ? 'success' : 'error'
          );

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const result = await response.json();
          log(`响应数据: ${JSON.stringify(result)}`, 'info');

          const resultDiv = document.getElementById('send-code-result');
          if (result.success) {
            resultDiv.innerHTML = '<p class="success">✅ 验证码发送成功</p>';
            log('验证码发送测试成功', 'success');
          } else {
            resultDiv.innerHTML = `<p class="warning">⚠️ ${result.message || '发送失败'}</p>`;
            log(`验证码发送测试失败: ${result.message}`, 'warning');
          }
        } catch (error) {
          log(`发送验证码测试失败: ${error.message}`, 'error');

          const resultDiv = document.getElementById('send-code-result');
          let errorMessage = error.message;

          if (error.message.includes('Mixed Content')) {
            errorMessage = 'Mixed Content 错误：HTTP/HTTPS 协议冲突';
            resultDiv.innerHTML = '<p class="error">❌ Mixed Content 错误</p>';
          } else if (error.message.includes('Failed to fetch')) {
            errorMessage = '网络连接失败';
            resultDiv.innerHTML = '<p class="error">❌ 网络连接失败</p>';
          } else {
            resultDiv.innerHTML = `<p class="error">❌ ${errorMessage}</p>`;
          }
        }
      }

      // 页面加载时自动显示环境信息
      window.addEventListener('load', function () {
        displayEnvironmentInfo();
        log('Mixed Content 修复验证测试页面已加载', 'info');
      });
    </script>
  </body>
</html>
