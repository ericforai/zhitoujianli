<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mixed Content ä¿®å¤éªŒè¯æµ‹è¯•</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .test-section {
        background: white;
        padding: 20px;
        margin: 20px 0;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .success {
        color: #28a745;
      }
      .error {
        color: #dc3545;
      }
      .warning {
        color: #ffc107;
      }
      .info {
        color: #17a2b8;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }
      .log {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 10px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ”§ Mixed Content ä¿®å¤éªŒè¯æµ‹è¯•</h1>

    <div class="test-section">
      <h2>ğŸ“‹ æµ‹è¯•ç¯å¢ƒä¿¡æ¯</h2>
      <div id="env-info"></div>
    </div>

    <div class="test-section">
      <h2>ğŸ” API URL é…ç½®æµ‹è¯•</h2>
      <button onclick="testApiConfig()">æµ‹è¯• API é…ç½®</button>
      <div id="api-config-result"></div>
    </div>

    <div class="test-section">
      <h2>ğŸ“¡ å‘é€éªŒè¯ç è¯·æ±‚æµ‹è¯•</h2>
      <input
        type="email"
        id="test-email"
        placeholder="è¾“å…¥æµ‹è¯•é‚®ç®±"
        value="test@example.com"
        style="width: 200px; padding: 8px; margin-right: 10px"
      />
      <button onclick="testSendVerificationCode()">æµ‹è¯•å‘é€éªŒè¯ç </button>
      <div id="send-code-result"></div>
    </div>

    <div class="test-section">
      <h2>ğŸ“Š æµ‹è¯•æ—¥å¿—</h2>
      <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
      <div id="test-log" class="log"></div>
    </div>

    <script>
      // æ—¥å¿—åŠŸèƒ½
      function log(message, type = 'info') {
        const logDiv = document.getElementById('test-log');
        const timestamp = new Date().toLocaleTimeString();
        const className =
          type === 'error'
            ? 'error'
            : type === 'success'
              ? 'success'
              : type === 'warning'
                ? 'warning'
                : 'info';
        logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      function clearLog() {
        document.getElementById('test-log').innerHTML = '';
      }

      // è·å–ç¯å¢ƒä¿¡æ¯
      function getEnvironmentInfo() {
        const info = {
          protocol: window.location.protocol,
          hostname: window.location.hostname,
          port: window.location.port,
          userAgent: navigator.userAgent,
          isSecure: window.location.protocol === 'https:',
          productionConfig: window.__PRODUCTION_CONFIG__ || 'æœªå®šä¹‰',
        };
        return info;
      }

      // æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
      function displayEnvironmentInfo() {
        const info = getEnvironmentInfo();
        const envDiv = document.getElementById('env-info');

        let html = '<ul>';
        for (const [key, value] of Object.entries(info)) {
          const className =
            key === 'isSecure' ? (value ? 'success' : 'warning') : 'info';
          html += `<li><strong>${key}:</strong> <span class="${className}">${value}</span></li>`;
        }
        html += '</ul>';

        envDiv.innerHTML = html;
        log('ç¯å¢ƒä¿¡æ¯å·²åŠ è½½', 'info');
      }

      // æµ‹è¯• API é…ç½®
      function testApiConfig() {
        log('å¼€å§‹æµ‹è¯• API é…ç½®...', 'info');

        try {
          const getApiBaseUrl = () => {
            // 1. ä¼˜å…ˆä½¿ç”¨ç”Ÿäº§ç¯å¢ƒé…ç½®
            const config = window.__PRODUCTION_CONFIG__;
            if (config?.API_BASE_URL) {
              return config.API_BASE_URL;
            }

            // 2. ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼ˆåœ¨æµè§ˆå™¨ä¸­é€šå¸¸ä¸å¯ç”¨ï¼‰
            if (
              typeof process !== 'undefined' &&
              process.env?.REACT_APP_API_URL
            ) {
              return process.env.REACT_APP_API_URL;
            }

            // 3. æ ¹æ®å½“å‰ç¯å¢ƒè‡ªåŠ¨åˆ¤æ–­
            const isProduction =
              window.location.hostname === 'zhitoujianli.com' ||
              window.location.hostname === 'www.zhitoujianli.com';

            if (isProduction) {
              return 'https://zhitoujianli.com/api';
            } else {
              return '/api'; // å¼€å‘ç¯å¢ƒä½¿ç”¨ç›¸å¯¹è·¯å¾„
            }
          };

          const baseURL = getApiBaseUrl();
          const apiUrl = `${baseURL}/auth/send-verification-code`;

          const resultDiv = document.getElementById('api-config-result');

          let resultHtml = '<div>';
          resultHtml += `<p><strong>æ£€æµ‹åˆ°çš„ API åŸºç¡€ URL:</strong> <span class="info">${baseURL}</span></p>`;
          resultHtml += `<p><strong>å®Œæ•´çš„éªŒè¯ç è¯·æ±‚ URL:</strong> <span class="info">${apiUrl}</span></p>`;

          // æ£€æŸ¥æ˜¯å¦ä¸º HTTPS
          if (apiUrl.startsWith('https://')) {
            resultHtml += `<p><span class="success">âœ… ä½¿ç”¨ HTTPS åè®®ï¼Œå®‰å…¨</span></p>`;
            log('API é…ç½®æ£€æŸ¥é€šè¿‡ï¼šä½¿ç”¨ HTTPS', 'success');
          } else if (apiUrl.startsWith('/api')) {
            resultHtml += `<p><span class="info">â„¹ï¸ ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œç”±ä»£ç†å¤„ç†</span></p>`;
            log('API é…ç½®æ£€æŸ¥é€šè¿‡ï¼šä½¿ç”¨ç›¸å¯¹è·¯å¾„', 'info');
          } else if (apiUrl.startsWith('http://')) {
            resultHtml += `<p><span class="error">âŒ ä½¿ç”¨ HTTP åè®®ï¼Œå¯èƒ½è§¦å‘ Mixed Content é”™è¯¯</span></p>`;
            log('API é…ç½®æ£€æŸ¥å¤±è´¥ï¼šä½¿ç”¨ HTTP', 'error');
          } else {
            resultHtml += `<p><span class="warning">âš ï¸ æœªçŸ¥åè®®</span></p>`;
            log('API é…ç½®æ£€æŸ¥ï¼šæœªçŸ¥åè®®', 'warning');
          }

          resultHtml += '</div>';
          resultDiv.innerHTML = resultHtml;
        } catch (error) {
          log(`API é…ç½®æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
          document.getElementById('api-config-result').innerHTML =
            `<p class="error">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</p>`;
        }
      }

      // æµ‹è¯•å‘é€éªŒè¯ç 
      async function testSendVerificationCode() {
        const email = document.getElementById('test-email').value;
        if (!email) {
          log('è¯·è¾“å…¥æµ‹è¯•é‚®ç®±', 'warning');
          return;
        }

        log(`å¼€å§‹æµ‹è¯•å‘é€éªŒè¯ç åˆ°: ${email}`, 'info');

        try {
          const getApiBaseUrl = () => {
            const config = window.__PRODUCTION_CONFIG__;
            if (config?.API_BASE_URL) {
              return config.API_BASE_URL;
            }

            const isProduction =
              window.location.hostname === 'zhitoujianli.com' ||
              window.location.hostname === 'www.zhitoujianli.com';

            if (isProduction) {
              return 'https://zhitoujianli.com/api';
            } else {
              return '/api';
            }
          };

          const baseURL = getApiBaseUrl();
          const apiUrl = `${baseURL}/auth/send-verification-code`;

          log(`å‘é€è¯·æ±‚åˆ°: ${apiUrl}`, 'info');

          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email }),
          });

          log(
            `å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`,
            response.ok ? 'success' : 'error'
          );

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const result = await response.json();
          log(`å“åº”æ•°æ®: ${JSON.stringify(result)}`, 'info');

          const resultDiv = document.getElementById('send-code-result');
          if (result.success) {
            resultDiv.innerHTML = '<p class="success">âœ… éªŒè¯ç å‘é€æˆåŠŸ</p>';
            log('éªŒè¯ç å‘é€æµ‹è¯•æˆåŠŸ', 'success');
          } else {
            resultDiv.innerHTML = `<p class="warning">âš ï¸ ${result.message || 'å‘é€å¤±è´¥'}</p>`;
            log(`éªŒè¯ç å‘é€æµ‹è¯•å¤±è´¥: ${result.message}`, 'warning');
          }
        } catch (error) {
          log(`å‘é€éªŒè¯ç æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');

          const resultDiv = document.getElementById('send-code-result');
          let errorMessage = error.message;

          if (error.message.includes('Mixed Content')) {
            errorMessage = 'Mixed Content é”™è¯¯ï¼šHTTP/HTTPS åè®®å†²çª';
            resultDiv.innerHTML = '<p class="error">âŒ Mixed Content é”™è¯¯</p>';
          } else if (error.message.includes('Failed to fetch')) {
            errorMessage = 'ç½‘ç»œè¿æ¥å¤±è´¥';
            resultDiv.innerHTML = '<p class="error">âŒ ç½‘ç»œè¿æ¥å¤±è´¥</p>';
          } else {
            resultDiv.innerHTML = `<p class="error">âŒ ${errorMessage}</p>`;
          }
        }
      }

      // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
      window.addEventListener('load', function () {
        displayEnvironmentInfo();
        log('Mixed Content ä¿®å¤éªŒè¯æµ‹è¯•é¡µé¢å·²åŠ è½½', 'info');
      });
    </script>
  </body>
</html>
