name: Pull Requestæ£€æŸ¥

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # PRåŸºç¡€æ£€æŸ¥
  pr-checks:
    name: PRåŸºç¡€æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: æ£€æŸ¥PRæ ‡é¢˜æ ¼å¼
      uses: amannn/action-semantic-pull-request@v5
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        types: |
          feat
          fix
          docs
          style
          refactor
          perf
          test
          build
          ci
          chore
          revert
          security
          config
          deps
          release
        requireScope: false

    - name: æ£€æŸ¥æäº¤ä¿¡æ¯æ ¼å¼
      uses: wagoid/commitlint-github-action@v5
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: æ£€æŸ¥PRå¤§å°
      run: |
        CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | wc -l)
        echo "å˜æ›´æ–‡ä»¶æ•°é‡: $CHANGED_FILES"

        if [ $CHANGED_FILES -gt 50 ]; then
          echo "âš ï¸ PRåŒ…å«è¿‡å¤šæ–‡ä»¶å˜æ›´($CHANGED_FILES)ï¼Œå»ºè®®æ‹†åˆ†ä¸ºå¤šä¸ªå°çš„PR"
          exit 1
        fi

        if [ $CHANGED_FILES -gt 20 ]; then
          echo "âš ï¸ PRåŒ…å«è¾ƒå¤šæ–‡ä»¶å˜æ›´($CHANGED_FILES)ï¼Œè¯·ç¡®ä¿æ‰€æœ‰å˜æ›´éƒ½æ˜¯å¿…è¦çš„"
        fi

    - name: æ£€æŸ¥æ˜¯å¦æœ‰åˆå¹¶æäº¤
      run: |
        MERGE_COMMITS=$(git log --merges ${{ github.event.pull_request.base.sha }}..${{ github.sha }} | wc -l)
        if [ $MERGE_COMMITS -gt 0 ]; then
          echo "âŒ PRåŒ…å«åˆå¹¶æäº¤ï¼Œè¯·ä½¿ç”¨rebaseè€Œä¸æ˜¯merge"
          exit 1
        fi

    - name: æ£€æŸ¥åˆ†æ”¯å‘½å
      run: |
        BRANCH_NAME="${{ github.head_ref }}"
        echo "åˆ†æ”¯åç§°: $BRANCH_NAME"

        # æ£€æŸ¥åˆ†æ”¯å‘½åè§„èŒƒ
        if [[ ! $BRANCH_NAME =~ ^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|security|config|deps|release)/.+ ]]; then
          echo "âŒ åˆ†æ”¯å‘½åä¸ç¬¦åˆè§„èŒƒï¼Œåº”ä½¿ç”¨: type/description æ ¼å¼"
          echo "ä¾‹å¦‚: feat/user-authentication, fix/login-bug"
          exit 1
        fi

  # ä»£ç è´¨é‡æ£€æŸ¥ï¼ˆå¼•ç”¨ä¸»å·¥ä½œæµï¼‰
  code-quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    needs: pr-checks
    uses: ./.github/workflows/code-quality.yml

  # éƒ¨ç½²é¢„è§ˆï¼ˆå¦‚æœé€‚ç”¨ï¼‰
  deploy-preview:
    name: éƒ¨ç½²é¢„è§ˆ
    needs: [pr-checks, code-quality]
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: æ„å»ºå‰ç«¯
      run: |
        cd frontend
        npm ci
        npm run build

    - name: éƒ¨ç½²åˆ°é¢„è§ˆç¯å¢ƒ
      run: |
        echo "ğŸš€ éƒ¨ç½²åˆ°é¢„è§ˆç¯å¢ƒ..."
        echo "é¢„è§ˆURL: https://pr-${{ github.event.number }}.zhitoujianli.com"
        # è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„éƒ¨ç½²é€»è¾‘
