# ============================================================
# SSHè¿æ¥æµ‹è¯•å·¥ä½œæµ
# ç”¨äºéªŒè¯GitHub Secretsé…ç½®æ˜¯å¦æ­£ç¡®
# ============================================================

name: Test SSH Connection

on:
  workflow_dispatch:
    inputs:
      test_mode:
        description: "æµ‹è¯•æ¨¡å¼"
        required: false
        default: "true"
        type: boolean

jobs:
  test-ssh:
    name: æµ‹è¯•SSHè¿æ¥
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Test SSH Connection
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            echo "============================================================"
            echo "SSHè¿æ¥æµ‹è¯•å¼€å§‹..."
            echo "æ—¶é—´: $(date)"
            echo "============================================================"
            
            # åŸºæœ¬ç³»ç»Ÿä¿¡æ¯
            echo "ç³»ç»Ÿä¿¡æ¯ï¼š"
            echo "ç”¨æˆ·: $(whoami)"
            echo "ç›®å½•: $(pwd)"
            echo "ä¸»æœºå: $(hostname)"
            echo "æ“ä½œç³»ç»Ÿ: $(uname -a)"
            echo ""
            
            # æ£€æŸ¥éƒ¨ç½²ç›®å½•
            echo "æ£€æŸ¥éƒ¨ç½²ç›®å½•..."
            if [ -d "/var/www/zhitoujianli" ]; then
                echo "âœ… éƒ¨ç½²ç›®å½•å­˜åœ¨: /var/www/zhitoujianli"
                echo "ç›®å½•å†…å®¹:"
                ls -la /var/www/zhitoujianli/
            else
                echo "âŒ éƒ¨ç½²ç›®å½•ä¸å­˜åœ¨: /var/www/zhitoujianli"
                echo "åˆ›å»ºéƒ¨ç½²ç›®å½•..."
                sudo mkdir -p /var/www/zhitoujianli
                sudo chown $USER:$USER /var/www/zhitoujianli
            fi
            echo ""
            
            # æ£€æŸ¥Nginxé…ç½®ç›®å½•
            echo "æ£€æŸ¥Nginxé…ç½®ç›®å½•..."
            if [ -d "/etc/nginx/conf.d" ]; then
                echo "âœ… Nginxé…ç½®ç›®å½•å­˜åœ¨: /etc/nginx/conf.d"
                echo "é…ç½®æ–‡ä»¶åˆ—è¡¨:"
                ls -la /etc/nginx/conf.d/
            else
                echo "âŒ Nginxé…ç½®ç›®å½•ä¸å­˜åœ¨: /etc/nginx/conf.d"
            fi
            echo ""
            
            # æ£€æŸ¥NginxæœåŠ¡çŠ¶æ€
            echo "æ£€æŸ¥NginxæœåŠ¡çŠ¶æ€..."
            if systemctl is-active --quiet nginx; then
                echo "âœ… NginxæœåŠ¡æ­£åœ¨è¿è¡Œ"
                echo "NginxçŠ¶æ€:"
                systemctl status nginx --no-pager -l
            else
                echo "âŒ NginxæœåŠ¡æœªè¿è¡Œ"
                echo "å°è¯•å¯åŠ¨Nginx..."
                sudo systemctl start nginx
                if systemctl is-active --quiet nginx; then
                    echo "âœ… NginxæœåŠ¡å¯åŠ¨æˆåŠŸ"
                else
                    echo "âŒ NginxæœåŠ¡å¯åŠ¨å¤±è´¥"
                fi
            fi
            echo ""
            
            # æ£€æŸ¥ç£ç›˜ç©ºé—´
            echo "æ£€æŸ¥ç£ç›˜ç©ºé—´..."
            df -h
            echo ""
            
            # æ£€æŸ¥å†…å­˜ä½¿ç”¨
            echo "æ£€æŸ¥å†…å­˜ä½¿ç”¨..."
            free -h
            echo ""
            
            # æ£€æŸ¥ç½‘ç»œè¿æ¥
            echo "æ£€æŸ¥ç½‘ç»œè¿æ¥..."
            ping -c 3 8.8.8.8
            echo ""
            
            echo "============================================================"
            echo "SSHè¿æ¥æµ‹è¯•å®Œæˆï¼"
            echo "æ—¶é—´: $(date)"
            echo "============================================================"

      - name: Test File Upload
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_KEY }}
          source: "README.md"
          target: "/tmp/test_upload/"
          strip_components: 0

      - name: Verify File Upload
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            echo "éªŒè¯æ–‡ä»¶ä¸Šä¼ ..."
            if [ -f "/tmp/test_upload/README.md" ]; then
                echo "âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸ"
                echo "æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
                head -10 /tmp/test_upload/README.md
                echo ""
                echo "æ¸…ç†æµ‹è¯•æ–‡ä»¶..."
                rm -rf /tmp/test_upload/
            else
                echo "âŒ æ–‡ä»¶ä¸Šä¼ å¤±è´¥"
            fi

      - name: Test Summary
        run: |
          echo "ğŸ‰ SSHè¿æ¥æµ‹è¯•å®Œæˆï¼"
          echo "å¦‚æœæ‰€æœ‰æ­¥éª¤éƒ½æˆåŠŸï¼Œè¯´æ˜GitHub Secretsé…ç½®æ­£ç¡®"
          echo "å¯ä»¥ç»§ç»­ä½¿ç”¨GitHub Actionsè¿›è¡Œéƒ¨ç½²"
