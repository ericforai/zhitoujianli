# ============================================================
# æ™ºæŠ•ç®€å† - ä¿®å¤ç‰ˆéƒ¨ç½²å·¥ä½œæµ
# ç®€åŒ–ç‰ˆæœ¬ï¼Œä¸“æ³¨äºè§£å†³SSHè¿æ¥é—®é¢˜
# ============================================================

name: Fixed Deploy to Production

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-and-deploy:
    name: æ„å»ºå¹¶éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
    runs-on: ubuntu-latest

    steps:
      # ============================================================
      # 1. æ£€å‡ºä»£ç 
      # ============================================================
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # ============================================================
      # 2. è®¾ç½®Node.jsç¯å¢ƒ
      # ============================================================
      - name: ğŸ”§ è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      # ============================================================
      # 3. å®‰è£…ä¾èµ–
      # ============================================================
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          echo "å®‰è£…å‰ç«¯ä¾èµ–..."
          npm ci
          echo "ä¾èµ–å®‰è£…å®Œæˆ"

      # ============================================================
      # 4. ä»£ç è´¨é‡æ£€æŸ¥ï¼ˆå¯é€‰ï¼‰
      # ============================================================
      - name: ğŸ” ä»£ç è´¨é‡æ£€æŸ¥
        run: |
          echo "è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥..."
          npm run lint || echo "âš ï¸ Lint æ£€æŸ¥æœ‰è­¦å‘Šï¼Œç»§ç»­éƒ¨ç½²"
          npm run type-check || echo "âš ï¸ ç±»å‹æ£€æŸ¥æœ‰è­¦å‘Šï¼Œç»§ç»­éƒ¨ç½²"

      # ============================================================
      # 5. æ„å»ºå‰ç«¯é¡¹ç›®
      # ============================================================
      - name: ğŸ”¨ æ„å»ºå‰ç«¯
        env:
          VITE_API_BASE_URL: https://zhitoujianli.com
          NODE_ENV: production
        run: |
          echo "å¼€å§‹æ„å»ºå‰ç«¯..."
          npm run build
          echo "å‰ç«¯æ„å»ºå®Œæˆ"
          echo "æ„å»ºæ–‡ä»¶åˆ—è¡¨ï¼š"
          ls -lah build/
          echo "æ„å»ºæ–‡ä»¶æ•°é‡: $(find build -type f | wc -l)"

      # ============================================================
      # 6. æµ‹è¯•SSHè¿æ¥
      # ============================================================
      - name: ğŸ”Œ æµ‹è¯•SSHè¿æ¥
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            echo "SSHè¿æ¥æµ‹è¯•æˆåŠŸï¼"
            echo "å½“å‰ç”¨æˆ·: $(whoami)"
            echo "å½“å‰ç›®å½•: $(pwd)"
            echo "æœåŠ¡å™¨æ—¶é—´: $(date)"
            echo "ç£ç›˜ç©ºé—´:"
            df -h

      # ============================================================
      # 7. ä¸Šä¼ å‰ç«¯æ–‡ä»¶
      # ============================================================
      - name: ğŸš€ ä¸Šä¼ å‰ç«¯æ–‡ä»¶
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_KEY }}
          source: "build/"
          target: "/tmp/frontend_build/"
          strip_components: 0

      # ============================================================
      # 8. ä¸Šä¼ Nginxé…ç½®
      # ============================================================
      - name: ğŸ“¤ ä¸Šä¼ Nginxé…ç½®
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_KEY }}
          source: "deploy/nginx/zhitoujianli.conf"
          target: "/tmp/"

      # ============================================================
      # 9. æ‰§è¡Œéƒ¨ç½²
      # ============================================================
      - name: ğŸ¯ æ‰§è¡Œéƒ¨ç½²
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e
            
            echo "============================================================"
            echo "å¼€å§‹éƒ¨ç½²æµç¨‹..."
            echo "éƒ¨ç½²æ—¶é—´: $(date)"
            echo "============================================================"
            
            # å®šä¹‰å˜é‡
            REMOTE_DIR="${{ secrets.REMOTE_DEPLOY_DIR }}"
            NGINX_CONF="${{ secrets.REMOTE_NGINX_CONF }}"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            
            echo "éƒ¨ç½²ç›®å½•: $REMOTE_DIR"
            echo "Nginxé…ç½®: $NGINX_CONF"
            
            # åˆ›å»ºå¿…è¦ç›®å½•
            echo "åˆ›å»ºå¿…è¦ç›®å½•..."
            sudo mkdir -p "$REMOTE_DIR/releases"
            sudo mkdir -p "$(dirname "$NGINX_CONF")"
            
            # éƒ¨ç½²å‰ç«¯æ–‡ä»¶
            echo "éƒ¨ç½²å‰ç«¯æ–‡ä»¶..."
            sudo rm -rf "$REMOTE_DIR/releases/dist_$TIMESTAMP"
            sudo mv /tmp/frontend_build "$REMOTE_DIR/releases/dist_$TIMESTAMP"
            
            # æ›´æ–°è½¯é“¾æ¥
            echo "æ›´æ–°è½¯é“¾æ¥..."
            sudo rm -rf "$REMOTE_DIR/dist"
            sudo ln -s "$REMOTE_DIR/releases/dist_$TIMESTAMP" "$REMOTE_DIR/dist"
            
            # æ›´æ–°Nginxé…ç½®
            echo "æ›´æ–°Nginxé…ç½®..."
            sudo cp /tmp/zhitoujianli.conf "$NGINX_CONF"
            sudo chown root:root "$NGINX_CONF"
            sudo chmod 644 "$NGINX_CONF"
            
            # æµ‹è¯•Nginxé…ç½®
            echo "æµ‹è¯•Nginxé…ç½®..."
            sudo nginx -t
            
            # é‡è½½Nginx
            echo "é‡è½½Nginx..."
            sudo systemctl reload nginx
            
            # å¥åº·æ£€æŸ¥
            echo "å¥åº·æ£€æŸ¥..."
            sleep 5
            curl -fsSIL https://www.zhitoujianli.com/register
            
            # æ¸…ç†æ—§ç‰ˆæœ¬
            echo "æ¸…ç†æ—§ç‰ˆæœ¬..."
            cd "$REMOTE_DIR/releases"
            ls -1dt dist_* | tail -n +4 | xargs -r sudo rm -rf
            
            echo "============================================================"
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
            echo "éƒ¨ç½²æ—¶é—´: $(date)"
            echo "============================================================"

      # ============================================================
      # 10. éƒ¨ç½²å®Œæˆé€šçŸ¥
      # ============================================================
      - name: âœ… éƒ¨ç½²å®Œæˆ
        run: |
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸå®Œæˆï¼"
          echo "è¯·è®¿é—®: https://www.zhitoujianli.com/register"
